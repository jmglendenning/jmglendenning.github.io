<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.40">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="John Glendenning">
<meta name="dcterms.date" content="2025-12-19">

<title>Roman Coin Circulation Model – John Glendenning</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-549806ee2085284f45b00abea8c6df48.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-139cbef34d804e98ad06db27d9e59963.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<meta name="robots" content="noindex, nofollow">

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="styles.css">
</head>

<body class="floating nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="./index.html">
    <span class="navbar-title">John Glendenning</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-coins" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Coins</span>
    </a>
    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="nav-menu-coins">    
        <li>
    <a class="dropdown-item" href="./master_proposal.html">
 <span class="dropdown-text">Proposal</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./circulation_age.html">
 <span class="dropdown-text">Circulation Age</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./circulation_model.html">
 <span class="dropdown-text">Circulation Model</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./directional_flow.html">
 <span class="dropdown-text">Directional Flow</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./hmm_analysis.html">
 <span class="dropdown-text">HMM Analysis</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./lrr_compositional.html">
 <span class="dropdown-text">LRR Compositional</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./lrr_mint_date.html">
 <span class="dropdown-text">LRR Mint Date</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./lrr_temporal.html">
 <span class="dropdown-text">LRR Temporal</span></a>
  </li>  
    </ul>
  </li>
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#model-overview" id="toc-model-overview" class="nav-link active" data-scroll-target="#model-overview"><span class="header-section-number">1</span> Model Overview</a>
  <ul>
  <li><a href="#objective" id="toc-objective" class="nav-link" data-scroll-target="#objective"><span class="header-section-number">1.1</span> Objective</a></li>
  <li><a href="#model-structure" id="toc-model-structure" class="nav-link" data-scroll-target="#model-structure"><span class="header-section-number">1.2</span> Model Structure</a></li>
  <li><a href="#hierarchical-diffusion-model" id="toc-hierarchical-diffusion-model" class="nav-link" data-scroll-target="#hierarchical-diffusion-model"><span class="header-section-number">1.3</span> Hierarchical Diffusion Model</a></li>
  </ul></li>
  <li><a href="#setup" id="toc-setup" class="nav-link" data-scroll-target="#setup"><span class="header-section-number">2</span> Setup</a></li>
  <li><a href="#chunk-1-data-preparation" id="toc-chunk-1-data-preparation" class="nav-link" data-scroll-target="#chunk-1-data-preparation"><span class="header-section-number">3</span> CHUNK 1: Data Preparation</a>
  <ul>
  <li><a href="#load-chrr-data" id="toc-load-chrr-data" class="nav-link" data-scroll-target="#load-chrr-data"><span class="header-section-number">3.1</span> 1.1 Load CHRR Data</a></li>
  <li><a href="#extract-unique-mint-uris" id="toc-extract-unique-mint-uris" class="nav-link" data-scroll-target="#extract-unique-mint-uris"><span class="header-section-number">3.2</span> 1.2 Extract Unique Mint URIs</a></li>
  <li><a href="#load-mint-coordinates-from-geojson" id="toc-load-mint-coordinates-from-geojson" class="nav-link" data-scroll-target="#load-mint-coordinates-from-geojson"><span class="header-section-number">3.3</span> 1.3 Load Mint Coordinates from GeoJSON</a></li>
  <li><a href="#manual-coordinate-additions" id="toc-manual-coordinate-additions" class="nav-link" data-scroll-target="#manual-coordinate-additions"><span class="header-section-number">3.4</span> 1.4 Manual Coordinate Additions</a></li>
  <li><a href="#classify-mints-into-regions" id="toc-classify-mints-into-regions" class="nav-link" data-scroll-target="#classify-mints-into-regions"><span class="header-section-number">3.5</span> 1.5 Classify Mints into Regions</a></li>
  <li><a href="#define-production-periods-25-year-bins" id="toc-define-production-periods-25-year-bins" class="nav-link" data-scroll-target="#define-production-periods-25-year-bins"><span class="header-section-number">3.6</span> 1.6 Define Production Periods (25-year bins)</a></li>
  <li><a href="#build-analysis-dataset" id="toc-build-analysis-dataset" class="nav-link" data-scroll-target="#build-analysis-dataset"><span class="header-section-number">3.7</span> 1.7 Build Analysis Dataset</a></li>
  <li><a href="#aggregate-to-hoard-mint-level" id="toc-aggregate-to-hoard-mint-level" class="nav-link" data-scroll-target="#aggregate-to-hoard-mint-level"><span class="header-section-number">3.8</span> 1.8 Aggregate to Hoard-Mint Level</a></li>
  </ul></li>
  <li><a href="#chunk-2-exploratory-analysis" id="toc-chunk-2-exploratory-analysis" class="nav-link" data-scroll-target="#chunk-2-exploratory-analysis"><span class="header-section-number">4</span> CHUNK 2: Exploratory Analysis</a>
  <ul>
  <li><a href="#map-mint-locations-by-region" id="toc-map-mint-locations-by-region" class="nav-link" data-scroll-target="#map-mint-locations-by-region"><span class="header-section-number">4.1</span> 2.1 Map Mint Locations by Region</a></li>
  <li><a href="#production-volume-by-region-and-period" id="toc-production-volume-by-region-and-period" class="nav-link" data-scroll-target="#production-volume-by-region-and-period"><span class="header-section-number">4.2</span> 2.2 Production Volume by Region and Period</a></li>
  <li><a href="#distance-distributions-by-mint-region" id="toc-distance-distributions-by-mint-region" class="nav-link" data-scroll-target="#distance-distributions-by-mint-region"><span class="header-section-number">4.3</span> 2.3 Distance Distributions by Mint Region</a></li>
  <li><a href="#distance-vs-proportion-by-mint-region" id="toc-distance-vs-proportion-by-mint-region" class="nav-link" data-scroll-target="#distance-vs-proportion-by-mint-region"><span class="header-section-number">4.4</span> 2.4 Distance vs Proportion by Mint Region</a></li>
  </ul></li>
  <li><a href="#chunk-3-diffusion-model-fitting" id="toc-chunk-3-diffusion-model-fitting" class="nav-link" data-scroll-target="#chunk-3-diffusion-model-fitting"><span class="header-section-number">5</span> CHUNK 3: Diffusion Model Fitting</a>
  <ul>
  <li><a href="#prepare-modeling-data" id="toc-prepare-modeling-data" class="nav-link" data-scroll-target="#prepare-modeling-data"><span class="header-section-number">5.1</span> 3.1 Prepare Modeling Data</a></li>
  <li><a href="#independent-models-by-mint-region" id="toc-independent-models-by-mint-region" class="nav-link" data-scroll-target="#independent-models-by-mint-region"><span class="header-section-number">5.2</span> 3.2 Independent Models by Mint Region</a></li>
  <li><a href="#visualize-independent-model-fits" id="toc-visualize-independent-model-fits" class="nav-link" data-scroll-target="#visualize-independent-model-fits"><span class="header-section-number">5.3</span> 3.3 Visualize Independent Model Fits</a></li>
  <li><a href="#hierarchical-model-partial-pooling" id="toc-hierarchical-model-partial-pooling" class="nav-link" data-scroll-target="#hierarchical-model-partial-pooling"><span class="header-section-number">5.4</span> 3.4 Hierarchical Model (Partial Pooling)</a></li>
  <li><a href="#extract-hierarchical-coefficients" id="toc-extract-hierarchical-coefficients" class="nav-link" data-scroll-target="#extract-hierarchical-coefficients"><span class="header-section-number">5.5</span> 3.5 Extract Hierarchical Coefficients</a></li>
  <li><a href="#compare-independent-vs-hierarchical-estimates" id="toc-compare-independent-vs-hierarchical-estimates" class="nav-link" data-scroll-target="#compare-independent-vs-hierarchical-estimates"><span class="header-section-number">5.6</span> 3.6 Compare Independent vs Hierarchical Estimates</a></li>
  <li><a href="#add-circulation-age-effect" id="toc-add-circulation-age-effect" class="nav-link" data-scroll-target="#add-circulation-age-effect"><span class="header-section-number">5.7</span> 3.7 Add Circulation Age Effect</a></li>
  </ul></li>
  <li><a href="#chunk-4-probability-surface-generation" id="toc-chunk-4-probability-surface-generation" class="nav-link" data-scroll-target="#chunk-4-probability-surface-generation"><span class="header-section-number">6</span> CHUNK 4: Probability Surface Generation</a>
  <ul>
  <li><a href="#create-prediction-grid" id="toc-create-prediction-grid" class="nav-link" data-scroll-target="#create-prediction-grid"><span class="header-section-number">6.1</span> 4.1 Create Prediction Grid</a></li>
  <li><a href="#compute-distances-from-each-mint-region" id="toc-compute-distances-from-each-mint-region" class="nav-link" data-scroll-target="#compute-distances-from-each-mint-region"><span class="header-section-number">6.2</span> 4.2 Compute Distances from Each Mint Region</a></li>
  <li><a href="#generate-probability-surface-for-each-mint-region" id="toc-generate-probability-surface-for-each-mint-region" class="nav-link" data-scroll-target="#generate-probability-surface-for-each-mint-region"><span class="header-section-number">6.3</span> 4.3 Generate Probability Surface for Each Mint Region</a></li>
  <li><a href="#create-multi-layer-spatial-object" id="toc-create-multi-layer-spatial-object" class="nav-link" data-scroll-target="#create-multi-layer-spatial-object"><span class="header-section-number">6.4</span> 4.4 Create Multi-Layer Spatial Object</a></li>
  </ul></li>
  <li><a href="#chunk-5-visualization" id="toc-chunk-5-visualization" class="nav-link" data-scroll-target="#chunk-5-visualization"><span class="header-section-number">7</span> CHUNK 5: Visualization</a>
  <ul>
  <li><a href="#rome-proportion-surface" id="toc-rome-proportion-surface" class="nav-link" data-scroll-target="#rome-proportion-surface"><span class="header-section-number">7.1</span> 5.1 Rome Proportion Surface</a></li>
  <li><a href="#dominant-mint-map" id="toc-dominant-mint-map" class="nav-link" data-scroll-target="#dominant-mint-map"><span class="header-section-number">7.2</span> 5.2 Dominant Mint Map</a></li>
  <li><a href="#compositional-entropy-map" id="toc-compositional-entropy-map" class="nav-link" data-scroll-target="#compositional-entropy-map"><span class="header-section-number">7.3</span> 5.3 Compositional Entropy Map</a></li>
  <li><a href="#individual-mint-surfaces" id="toc-individual-mint-surfaces" class="nav-link" data-scroll-target="#individual-mint-surfaces"><span class="header-section-number">7.4</span> 5.4 Individual Mint Surfaces</a></li>
  <li><a href="#mint-catchment-areas" id="toc-mint-catchment-areas" class="nav-link" data-scroll-target="#mint-catchment-areas"><span class="header-section-number">7.5</span> 5.5 Mint Catchment Areas</a></li>
  </ul></li>
  <li><a href="#chunk-6-validation-interpretation" id="toc-chunk-6-validation-interpretation" class="nav-link" data-scroll-target="#chunk-6-validation-interpretation"><span class="header-section-number">8</span> CHUNK 6: Validation &amp; Interpretation</a>
  <ul>
  <li><a href="#cross-validation" id="toc-cross-validation" class="nav-link" data-scroll-target="#cross-validation"><span class="header-section-number">8.1</span> 6.1 Cross-Validation</a></li>
  <li><a href="#observed-vs-predicted-plot" id="toc-observed-vs-predicted-plot" class="nav-link" data-scroll-target="#observed-vs-predicted-plot"><span class="header-section-number">8.2</span> 6.2 Observed vs Predicted Plot</a></li>
  <li><a href="#residual-mapping" id="toc-residual-mapping" class="nav-link" data-scroll-target="#residual-mapping"><span class="header-section-number">8.3</span> 6.3 Residual Mapping</a></li>
  <li><a href="#identify-anomalous-hoards" id="toc-identify-anomalous-hoards" class="nav-link" data-scroll-target="#identify-anomalous-hoards"><span class="header-section-number">8.4</span> 6.4 Identify Anomalous Hoards</a></li>
  <li><a href="#comparison-with-hmm-regimes" id="toc-comparison-with-hmm-regimes" class="nav-link" data-scroll-target="#comparison-with-hmm-regimes"><span class="header-section-number">8.5</span> 6.5 Comparison with HMM Regimes</a></li>
  </ul></li>
  <li><a href="#summary" id="toc-summary" class="nav-link" data-scroll-target="#summary"><span class="header-section-number">9</span> Summary</a>
  <ul>
  <li><a href="#key-findings" id="toc-key-findings" class="nav-link" data-scroll-target="#key-findings"><span class="header-section-number">9.1</span> Key Findings</a></li>
  </ul></li>
  <li><a href="#export" id="toc-export" class="nav-link" data-scroll-target="#export"><span class="header-section-number">10</span> Export</a></li>
  <li><a href="#session-info" id="toc-session-info" class="nav-link" data-scroll-target="#session-info"><span class="header-section-number">11</span> Session Info</a></li>
  <li><a href="#appendix-model-extensions" id="toc-appendix-model-extensions" class="nav-link" data-scroll-target="#appendix-model-extensions"><span class="header-section-number">12</span> Appendix: Model Extensions</a>
  <ul>
  <li><a href="#a.1-adding-circulation-decay" id="toc-a.1-adding-circulation-decay" class="nav-link" data-scroll-target="#a.1-adding-circulation-decay"><span class="header-section-number">12.1</span> A.1 Adding Circulation Decay</a></li>
  <li><a href="#a.2-time-varying-probability-surfaces" id="toc-a.2-time-varying-probability-surfaces" class="nav-link" data-scroll-target="#a.2-time-varying-probability-surfaces"><span class="header-section-number">12.2</span> A.2 Time-Varying Probability Surfaces</a></li>
  <li><a href="#a.3-bayesian-implementation-with-brms" id="toc-a.3-bayesian-implementation-with-brms" class="nav-link" data-scroll-target="#a.3-bayesian-implementation-with-brms"><span class="header-section-number">12.3</span> A.3 Bayesian Implementation with brms</a></li>
  </ul></li>
  </ul>
</nav>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar zindex-bottom">
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Roman Coin Circulation Model</h1>
<p class="subtitle lead">Hierarchical Spatio-Temporal Diffusion from Mint to Hoard</p>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>John Glendenning </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">December 19, 2025</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<section id="model-overview" class="level1" data-number="1">
<h1 data-number="1"><span class="header-section-number">1</span> Model Overview</h1>
<section id="objective" class="level2" data-number="1.1">
<h2 data-number="1.1" class="anchored" data-anchor-id="objective"><span class="header-section-number">1.1</span> Objective</h2>
<p>Create probability surfaces showing expected hoard composition at any location and time, based on:</p>
<ol type="1">
<li><strong>Production</strong>: Which mints produced how many coins, when</li>
<li><strong>Diffusion</strong>: How coins spread spatially from their mint of origin</li>
<li><strong>Accumulation</strong>: How hoards aggregate coins from multiple sources over time</li>
</ol>
</section>
<section id="model-structure" class="level2" data-number="1.2">
<h2 data-number="1.2" class="anchored" data-anchor-id="model-structure"><span class="header-section-number">1.2</span> Model Structure</h2>
<p><span class="math display">\[E[\text{prop. from mint } m \text{ at } (h,t)] = \frac{\sum_{\tau &lt; t} M_{m,\tau} \cdot P(h|m,\tau,t) \cdot w(t-\tau)}{\sum_{m'}\sum_{\tau &lt; t} M_{m',\tau} \cdot P(h|m',\tau,t) \cdot w(t-\tau)}\]</span></p>
<p>Where:</p>
<ul>
<li><span class="math inline">\(M_{m,\tau}\)</span> = production from mint <span class="math inline">\(m\)</span> in period <span class="math inline">\(\tau\)</span></li>
<li><span class="math inline">\(P(h|m,\tau,t)\)</span> = probability coin reaches hex <span class="math inline">\(h\)</span> from mint <span class="math inline">\(m\)</span></li>
<li><span class="math inline">\(w(t-\tau)\)</span> = circulation weight (optional decay)</li>
</ul>
</section>
<section id="hierarchical-diffusion-model" class="level2" data-number="1.3">
<h2 data-number="1.3" class="anchored" data-anchor-id="hierarchical-diffusion-model"><span class="header-section-number">1.3</span> Hierarchical Diffusion Model</h2>
<p><span class="math display">\[\text{logit}(p_{mh}) = \alpha_m - \beta_m \cdot d_{mh} + \gamma_{m,1} \cdot \cos(\theta_{mh}) + \gamma_{m,2} \cdot \sin(\theta_{mh}) + \delta_m \cdot \text{age}\]</span></p>
<p>With partial pooling:</p>
<p><span class="math display">\[\beta_m \sim N(\mu_\beta, \sigma_\beta^2)\]</span></p>
<hr>
</section>
</section>
<section id="setup" class="level1" data-number="2">
<h1 data-number="2"><span class="header-section-number">2</span> Setup</h1>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(sf)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(httr)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(jsonlite)</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(knitr)</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(patchwork)</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(broom)</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="co"># For hierarchical models</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(lme4)</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Check if brms is available for full Bayesian</span></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>brms_available <span class="ot">&lt;-</span> <span class="fu">requireNamespace</span>(<span class="st">"brms"</span>, <span class="at">quietly =</span> <span class="cn">TRUE</span>)</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (brms_available) {</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">library</span>(brms)</span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"✓ brms available for Bayesian hierarchical models</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"ℹ brms not available; using lme4 for mixed effects</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>✓ brms available for Bayesian hierarchical models</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="fu">theme_set</span>(<span class="fu">theme_minimal</span>())</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Rome coordinates (reference point)</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>rome_lon <span class="ot">&lt;-</span> <span class="fl">12.4964</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>rome_lat <span class="ot">&lt;-</span> <span class="fl">41.9028</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<hr>
</section>
<section id="chunk-1-data-preparation" class="level1" data-number="3">
<h1 data-number="3"><span class="header-section-number">3</span> CHUNK 1: Data Preparation</h1>
<section id="load-chrr-data" class="level2" data-number="3.1">
<h2 data-number="3.1" class="anchored" data-anchor-id="load-chrr-data"><span class="header-section-number">3.1</span> 1.1 Load CHRR Data</h2>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>chrr_file <span class="ot">&lt;-</span> <span class="st">"/Users/john/Library/Mobile Documents/com~apple~CloudDocs/Home/John/GIS/Roman Italy GIS/Coin Project/data/chrr_data.csv"</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">file.exists</span>(chrr_file)) {</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>  alt_paths <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"/mnt/user-data/uploads/chrr_data.csv"</span>, <span class="st">"~/chrr_data.csv"</span>)</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (alt <span class="cf">in</span> alt_paths) {</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">file.exists</span>(alt)) {</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>      chrr_file <span class="ot">&lt;-</span> alt</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>      <span class="cf">break</span></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>chrr_raw <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(chrr_file, <span class="at">show_col_types =</span> <span class="cn">FALSE</span>)</span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"✓ Loaded"</span>, <span class="fu">nrow</span>(chrr_raw), <span class="st">"coin-type records</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>✓ Loaded 31951 coin-type records</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"  Unique hoards:"</span>, <span class="fu">n_distinct</span>(chrr_raw<span class="sc">$</span>hoard_id), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>  Unique hoards: 493 </code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"  Unique mints:"</span>, <span class="fu">n_distinct</span>(chrr_raw<span class="sc">$</span>mint_id), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>  Unique mints: 15 </code></pre>
</div>
</div>
</section>
<section id="extract-unique-mint-uris" class="level2" data-number="3.2">
<h2 data-number="3.2" class="anchored" data-anchor-id="extract-unique-mint-uris"><span class="header-section-number">3.2</span> 1.2 Extract Unique Mint URIs</h2>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Get unique mints with their URIs</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>mint_list <span class="ot">&lt;-</span> chrr_raw <span class="sc">%&gt;%</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(mint_uri), mint_uri <span class="sc">!=</span> <span class="st">""</span>) <span class="sc">%&gt;%</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(mint_id, mint_uri) <span class="sc">%&gt;%</span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">n_types =</span> <span class="fu">n</span>(),</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">n_hoards =</span> <span class="fu">n_distinct</span>(hoard_id),</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">.groups =</span> <span class="st">"drop"</span></span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(n_types))</span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Unique mints with URIs:"</span>, <span class="fu">nrow</span>(mint_list), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Unique mints with URIs: 14 </code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Top 20 mints by coin-type count:</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
Top 20 mints by coin-type count:</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="fu">kable</span>(<span class="fu">head</span>(mint_list, <span class="dv">20</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<table class="caption-top table table-sm table-striped small">
<colgroup>
<col style="width: 25%">
<col style="width: 53%">
<col style="width: 10%">
<col style="width: 11%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">mint_id</th>
<th style="text-align: left;">mint_uri</th>
<th style="text-align: right;">n_types</th>
<th style="text-align: right;">n_hoards</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">rome</td>
<td style="text-align: left;">http://nomisma.org/id/rome</td>
<td style="text-align: right;">28177</td>
<td style="text-align: right;">490</td>
</tr>
<tr class="even">
<td style="text-align: left;">uncertain_value</td>
<td style="text-align: left;">http://nomisma.org/id/uncertain_value</td>
<td style="text-align: right;">2263</td>
<td style="text-align: right;">343</td>
</tr>
<tr class="odd">
<td style="text-align: left;">narbo</td>
<td style="text-align: left;">http://nomisma.org/id/narbo</td>
<td style="text-align: right;">379</td>
<td style="text-align: right;">185</td>
</tr>
<tr class="even">
<td style="text-align: left;">italy_north_rrc</td>
<td style="text-align: left;">http://nomisma.org/id/italy_north_rrc</td>
<td style="text-align: right;">297</td>
<td style="text-align: right;">165</td>
</tr>
<tr class="odd">
<td style="text-align: left;">massalia</td>
<td style="text-align: left;">http://nomisma.org/id/massalia</td>
<td style="text-align: right;">55</td>
<td style="text-align: right;">50</td>
</tr>
<tr class="even">
<td style="text-align: left;">italy_southeast_rrc</td>
<td style="text-align: left;">http://nomisma.org/id/italy_southeast_rrc</td>
<td style="text-align: right;">53</td>
<td style="text-align: right;">35</td>
</tr>
<tr class="odd">
<td style="text-align: left;">sicily2_rrc</td>
<td style="text-align: left;">http://nomisma.org/id/sicily2_rrc</td>
<td style="text-align: right;">45</td>
<td style="text-align: right;">34</td>
</tr>
<tr class="even">
<td style="text-align: left;">apollonia_illyria</td>
<td style="text-align: left;">http://nomisma.org/id/apollonia_illyria</td>
<td style="text-align: right;">32</td>
<td style="text-align: right;">27</td>
</tr>
<tr class="odd">
<td style="text-align: left;">luceria</td>
<td style="text-align: left;">http://nomisma.org/id/luceria</td>
<td style="text-align: right;">25</td>
<td style="text-align: right;">13</td>
</tr>
<tr class="even">
<td style="text-align: left;">italy_central_rrc</td>
<td style="text-align: left;">http://nomisma.org/id/italy_central_rrc</td>
<td style="text-align: right;">24</td>
<td style="text-align: right;">21</td>
</tr>
<tr class="odd">
<td style="text-align: left;">sicily1_rrc</td>
<td style="text-align: left;">http://nomisma.org/id/sicily1_rrc</td>
<td style="text-align: right;">12</td>
<td style="text-align: right;">11</td>
</tr>
<tr class="even">
<td style="text-align: left;">osca</td>
<td style="text-align: left;">http://nomisma.org/id/osca</td>
<td style="text-align: right;">4</td>
<td style="text-align: right;">4</td>
</tr>
<tr class="odd">
<td style="text-align: left;">lugdunum</td>
<td style="text-align: left;">http://nomisma.org/id/lugdunum</td>
<td style="text-align: right;">3</td>
<td style="text-align: right;">3</td>
</tr>
<tr class="even">
<td style="text-align: left;">salpesa</td>
<td style="text-align: left;">http://nomisma.org/id/salpesa</td>
<td style="text-align: right;">3</td>
<td style="text-align: right;">2</td>
</tr>
</tbody>
</table>
</div>
</div>
</section>
<section id="load-mint-coordinates-from-geojson" class="level2" data-number="3.3">
<h2 data-number="3.3" class="anchored" data-anchor-id="load-mint-coordinates-from-geojson"><span class="header-section-number">3.3</span> 1.3 Load Mint Coordinates from GeoJSON</h2>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="co"># </span><span class="al">NOTE</span><span class="co">: Cache disabled to ensure manual coordinate updates work correctly</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a><span class="co"># If you want to re-enable caching, add: #| cache: true</span></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Load mint coordinates from your GeoJSON file</span></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a><span class="co"># This is more reliable than fetching from Nomisma API</span></span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>mints_geojson_path <span class="ot">&lt;-</span> <span class="st">"/Users/john/Library/Mobile Documents/com~apple~CloudDocs/Home/John/GIS/Roman Italy GIS/Coin Project/data/mints.geojson"</span></span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Try alternative paths if needed</span></span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">file.exists</span>(mints_geojson_path)) {</span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a>  alt_paths <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a>    <span class="st">"/mnt/user-data/uploads/mints.geojson"</span>,</span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a>    <span class="st">"~/mints.geojson"</span>,</span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a>    <span class="st">"mints.geojson"</span></span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb15-15"><a href="#cb15-15" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (p <span class="cf">in</span> alt_paths) {</span>
<span id="cb15-16"><a href="#cb15-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">file.exists</span>(p)) {</span>
<span id="cb15-17"><a href="#cb15-17" aria-hidden="true" tabindex="-1"></a>      mints_geojson_path <span class="ot">&lt;-</span> p</span>
<span id="cb15-18"><a href="#cb15-18" aria-hidden="true" tabindex="-1"></a>      <span class="cf">break</span></span>
<span id="cb15-19"><a href="#cb15-19" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb15-20"><a href="#cb15-20" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb15-21"><a href="#cb15-21" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb15-22"><a href="#cb15-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-23"><a href="#cb15-23" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">file.exists</span>(mints_geojson_path)) {</span>
<span id="cb15-24"><a href="#cb15-24" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Load GeoJSON</span></span>
<span id="cb15-25"><a href="#cb15-25" aria-hidden="true" tabindex="-1"></a>  mints_sf <span class="ot">&lt;-</span> <span class="fu">st_read</span>(mints_geojson_path, <span class="at">quiet =</span> <span class="cn">TRUE</span>)</span>
<span id="cb15-26"><a href="#cb15-26" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb15-27"><a href="#cb15-27" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Extract coordinates and mint_id from URI</span></span>
<span id="cb15-28"><a href="#cb15-28" aria-hidden="true" tabindex="-1"></a>  mints_from_geojson <span class="ot">&lt;-</span> mints_sf <span class="sc">%&gt;%</span></span>
<span id="cb15-29"><a href="#cb15-29" aria-hidden="true" tabindex="-1"></a>    <span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span></span>
<span id="cb15-30"><a href="#cb15-30" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb15-31"><a href="#cb15-31" aria-hidden="true" tabindex="-1"></a>      <span class="at">coords =</span> <span class="fu">st_coordinates</span>(mints_sf),</span>
<span id="cb15-32"><a href="#cb15-32" aria-hidden="true" tabindex="-1"></a>      <span class="at">mint_lon =</span> coords[, <span class="dv">1</span>],</span>
<span id="cb15-33"><a href="#cb15-33" aria-hidden="true" tabindex="-1"></a>      <span class="at">mint_lat =</span> coords[, <span class="dv">2</span>],</span>
<span id="cb15-34"><a href="#cb15-34" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Extract mint_id from URI (last part after /)</span></span>
<span id="cb15-35"><a href="#cb15-35" aria-hidden="true" tabindex="-1"></a>      <span class="at">mint_id_from_uri =</span> <span class="fu">str_extract</span>(uri, <span class="st">"[^/]+$"</span>)</span>
<span id="cb15-36"><a href="#cb15-36" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb15-37"><a href="#cb15-37" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">select</span>(name, mint_id_from_uri, mint_lat, mint_lon, uri) <span class="sc">%&gt;%</span></span>
<span id="cb15-38"><a href="#cb15-38" aria-hidden="true" tabindex="-1"></a>    <span class="fu">distinct</span>(mint_id_from_uri, <span class="at">.keep_all =</span> <span class="cn">TRUE</span>)</span>
<span id="cb15-39"><a href="#cb15-39" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb15-40"><a href="#cb15-40" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"✓ Loaded"</span>, <span class="fu">nrow</span>(mints_from_geojson), <span class="st">"mints from GeoJSON</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb15-41"><a href="#cb15-41" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(mints_from_geojson)</span>
<span id="cb15-42"><a href="#cb15-42" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb15-43"><a href="#cb15-43" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb15-44"><a href="#cb15-44" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"⚠ GeoJSON file not found, will use manual coordinates only</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb15-45"><a href="#cb15-45" aria-hidden="true" tabindex="-1"></a>  mints_from_geojson <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb15-46"><a href="#cb15-46" aria-hidden="true" tabindex="-1"></a>    <span class="at">name =</span> <span class="fu">character</span>(),</span>
<span id="cb15-47"><a href="#cb15-47" aria-hidden="true" tabindex="-1"></a>    <span class="at">mint_id_from_uri =</span> <span class="fu">character</span>(),</span>
<span id="cb15-48"><a href="#cb15-48" aria-hidden="true" tabindex="-1"></a>    <span class="at">mint_lat =</span> <span class="fu">numeric</span>(),</span>
<span id="cb15-49"><a href="#cb15-49" aria-hidden="true" tabindex="-1"></a>    <span class="at">mint_lon =</span> <span class="fu">numeric</span>(),</span>
<span id="cb15-50"><a href="#cb15-50" aria-hidden="true" tabindex="-1"></a>    <span class="at">uri =</span> <span class="fu">character</span>()</span>
<span id="cb15-51"><a href="#cb15-51" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb15-52"><a href="#cb15-52" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>✓ Loaded 465 mints from GeoJSON
                                   name        mint_id_from_uri mint_lat
1                           (H)aluntium                aluntium 38.07190
2                                Abdera           abdera_thrace 40.95000
3                                Abydus                  abydus 40.19602
4                              Acanthus                acanthus 40.39975
5                               Achaeum                 achaeum 39.81311
6                            Achilleion              achilleion 39.98975
7                                 Adada                   adada 37.59160
8                               Adranum                 adranum 37.66285
9                                 Aegae            aegae_achaea 38.15488
10                                Aegae            aegae_aeolis 38.82032
11                                Aegae         aegae_macedonia 40.48111
12                              Aegeira                 aegeira 38.13103
13                               Aegina           aegina_aegina 37.75000
14                               Aegium                  aegium 38.25271
15                                Aenai                   aenai 35.05842
16                               Aeneia                  aeneia 40.43948
17                             Aenianes                aenianes 38.87140
18                                Aenus                   aenus 40.72514
19                             Aesernia                aesernia 41.59435
20                           Agrigentum              agrigentum 37.31667
21                             Alabanda                alabanda 37.59779
22                    Alexandreia Troas       alexandreia_troas 39.76128
23                           Alexandria       alexandreia_egypt 31.20144
24                              Allifae                 allifae 41.32849
25                            Alyz(e)ia                  alyzia 38.71337
26                            Amas(e)ia                  amasia 40.67867
27                             Amastris                amastris 41.74697
28                              Amathus                 amathus 34.71235
29                             Ambracia                ambracia 39.15488
30                            Ami(naea)                ami_naea 39.82300
31                               Amisus                  amisus 41.29272
32                              Amorium                 amorium 39.02645
33                           Amphaxitis              amphaxitis 40.62640
34                           Amphipolis              amphipolis 40.82360
35                           Anactorium              anactorium 38.91667
36                               Andros                  andros 37.83333
37                            Antandrus               antandrus 39.57850
38                           Antigoneia        antigoneia_syria 36.26335
39              Antiocheia ad Maeandrum antiocheia_ad_maeandrum 37.87340
40                              Antioch        antiocheia_syria 36.20000
41                    Apamea in Phrygia         apamea_phrygiae 38.07100
42                     Apameia in Syria           apameia_syria 35.42074
43                              Aphytis                 aphytis 40.09937
44                    Apollonia Pontica       apollonia_pontica 42.41716
45                            Apollonia       apollonia_illyria 40.71667
46                               Aptera                  aptera 35.46655
47                            Aquilonia               aquilonia 40.98786
48                              Aquinum                 aquinum 41.49221
49                               Aradus                  aradus 34.85840
50                              Arcadia           arcadia_crete 35.08033
51                  Argos Amphilochicum     argos_amphilochicum 38.93591
52                                Argos           argos_argolis 37.61667
53                             Ariassus                ariassus 37.15490
54                             Ariminum                ariminum 44.05000
55                                 Arpi                    arpi 41.47565
56                              Ascalon                 ascalon 31.66999
57                             Aspendus                aspendus 36.93820
58                                Assus                   assus 39.49162
59                               Athens                  athens 37.97472
60                                Atrax                   atrax 39.58982
61                             Attaleia                attaleia 36.89390
62                                 Axus                    axus 35.30805
63                              Babylon                 babylon 32.52291
64                               Bactra                  bactra 36.76781
65                                Barce                   barce 32.49450
66                               Beroea          beroea_macedon 40.51667
67                              Berytus                 berytus 33.89928
68                             Bishapur                bishapur 29.73556
69                           Brundisium              brundisium 40.63619
70                             Bruttium                 bruttii 39.25000
71                               Byblus                  byblus 34.11950
72                               Byllis                  byllis 40.55000
73                            Byzantium               byzantium 41.01224
74                              Cabeira                 cabeira 40.60998
75                               Cabyle                  cabyle 42.52815
76                            Calchedon               calchedon 40.98339
77                                Cales                   cales 41.19993
78                             Callatis                callatis 43.81715
79                              Calymna                 calymna 36.97830
80                             Camarina                camarina 36.87229
81                              Camirus                 camirus 36.33627
82                    Campano-Tarentine       campano-tarentine 40.54720
83                               Caphya                  caphya 37.76626
84                                Capua                   capua 41.08624
85                               Cardia                  cardia 40.54823
86                                Carmo                   carmo 37.47100
87                                Carne                   carne 34.93884
88                              Carrhae                 carrhae 36.86635
89                             Carthaea                carthaea 37.56026
90                             Carthage                carthage 36.84701
91                             Carystus                carystus 38.01654
92                              Cassope                 cassope 39.14053
93                              Castulo                 castulo 38.03791
94                               Catana                  catana 37.50296
95                             Caulonia                caulonia 38.44543
96                               Caunus                  caunus 36.82827
97                               Cebren                  cebren 39.74180
98                           Celenderis              celenderis 36.14249
99                           Centuripae              centuripae 37.62407
100                                Ceos               ceos_ceos 37.61667
101                          Cercinitis              cercinitis 45.20367
102                            Chabacta                chabacta 41.23600
103                             Chalcis                 chalcis 38.45714
104                     Charax Spasinou         charax_spasinou 30.89469
105                         Cherronesus             cherronesus 44.61163
106                         Chersonesus      chersonesus_cariae 36.77574
107                         Chersonesus       chersonesus_crete 35.31916
108                         Chersonesus      chersonesus_thrace 40.33333
109                               Chios                   chios 38.37477
110                              Cirrha                  cirrha 38.42894
111                              Citium                  citium 34.92960
112                                Cius                    cius 40.43247
113                          Clazomenae              clazomenae 38.37389
114                             Cleitor                 cleitor 37.89354
115                             Cleonae                 cleonae 37.82444
116                              Cnidus                  cnidus 36.69017
117                             Cnossus                 cnossus 35.29796
118                            Colophon                colophon 37.99350
119                              Comama                  comama 37.32130
120                              Comana                  comana 40.37731
121                         Compulteria             compulteria 41.25193
122                               Copia                   copia 39.75069
123                             Corcyra         corcyra_corcyra 39.60444
124                             Corduba                 corduba 37.88468
125                             Corinth                 corinth 37.93333
126                            Coroneia                coroneia 38.39120
127                              Corone                  corone 36.79281
128                             Coronta                 coronta 38.58809
129                                Cosa                    cosa 42.41092
130                             Cossura                 cossura 36.83333
131                                 Cos                     cos 36.89589
132                              Cremna                  cremna 37.50014
133                              Cromna                  cromna 41.84399
134                              Croton                  croton 39.08076
135                               Cumae                   cumae 40.84712
136                             Cydonia                 cydonia 35.51667
137                                Cyme             cyme_aeolis 38.76185
138                              Cyrene                  cyrene 32.82304
139                             Cyzicus                 cyzicus 40.38132
140                            Damascus                damascus 33.51300
141                           Damastium               damastium 41.08333
142                            Dardanus                dardanus 40.07973
143                               Delos                   delos 37.38948
144                              Delphi                  delphi 38.48411
145                           Demetrias         demetrias_syria 33.51161
146                            Derrones                derrones 41.25000
147                                 Dia                     dia 41.08750
148                              Dicaea          dicaea_macedon 40.46049
149                              Dicaea           dicaea_thrace 40.99287
150                        Dionysopolis     dionysopolis_thrace 43.42563
151                          Dioscurias              dioscurias 42.99330
152                                Dyme                    dyme 38.14462
153                         Dyrrhachium             dyrrhachium 41.31667
154                              Ebusus                  ebusus 38.90839
155                            Ecbatana                ecbatana 34.80650
156                             Echinus                 echinus 38.90827
157                                Eion                    eion 40.78841
158                               Elaea                   elaea 38.94164
159                                Elea                    elea 39.44425
160                             Eleusis                 eleusis 38.03333
161                          Eleutherna              eleutherna 35.32810
162                                Elis               elis_elis 37.89178
163                              Elyrus                  elyrus 35.28318
164                            Emporiae                emporiae 42.13211
165                                Enna                    enna 37.56765
166                          Ephesus II          ephesus_ii_pco 37.93972
167                             Ephesus                 ephesus 37.93972
168                           Epidaurus               epidaurus 37.63328
169                              Eresus                  eresus 39.16861
170                             Eretria                 eretria 38.38333
171                            Erythrae                erythrae 38.38194
172                                Eryx                    eryx 38.03652
173                              Etenna                  etenna 36.99312
174                        Euhesperides            euhesperides 32.10979
175                               Eurea                   eurea 39.80000
176                            Euthenai                euthenai 36.93597
177                               Gades                   gades 36.53333
178                            Gambrium                gambrium 39.09108
179                             Gargara                 gargara 39.53348
180                                Gaza                    gaza 31.51097
181                             Gaziura                 gaziura 40.40405
182                                Gela                    gela 37.06316
183                              Gergis                  gergis 39.89849
184                              Gerrha                  gerrha 25.94539
185                         Geto-Dacian             geto_dacian 43.85000
186                              Golgoi                   golgi 35.06565
187                              Gomphi                  gomphi 39.45333
188                           Gorgippia               gorgippia 44.89221
189                              Gortyn                 gortyna 35.06333
190                           Haliartus               haliartus 38.36667
191                       Halicarnassus           halicarnassus 37.03517
192                              Hatria                  hatria 42.58020
193                        Hecatompylos            hecatompylos 35.96168
194                   Heraclea Lucaniae       heraclea_lucaniae 40.21302
195                   Heracleia Pontica       heracleia_pontica 41.28472
196                 Heracleia Trachinia     heracleia_trachinia 38.79204
197                           Heracleia     heracleia_illyricum 43.16667
198                 Herakleia ad Latmum      heraclea_ad_latmum 37.50194
199                            Hermione                hermione 37.38522
200                  Hierapolis Bambyce      hierapolis_bambyce 36.52612
201                          Hierapytna              hierapytna 35.01003
202                              Himera                  himera 37.96667
203                              Hipana                  hipana 37.72210
204                           Hipponium               hipponium 38.67558
205                       Hispano-Punic           hispano-punic 36.82248
206                            Histiaea                histiaea 38.94660
207 Hyria Campania (Hyrietes, Hyrianoi)          hyria_campania 40.97300
208                             Ialysus                 ialysus 36.40028
209                               Iasos                   iasus 37.27815
210                              Ichnae                  ichnae 40.76401
211                             Icosium                 icosium 36.77180
212                             Idalium                 idalium 35.01997
213                               Idyma                   idyma 37.05944
214                              Ilerda                  ilerda 41.61412
215                               Ilium                   ilium 39.95750
216                              Imbros                  imbros 40.23306
217                                 Iol                     iol 36.60683
218                                 Ios                     ios 36.71667
219                              Isinda                  isinda 37.06750
220                                Issa                    issa 43.03333
221                               Issus                   issus 36.83833
222                             Istakhr                 istakhr 29.94045
223                              Istrus                  istrus 44.54750
224                              Itanus                  itanus 35.26779
225                           Jerusalem               jerusalem 31.77668
226                               Joppa                   joppa 32.05244
227                              Keraia                ceraitae 37.51017
228                                Kese                    kese 41.08942
229                          Lacedaemon              lacedaemon 37.07368
230                               Lamia                   lamia 38.90300
231                           Lampsacus               lampsacus 40.34669
232                    Laodicea ad Mare       laodiceia_ad_mare 35.51667
233                  Laodiceia ad Lycum      laodiceia_ad_lycum 37.85525
234                            Lapethus                lapethus 35.35059
235                             Larissa        larissa_thessaly 39.64167
236                                Laüs                    laus 39.76769
237                             Lebedus                 lebedus 38.07788
238                              Lemnos                  lemnos 39.91667
239                            Leontini                leontini 37.28548
240                                Lete                    lete 40.74493
241                              Leucas                  leucas 38.80734
242                              Lilaea                  lilaea 38.62885
243                              Lindus                  lindus 36.08333
244                              Lipara                  lipara 38.46742
245                              Lissus                  lissus 41.78257
246                               Lixus                     lix 35.19873
247                   Locri Epizephyrii       locri_epizephyrii 38.23642
248                             Luceria                 luceria 41.50923
249                              Lysias                  lysias 38.25000
250                          Lysimachia              lysimachia 40.54823
251                              Lyttus                  lyttus 35.21288
252             Macedonia, First Region    macedonia_1st_region 40.82360
253            Macedonia, Second Region    macedonia_2nd_region 40.62640
254               Magnesia ad Maeandrum   magnesia_ad_maeandrum 37.85309
255                Magnesia in Thessaly                magnesia 39.75000
256                              Mallus                  mallus 36.56315
257                           Mamertini               mamertini 38.18000
258                           Mantineia               mantineia 37.61662
259                            Marathus                marathus 34.82650
260                              Marium                  marium 35.03724
261                            Maroneia                maroneia 40.90637
262                            Massalia                massalia 43.29685
263                         Megalopolis             megalopolis 37.41058
264                              Megara                  megara 37.98508
265                               Melos                   melos 36.74386
266                             Memphis                 memphis 29.84467
267                            Menaenum                menaenum 37.26640
268                               Mende                   mende 39.97145
269                           Mesembria               mesembria 42.66042
270                               Mesma                   mesma 38.48733
271                             Messana                 messana 38.19225
272                             Messene                 messene 37.05000
273                          Metapontum              metapontum 40.38313
274                             Methana                 methana 37.58669
275                            Methymna                methymna 39.36667
276                          Metropolis    metropolis_acarnania 38.75000
277                          Metropolis     metropolis_thessaly 39.50000
278                             Miletus                 miletus 37.53023
279                                Moda                    moda 35.46000
280                             Molossi                 molossi 39.75000
281                          Mopsuestia              mopsuestia 36.95884
282                          Morgantina              morgantina 37.43108
283                               Motya                   motya 37.86634
284                              Mylasa                  mylasa 37.31667
285                              Myndus                  myndus 37.05636
286                          Myriandrus              myriandrus 36.56585
287                              Myrina           myrina_aeolis 38.84010
288                            Mytilene                mytilene 39.10481
289                             Nagidus                 nagidus 36.09627
290                             Natunia                 natunia 36.31100
291                               Naxos                   naxos 37.10387
292                               Naxos                   naxus 37.82532
293                            Neandria                neandria 39.71974
294                            Neapolis       neapolis_campania 40.84000
295                            Neapolis        neapolis_macedon 40.93361
296                               Nesos                   nesos 39.33668
297                             Nineveh                 nineveh 36.35944
298                             Nisibis                 nisibis 37.06667
299                             Nisyros                 nisyros 36.58787
300                                Nola                    nola 40.92587
301                             Nuceria                 nuceria 40.74313
302                           Nymphaeum               nymphaeum 45.23760
303                                Nysa                    nysa 37.88778
304                             Odessus                 odessus 43.21207
305                            Oeniadae                oeniadae 38.40665
306                               Oenoe                   oenoe 37.58333
307                                Oeta                    oeta 38.82861
308                               Olbia                   olbia 46.69190
309                            Olynthus                olynthus 40.29259
310                           Ophrynium               ophrynium 40.03585
311                          Orchomenus      orchomenus_boeotia 38.48333
312                              Oricus                  oricus 40.32762
313                               Orion                   orion 35.20070
314                            Orrescii                orrescii 41.61000
315                               Orthe                   orthe 39.70851
316                             Paestum                 paestum 40.42263
317                            Pandosia       pandosia_bruttium 40.24435
318                            Panormus                panormus 38.11667
319                        Panticapaeum            panticapaeum 45.33861
320                              Paphos                  paphus 34.75993
321                              Parium                  parium 40.42050
322                               Paros                   paros 37.08579
323                              Patrae                  patrae 38.25000
324                         Pednelissus             pednelissus 37.21375
325                             Pelinna                 pelinna 39.84650
326                               Pella           pella_macedon 40.76003
327                             Pellene                 pellene 38.04321
328                          Peparethus              peparethus 39.11667
329                            Pergamum                pergamum 39.11667
330                               Perge                   perge 36.96223
331                           Perinthus               perinthus 40.97101
332                          Peripolium              peripolium 41.32000
333                          Perrhaebia              perrhaebia 39.75000
334                             Petelia                 petelia 39.26606
335                             Phacium                 phacium 39.56700
336                            Phaestus                phaestus 35.05127
337                          Phalasarna              phalasarna 35.50094
338                           Phangoria              phanagoria 45.18900
339                              Pharae                  pharae 38.36551
340                              Pharos                  pharos 43.18429
341                           Pharsalus               pharsalus 39.28500
342                            Phaselis                phaselis 36.52281
343                             Pheneus                 pheneus 37.91945
344                            Philippi                philippi 41.01306
345             Philisto-Arabian issues        philisto-arabian 31.58322
346                           Phistelia               phistelia 41.11000
347                              Phlius                  phlius 37.83166
348                             Phocaea                 phocaea 38.67035
349                            Pimolisa                pimolisa 41.01324
350                             Plataea                 plataea 38.21556
351                         Polyrhenium             polyrhenium 35.46679
352                           Populonia               populonia 42.98944
353                           Poseidium               poseidium 35.50743
354                          Poseidonia              poseidonia 40.42263
355                            Potidaea                potidaea 40.19370
356                             Praesus                 praesus 35.14167
357                            Priansos                priansus 35.04589
358                              Priene                  priene 37.65972
359                           Propontis               propontis 41.04622
360                       Ptolemais-Ake           ace_ptolemais 32.92178
361                               Pyxus                   pyxus 40.08385
362                        Rash Melqart            rash_melqart 38.03825
363                             Rhaucus                 rhaucus 35.22814
364                             Rhegium                 rhegium 38.10928
365                               Rhoda                   rhoda 42.26667
366                              Rhodes                  rhodes 36.43333
367                                Rome                    rome 41.90000
368                            Saetabis                saetabis 38.98885
369                          Sagalassus              sagalassus 37.68010
370                            Saguntum                saguntum 39.68003
371                             Salamis          salamis_attica 37.93333
372                             Salamis          salamis_cyprus 35.17510
373                             Salapia                 salapia 41.40338
374                                Same                    same 38.25460
375                               Samos                   samos 37.68944
376                          Samothrace              samothrace 40.50256
377                              Sardis                  sardes 38.48831
378                             Scepsis                 scepsis 39.82554
379                              Scione                  scione 39.93906
380                              Scodra                  scodra 42.07428
381                              Scyros                  scyros 38.90298
382                             Segesta                 segesta 37.94143
383                    Seleuceia Pieria        seleuceia_pieria 36.12445
384             Seleuceia ad Calycadnum seleuceia_ad_calycadnum 36.38174
385                 Seleuceia ad Tigrim     seleuceia_ad_tigrim 33.13722
386                               Selge                   selge 37.22832
387                             Selinus          selinus_sicily 37.58284
388                                Serd                 serdaei 39.89393
389                            Seriphos                seriphos 37.15570
390                            Sermylia                 sermyle 40.29822
391                             Sesamus                 sesamus 41.74697
392                              Sestos                  sestus 40.22836
393                        Siculo-Punic            siculo_punic 37.15000
394                              Sicyon                  sicyon 37.98047
395                                Side                    side 36.77240
396                               Sidon                   sidon 33.56041
397                              Sigeum                  sigeum 39.99370
398                             Sillyum                 sillyum 36.99072
399                              Sinope                  sinope 42.02578
400                             Siphnos                 siphnos 36.98333
401                               Siris                   siris 40.14904
402                              Smyrna                  smyrna 38.42389
403                 Soli (Pompeiopolis)       soli-pompeiopolis 36.74266
404                                Soli             soli_cyprus 35.14040
405                            Stageira                stageira 40.59303
406                        Stratoniceia            stratoniceia 37.31383
407                             Stratus                 stratus 38.67285
408                          Stymphalus              stymphalus 37.87847
409                      Suessa Aurunca          suessa_aurunca 41.24191
410                                Susa                    susa 32.18922
411                             Sybaris                 sybaris 39.75069
412                             Sybrita                 sybrita 35.25874
413                             Synnada                 synnada 38.53333
414                            Syracuse                syracuse 37.08333
415                               Syros                   syros 37.45000
416                             Tanagra                 tanagra 38.31667
417                               Tanus                   tanus 35.44754
418                               Taras                   taras 40.45452
419                              Tarsus                  tarsus 36.91667
420                             Taulara                 taulara 40.26210
421                         Tauromenium             tauromenium 37.85247
422                              Taxila                  taxila 33.74569
423                    Teanum Sidicinum        teanum_sidicinum 41.25235
424                               Teate                   teate 42.35180
425                               Tegea                   tegea 37.45533
426                               Telos                   telos 36.46394
427                              Temesa                  temesa 39.03645
428                              Temnus                  temnus 38.67191
429                             Tenedos                 tenedos 39.83390
430                               Tenos                   tenos 37.53333
431                                Teos                    teos 38.19910
432                              Terina                  terina 38.94487
433                     Termessus Minor         termessus_minor 36.81315
434                           Termessus         termessus_major 36.98247
435                              Terone                  terone 39.97628
436                           Teucheira               teucheira 32.53540
437                              Thasos                  thasos 40.77763
438                              Thebae                  thebae 39.27955
439                              Thebes                  thebes 38.31924
440                               Thera                   thera 36.36337
441                  Thermae Himerenses      thermae_himerenses 37.98399
442                              Therma                  therma 40.58155
443                            Thespiae                thespiae 38.30356
444                        Thessalonica            thessalonica 40.63333
445                   Thraco Macedonian       thraco-macedonian 41.24064
446                             Thurium                 thurium 39.75069
447                           Thyateira                thyatira 38.89852
448                          Thyrrheium              thyrrheium 38.85492
449                              Tiryns                  tiryns 37.59672
450                                Tlos                    tlos 36.55389
451                               Tomis                   tomis 44.17322
452                             Tralles                 tralles 37.84440
453                            Trapezus                trapezus 41.00266
454                              Tricca                  tricca 39.56890
455                            Tripolis      tripolis_phoenicia 34.42900
456                             Tylisus                 tylisus 35.29507
457                               Tyras                   tyras 46.20095
458                                Tyre                    tyre 33.27371
459                          Uranopolis              uranopolis 40.36357
460                            Valentia                valentia 39.48333
461                               Velia                   velia 40.15944
462                           Vetulonia               vetulonia 42.85945
463                          Volaterrae              volaterrae 43.40143
464                              Zancle                  zancle 38.19225
465                                 Ziz                     ziz 38.11127
     mint_lon                                           uri
1   14.700314                http://nomisma.org/id/aluntium
2   24.983333           http://nomisma.org/id/abdera_thrace
3   26.406964                  http://nomisma.org/id/abydus
4   23.880112                http://nomisma.org/id/acanthus
5   26.164143                 http://nomisma.org/id/achaeum
6   26.188666              http://nomisma.org/id/achilleion
7   30.995100                   http://nomisma.org/id/adada
8   14.835642                 http://nomisma.org/id/adranum
9   22.314637            http://nomisma.org/id/aegae_achaea
10  27.174421            http://nomisma.org/id/aegae_aeolis
11  22.313611         http://nomisma.org/id/aegae_macedonia
12  22.377574                 http://nomisma.org/id/aegeira
13  23.433333           http://nomisma.org/id/aegina_aegina
14  22.081952                  http://nomisma.org/id/aegium
15  24.928581                   http://nomisma.org/id/aenai
16  22.879124                  http://nomisma.org/id/aeneia
17  22.252090                http://nomisma.org/id/aenianes
18  26.084782                   http://nomisma.org/id/aenus
19  14.230823                http://nomisma.org/id/aesernia
20  13.583333              http://nomisma.org/id/agrigentum
21  27.958833                http://nomisma.org/id/alabanda
22  26.152555       http://nomisma.org/id/alexandreia_troas
23  29.909773       http://nomisma.org/id/alexandreia_egypt
24  14.330592                 http://nomisma.org/id/allifae
25  20.951657                  http://nomisma.org/id/alyzia
26  35.827800                  http://nomisma.org/id/amasia
27  32.385648                http://nomisma.org/id/amastris
28  33.130332                 http://nomisma.org/id/amathus
29  20.990258                http://nomisma.org/id/ambracia
30  16.390000                http://nomisma.org/id/ami_naea
31  36.331300                  http://nomisma.org/id/amisus
32  31.266575                 http://nomisma.org/id/amorium
33  22.956201              http://nomisma.org/id/amphaxitis
34  23.846565              http://nomisma.org/id/amphipolis
35  20.883333              http://nomisma.org/id/anactorium
36  24.933333                  http://nomisma.org/id/andros
37  26.791496               http://nomisma.org/id/antandrus
38  36.230077        http://nomisma.org/id/antigoneia_syria
39  28.574200 http://nomisma.org/id/antiocheia_ad_maeandrum
40  36.150000        http://nomisma.org/id/antiocheia_syria
41  30.166000         http://nomisma.org/id/apamea_phrygiae
42  36.400237           http://nomisma.org/id/apameia_syria
43  23.436606                 http://nomisma.org/id/aphytis
44  27.696460       http://nomisma.org/id/apollonia_pontica
45  19.466667       http://nomisma.org/id/apollonia_illyria
46  24.149388                  http://nomisma.org/id/aptera
47  15.475346               http://nomisma.org/id/aquilonia
48  13.705626                 http://nomisma.org/id/aquinum
49  35.859448                  http://nomisma.org/id/aradus
50  25.282439           http://nomisma.org/id/arcadia_crete
51  21.180267     http://nomisma.org/id/argos_amphilochicum
52  22.716667           http://nomisma.org/id/argos_argolis
53  30.488500                http://nomisma.org/id/ariassus
54  12.566667                http://nomisma.org/id/ariminum
55  15.555444                    http://nomisma.org/id/arpi
56  34.545560                 http://nomisma.org/id/ascalon
57  31.173200                http://nomisma.org/id/aspendus
58  26.339656                   http://nomisma.org/id/assus
59  23.722500                  http://nomisma.org/id/athens
60  22.234955                   http://nomisma.org/id/atrax
61  30.700300                http://nomisma.org/id/attaleia
62  24.842019                    http://nomisma.org/id/axus
63  44.424150                 http://nomisma.org/id/babylon
64  66.901470                  http://nomisma.org/id/bactra
65  20.874500                   http://nomisma.org/id/barce
66  22.200000          http://nomisma.org/id/beroea_macedon
67  35.521306                 http://nomisma.org/id/berytus
68  51.581110                http://nomisma.org/id/bishapur
69  17.938956              http://nomisma.org/id/brundisium
70  16.250000                 http://nomisma.org/id/bruttii
71  35.646846                  http://nomisma.org/id/byblus
72  19.733353                  http://nomisma.org/id/byllis
73  28.976018               http://nomisma.org/id/byzantium
74  36.951027                 http://nomisma.org/id/cabeira
75  26.478937                  http://nomisma.org/id/cabyle
76  29.025789               http://nomisma.org/id/calchedon
77  14.132176                   http://nomisma.org/id/cales
78  28.582750                http://nomisma.org/id/callatis
79  27.008107                 http://nomisma.org/id/calymna
80  14.447788                http://nomisma.org/id/camarina
81  27.921321                 http://nomisma.org/id/camirus
82  16.067505       http://nomisma.org/id/campano-tarentine
83  22.262624                  http://nomisma.org/id/caphya
84  14.250357                   http://nomisma.org/id/capua
85  26.750810                  http://nomisma.org/id/cardia
86  -5.642257                   http://nomisma.org/id/carmo
87  35.884375                   http://nomisma.org/id/carne
88  39.028865                 http://nomisma.org/id/carrhae
89  24.330211                http://nomisma.org/id/carthaea
90  10.312944                http://nomisma.org/id/carthage
91  24.420381                http://nomisma.org/id/carystus
92  20.687268                 http://nomisma.org/id/cassope
93  -3.624424                 http://nomisma.org/id/castulo
94  15.088142                  http://nomisma.org/id/catana
95  16.578485                http://nomisma.org/id/caulonia
96  28.625838                  http://nomisma.org/id/caunus
97  26.563032                  http://nomisma.org/id/cebren
98  33.318106              http://nomisma.org/id/celenderis
99  14.740017              http://nomisma.org/id/centuripae
100 24.333333               http://nomisma.org/id/ceos_ceos
101 33.361389              http://nomisma.org/id/cercinitis
102 36.768000                http://nomisma.org/id/chabacta
103 23.621940                 http://nomisma.org/id/chalcis
104 47.578031         http://nomisma.org/id/charax_spasinou
105 33.493302             http://nomisma.org/id/cherronesus
106 27.739792      http://nomisma.org/id/chersonesus_cariae
107 25.388567       http://nomisma.org/id/chersonesus_crete
108 26.500000      http://nomisma.org/id/chersonesus_thrace
109 26.136818                   http://nomisma.org/id/chios
110 22.450621                  http://nomisma.org/id/cirrha
111 33.629471                  http://nomisma.org/id/citium
112 29.156390                    http://nomisma.org/id/cius
113 26.785278              http://nomisma.org/id/clazomenae
114 22.123335                 http://nomisma.org/id/cleitor
115 22.775833                 http://nomisma.org/id/cleonae
116 27.371637                  http://nomisma.org/id/cnidus
117 25.163156                 http://nomisma.org/id/cnossus
118 27.198000                http://nomisma.org/id/colophon
119 30.337100                  http://nomisma.org/id/comama
120 36.610679                  http://nomisma.org/id/comana
121 14.327125             http://nomisma.org/id/compulteria
122 16.450224                   http://nomisma.org/id/copia
123 19.924457         http://nomisma.org/id/corcyra_corcyra
124 -4.779171                 http://nomisma.org/id/corduba
125 22.933333                 http://nomisma.org/id/corinth
126 22.957112                http://nomisma.org/id/coroneia
127 21.962963                  http://nomisma.org/id/corone
128 21.159936                 http://nomisma.org/id/coronta
129 11.286503                    http://nomisma.org/id/cosa
130 11.950000                 http://nomisma.org/id/cossura
131 27.290468                     http://nomisma.org/id/cos
132 30.691100                  http://nomisma.org/id/cremna
133 32.722092                  http://nomisma.org/id/cromna
134 17.127080                  http://nomisma.org/id/croton
135 14.056082                   http://nomisma.org/id/cumae
136 24.016667                 http://nomisma.org/id/cydonia
137 26.942154             http://nomisma.org/id/cyme_aeolis
138 21.857270                  http://nomisma.org/id/cyrene
139 27.892255                 http://nomisma.org/id/cyzicus
140 36.292000                http://nomisma.org/id/damascus
141 20.750000               http://nomisma.org/id/damastium
142 26.374420                http://nomisma.org/id/dardanus
143 25.269040                   http://nomisma.org/id/delos
144 22.502106                  http://nomisma.org/id/delphi
145 36.309102         http://nomisma.org/id/demetrias_syria
146 21.360000                http://nomisma.org/id/derrones
147 31.123807                     http://nomisma.org/id/dia
148 22.947121          http://nomisma.org/id/dicaea_macedon
149 25.165653           http://nomisma.org/id/dicaea_thrace
150 28.162771     http://nomisma.org/id/dionysopolis_thrace
151 41.003076              http://nomisma.org/id/dioscurias
152 21.551425                    http://nomisma.org/id/dyme
153 19.450000             http://nomisma.org/id/dyrrhachium
154  1.432146                  http://nomisma.org/id/ebusus
155 48.516247                http://nomisma.org/id/ecbatana
156 20.910115                 http://nomisma.org/id/echinus
157 23.855317                    http://nomisma.org/id/eion
158 27.055256                   http://nomisma.org/id/elaea
159 20.560388                    http://nomisma.org/id/elea
160 23.533333                 http://nomisma.org/id/eleusis
161 24.684822              http://nomisma.org/id/eleutherna
162 21.375091               http://nomisma.org/id/elis_elis
163 23.794048                  http://nomisma.org/id/elyrus
164  3.108503                http://nomisma.org/id/emporiae
165 14.279558                    http://nomisma.org/id/enna
166 27.340833          http://nomisma.org/id/ephesus_ii_pco
167 27.340833                 http://nomisma.org/id/ephesus
168 23.160067               http://nomisma.org/id/epidaurus
169 25.931389                  http://nomisma.org/id/eresus
170 23.783333                 http://nomisma.org/id/eretria
171 26.479047                http://nomisma.org/id/erythrae
172 12.583607                    http://nomisma.org/id/eryx
173 31.438444                  http://nomisma.org/id/etenna
174 20.091198            http://nomisma.org/id/euhesperides
175 22.260000                   http://nomisma.org/id/eurea
176 28.259418                http://nomisma.org/id/euthenai
177 -6.290000                   http://nomisma.org/id/gades
178 27.320402                http://nomisma.org/id/gambrium
179 26.538692                 http://nomisma.org/id/gargara
180 34.458046                    http://nomisma.org/id/gaza
181 36.059111                 http://nomisma.org/id/gaziura
182 14.258219                    http://nomisma.org/id/gela
183 26.609255                  http://nomisma.org/id/gergis
184 50.077057                  http://nomisma.org/id/gerrha
185 25.490000             http://nomisma.org/id/geto_dacian
186 33.546609                   http://nomisma.org/id/golgi
187 21.691299                  http://nomisma.org/id/gomphi
188 37.310251               http://nomisma.org/id/gorgippia
189 24.946944                 http://nomisma.org/id/gortyna
190 23.100000               http://nomisma.org/id/haliartus
191 27.417240           http://nomisma.org/id/halicarnassus
192 13.981081                  http://nomisma.org/id/hatria
193 54.037505            http://nomisma.org/id/hecatompylos
194 16.678299       http://nomisma.org/id/heraclea_lucaniae
195 31.414722       http://nomisma.org/id/heracleia_pontica
196 22.447577     http://nomisma.org/id/heracleia_trachinia
197 16.450000     http://nomisma.org/id/heracleia_illyricum
198 27.524722      http://nomisma.org/id/heraclea_ad_latmum
199 23.243591                http://nomisma.org/id/hermione
200 37.954539      http://nomisma.org/id/hierapolis_bambyce
201 25.740363              http://nomisma.org/id/hierapytna
202 13.816667                  http://nomisma.org/id/himera
203 13.432761                  http://nomisma.org/id/hipana
204 16.097648               http://nomisma.org/id/hipponium
205 -6.157837           http://nomisma.org/id/hispano-punic
206 23.090527                http://nomisma.org/id/histiaea
207 14.518000          http://nomisma.org/id/hyria_campania
208 28.142222                 http://nomisma.org/id/ialysus
209 27.585572                   http://nomisma.org/id/iasus
210 22.591256                  http://nomisma.org/id/ichnae
211  3.056709                 http://nomisma.org/id/icosium
212 33.412994                 http://nomisma.org/id/idalium
213 28.367319                   http://nomisma.org/id/idyma
214  0.625790                  http://nomisma.org/id/ilerda
215 26.238889                   http://nomisma.org/id/ilium
216 25.903047                  http://nomisma.org/id/imbros
217  2.196871                     http://nomisma.org/id/iol
218 25.333333                     http://nomisma.org/id/ios
219 30.161900                  http://nomisma.org/id/isinda
220 16.150000                    http://nomisma.org/id/issa
221 36.164444                   http://nomisma.org/id/issus
222 52.915364                 http://nomisma.org/id/istakhr
223 28.774722                  http://nomisma.org/id/istrus
224 26.264787                  http://nomisma.org/id/itanus
225 35.234156               http://nomisma.org/id/jerusalem
226 34.747740                   http://nomisma.org/id/joppa
227 30.599358                http://nomisma.org/id/ceraitae
228  1.185439                    http://nomisma.org/id/kese
229 22.430937              http://nomisma.org/id/lacedaemon
230 22.442593                   http://nomisma.org/id/lamia
231 26.699162               http://nomisma.org/id/lampsacus
232 35.783333       http://nomisma.org/id/laodiceia_ad_mare
233 29.136425      http://nomisma.org/id/laodiceia_ad_lycum
234 33.202109                http://nomisma.org/id/lapethus
235 22.416667        http://nomisma.org/id/larissa_thessaly
236 15.824400                    http://nomisma.org/id/laus
237 26.964722                 http://nomisma.org/id/lebedus
238 25.250000                  http://nomisma.org/id/lemnos
239 14.998115                http://nomisma.org/id/leontini
240 22.978076                    http://nomisma.org/id/lete
241 20.713116                  http://nomisma.org/id/leucas
242 22.517809                  http://nomisma.org/id/lilaea
243 28.083333                  http://nomisma.org/id/lindus
244 14.953897                  http://nomisma.org/id/lipara
245 19.636923                  http://nomisma.org/id/lissus
246 -6.110370                     http://nomisma.org/id/lix
247 16.259895       http://nomisma.org/id/locri_epizephyrii
248 15.335884                 http://nomisma.org/id/luceria
249 29.750000                  http://nomisma.org/id/lysias
250 26.750810              http://nomisma.org/id/lysimachia
251 25.370340                  http://nomisma.org/id/lyttus
252 23.846565    http://nomisma.org/id/macedonia_1st_region
253 22.956201    http://nomisma.org/id/macedonia_2nd_region
254 27.533091   http://nomisma.org/id/magnesia_ad_maeandrum
255 22.750000                http://nomisma.org/id/magnesia
256 35.381298                  http://nomisma.org/id/mallus
257 15.550000               http://nomisma.org/id/mamertini
258 22.391896               http://nomisma.org/id/mantineia
259 35.908186                http://nomisma.org/id/marathus
260 32.436032                  http://nomisma.org/id/marium
261 25.519130                http://nomisma.org/id/maroneia
262  5.382499                http://nomisma.org/id/massalia
263 22.128459             http://nomisma.org/id/megalopolis
264 23.340163                  http://nomisma.org/id/megara
265 24.423276                   http://nomisma.org/id/melos
266 31.250917                 http://nomisma.org/id/memphis
267 14.690940                http://nomisma.org/id/menaenum
268 23.398060                   http://nomisma.org/id/mende
269 27.718100               http://nomisma.org/id/mesembria
270 15.976368                   http://nomisma.org/id/mesma
271 15.556634                 http://nomisma.org/id/messana
272 22.000000                 http://nomisma.org/id/messene
273 16.822782              http://nomisma.org/id/metapontum
274 23.349005                 http://nomisma.org/id/methana
275 26.166667                http://nomisma.org/id/methymna
276 21.250000    http://nomisma.org/id/metropolis_acarnania
277 22.500000     http://nomisma.org/id/metropolis_thessaly
278 27.278369                 http://nomisma.org/id/miletus
279 23.650000                    http://nomisma.org/id/moda
280 20.250000                 http://nomisma.org/id/molossi
281 35.625744              http://nomisma.org/id/mopsuestia
282 14.479296              http://nomisma.org/id/morgantina
283 12.469267                   http://nomisma.org/id/motya
284 27.783333                  http://nomisma.org/id/mylasa
285 27.229636                  http://nomisma.org/id/myndus
286 36.110356              http://nomisma.org/id/myriandrus
287 26.985537           http://nomisma.org/id/myrina_aeolis
288 26.552371                http://nomisma.org/id/mytilene
289 32.975829                 http://nomisma.org/id/nagidus
290 43.605000                 http://nomisma.org/id/natunia
291 25.377595                   http://nomisma.org/id/naxos
292 15.266688                   http://nomisma.org/id/naxus
293 26.270341                http://nomisma.org/id/neandria
294 14.252870       http://nomisma.org/id/neapolis_campania
295 24.413063        http://nomisma.org/id/neapolis_macedon
296 26.654808                   http://nomisma.org/id/nesos
297 43.152778                 http://nomisma.org/id/nineveh
298 41.216667                 http://nomisma.org/id/nisibis
299 27.172056                 http://nomisma.org/id/nisyros
300 14.528564                    http://nomisma.org/id/nola
301 14.673929                 http://nomisma.org/id/nuceria
302 36.417269               http://nomisma.org/id/nymphaeum
303 28.151194                    http://nomisma.org/id/nysa
304 27.908595                 http://nomisma.org/id/odessus
305 21.195384                http://nomisma.org/id/oeniadae
306 26.166667                   http://nomisma.org/id/oenoe
307 22.288611                    http://nomisma.org/id/oeta
308 31.901597                   http://nomisma.org/id/olbia
309 23.342665                http://nomisma.org/id/olynthus
310 26.343963               http://nomisma.org/id/ophrynium
311 22.983333      http://nomisma.org/id/orchomenus_boeotia
312 19.475022                  http://nomisma.org/id/oricus
313 24.914000                   http://nomisma.org/id/orion
314 23.568000                http://nomisma.org/id/orrescii
315 22.193106                   http://nomisma.org/id/orthe
316 15.005569                 http://nomisma.org/id/paestum
317 16.557488       http://nomisma.org/id/pandosia_bruttium
318 13.366667                http://nomisma.org/id/panormus
319 36.468056            http://nomisma.org/id/panticapaeum
320 32.407565                  http://nomisma.org/id/paphus
321 27.069096                  http://nomisma.org/id/parium
322 25.150728                   http://nomisma.org/id/paros
323 21.733333                  http://nomisma.org/id/patrae
324 30.934483             http://nomisma.org/id/pednelissus
325 21.502991                 http://nomisma.org/id/pelinna
326 22.525642           http://nomisma.org/id/pella_macedon
327 22.548344                 http://nomisma.org/id/pellene
328 23.716667              http://nomisma.org/id/peparethus
329 27.183333                http://nomisma.org/id/pergamum
330 30.855068                   http://nomisma.org/id/perge
331 27.952973               http://nomisma.org/id/perinthus
332 14.430000              http://nomisma.org/id/peripolium
333 21.750000              http://nomisma.org/id/perrhaebia
334 17.051080                 http://nomisma.org/id/petelia
335 22.217000                 http://nomisma.org/id/phacium
336 24.810922                http://nomisma.org/id/phaestus
337 23.580383              http://nomisma.org/id/phalasarna
338 36.825000              http://nomisma.org/id/phanagoria
339 23.622995                  http://nomisma.org/id/pharae
340 16.601041                  http://nomisma.org/id/pharos
341 22.385000               http://nomisma.org/id/pharsalus
342 30.549049                http://nomisma.org/id/phaselis
343 22.295238                 http://nomisma.org/id/pheneus
344 24.286389                http://nomisma.org/id/philippi
345 34.624786        http://nomisma.org/id/philisto-arabian
346 14.570000               http://nomisma.org/id/phistelia
347 22.641069                  http://nomisma.org/id/phlius
348 26.753208                 http://nomisma.org/id/phocaea
349 34.709815                http://nomisma.org/id/pimolisa
350 23.266944                 http://nomisma.org/id/plataea
351 23.657098             http://nomisma.org/id/polyrhenium
352 10.491389               http://nomisma.org/id/populonia
353 27.214165               http://nomisma.org/id/poseidium
354 15.005569              http://nomisma.org/id/poseidonia
355 23.327812                http://nomisma.org/id/potidaea
356 26.089695                 http://nomisma.org/id/praesus
357 25.258393                http://nomisma.org/id/priansus
358 27.297778                  http://nomisma.org/id/priene
359 27.509766               http://nomisma.org/id/propontis
360 35.077005           http://nomisma.org/id/ace_ptolemais
361 15.511849                   http://nomisma.org/id/pyxus
362 14.026402            http://nomisma.org/id/rash_melqart
363 25.024828                 http://nomisma.org/id/rhaucus
364 15.643930                 http://nomisma.org/id/rhegium
365  3.166667                   http://nomisma.org/id/rhoda
366 28.216667                  http://nomisma.org/id/rhodes
367 12.500000                    http://nomisma.org/id/rome
368 -0.515639                http://nomisma.org/id/saetabis
369 30.525300              http://nomisma.org/id/sagalassus
370 -0.278608                http://nomisma.org/id/saguntum
371 23.500000          http://nomisma.org/id/salamis_attica
372 33.903589          http://nomisma.org/id/salamis_cyprus
373 15.993300                 http://nomisma.org/id/salapia
374 20.658925                    http://nomisma.org/id/same
375 26.943056                   http://nomisma.org/id/samos
376 25.526069              http://nomisma.org/id/samothrace
377 28.040286                  http://nomisma.org/id/sardes
378 26.688003                 http://nomisma.org/id/scepsis
379 23.574785                  http://nomisma.org/id/scione
380 19.527653                  http://nomisma.org/id/scodra
381 24.565356                  http://nomisma.org/id/scyros
382 12.832490                 http://nomisma.org/id/segesta
383 35.921192        http://nomisma.org/id/seleuceia_pieria
384 33.927572 http://nomisma.org/id/seleuceia_ad_calycadnum
385 44.517222     http://nomisma.org/id/seleuceia_ad_tigrim
386 31.127926                   http://nomisma.org/id/selge
387 12.825120          http://nomisma.org/id/selinus_sicily
388 15.851898                 http://nomisma.org/id/serdaei
389 24.506206                http://nomisma.org/id/seriphos
390 23.539631                 http://nomisma.org/id/sermyle
391 32.385648                 http://nomisma.org/id/sesamus
392 26.417225                  http://nomisma.org/id/sestus
393 14.150000            http://nomisma.org/id/siculo_punic
394 22.722718                  http://nomisma.org/id/sicyon
395 31.393400                    http://nomisma.org/id/side
396 35.375272                   http://nomisma.org/id/sidon
397 26.184284                  http://nomisma.org/id/sigeum
398 30.986380                 http://nomisma.org/id/sillyum
399 35.143037                  http://nomisma.org/id/sinope
400 24.666667                 http://nomisma.org/id/siphnos
401 16.541370                   http://nomisma.org/id/siris
402 27.142778                  http://nomisma.org/id/smyrna
403 34.537894       http://nomisma.org/id/soli-pompeiopolis
404 32.812600             http://nomisma.org/id/soli_cyprus
405 23.792040                http://nomisma.org/id/stageira
406 28.059198            http://nomisma.org/id/stratoniceia
407 21.316272                 http://nomisma.org/id/stratus
408 22.464499              http://nomisma.org/id/stymphalus
409 13.933756          http://nomisma.org/id/suessa_aurunca
410 48.257785                    http://nomisma.org/id/susa
411 16.450224                 http://nomisma.org/id/sybaris
412 24.639291                 http://nomisma.org/id/sybrita
413 30.550000                 http://nomisma.org/id/synnada
414 15.283333                http://nomisma.org/id/syracuse
415 24.900000                   http://nomisma.org/id/syros
416 23.533333                 http://nomisma.org/id/tanagra
417 24.200549                   http://nomisma.org/id/tanus
418 17.270164                   http://nomisma.org/id/taras
419 34.900000                  http://nomisma.org/id/tarsus
420 36.552000                 http://nomisma.org/id/taulara
421 15.292135             http://nomisma.org/id/tauromenium
422 72.815207                  http://nomisma.org/id/taxila
423 14.067524        http://nomisma.org/id/teanum_sidicinum
424 14.167152                   http://nomisma.org/id/teate
425 22.420500                   http://nomisma.org/id/tegea
426 27.338729                   http://nomisma.org/id/telos
427 16.159633                  http://nomisma.org/id/temesa
428 27.196998                  http://nomisma.org/id/temnus
429 26.069085                 http://nomisma.org/id/tenedos
430 25.166667                   http://nomisma.org/id/tenos
431 26.837477                    http://nomisma.org/id/teos
432 16.238922                  http://nomisma.org/id/terina
433 29.560692         http://nomisma.org/id/termessus_minor
434 30.464189         http://nomisma.org/id/termessus_major
435 23.908089                  http://nomisma.org/id/terone
436 20.560300               http://nomisma.org/id/teucheira
437 24.703702                  http://nomisma.org/id/thasos
438 22.818269                  http://nomisma.org/id/thebae
439 23.317355                  http://nomisma.org/id/thebes
440 25.477816                   http://nomisma.org/id/thera
441 13.696138      http://nomisma.org/id/thermae_himerenses
442 22.944020                  http://nomisma.org/id/therma
443 23.158322                http://nomisma.org/id/thespiae
444 22.950000            http://nomisma.org/id/thessalonica
445 23.252564       http://nomisma.org/id/thraco-macedonian
446 16.450224                 http://nomisma.org/id/thurium
447 27.849235                http://nomisma.org/id/thyatira
448 20.980902              http://nomisma.org/id/thyrrheium
449 22.799814                  http://nomisma.org/id/tiryns
450 29.420789                    http://nomisma.org/id/tlos
451 28.638299                   http://nomisma.org/id/tomis
452 27.845800                 http://nomisma.org/id/tralles
453 39.718172                http://nomisma.org/id/trapezus
454 21.782998                  http://nomisma.org/id/tricca
455 35.838776      http://nomisma.org/id/tripolis_phoenicia
456 25.015797                 http://nomisma.org/id/tylisus
457 30.350539                   http://nomisma.org/id/tyras
458 35.194938                    http://nomisma.org/id/tyre
459 23.934807              http://nomisma.org/id/uranopolis
460 -0.366667                http://nomisma.org/id/valentia
461 15.154444                   http://nomisma.org/id/velia
462 10.971171               http://nomisma.org/id/vetulonia
463 10.861106              http://nomisma.org/id/volaterrae
464 15.556634                  http://nomisma.org/id/zancle
465 13.353442                     http://nomisma.org/id/ziz</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Join GeoJSON coordinates to mint_list by matching URI or mint_id</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>mint_coords <span class="ot">&lt;-</span> mint_list <span class="sc">%&gt;%</span></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">mint_id_clean =</span> <span class="fu">str_extract</span>(mint_uri, <span class="st">"[^/]+$"</span>)</span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(</span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>    mints_from_geojson <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">select</span>(mint_id_from_uri, mint_lat, mint_lon),</span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"mint_id_clean"</span> <span class="ot">=</span> <span class="st">"mint_id_from_uri"</span>)</span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Summary</span></span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a>n_with_coords <span class="ot">&lt;-</span> <span class="fu">sum</span>(<span class="sc">!</span><span class="fu">is.na</span>(mint_coords<span class="sc">$</span>mint_lat))</span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">✓ Mints with coordinates from GeoJSON:"</span>, n_with_coords, <span class="st">"of"</span>, <span class="fu">nrow</span>(mint_coords), </span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a>    <span class="st">"("</span>, <span class="fu">round</span>(<span class="dv">100</span><span class="sc">*</span>n_with_coords<span class="sc">/</span><span class="fu">nrow</span>(mint_coords), <span class="dv">1</span>), <span class="st">"%)</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
✓ Mints with coordinates from GeoJSON: 4 of 14 ( 28.6 %)</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Show mints without coordinates</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>missing_coords <span class="ot">&lt;-</span> mint_coords <span class="sc">%&gt;%</span></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">is.na</span>(mint_lat)) <span class="sc">%&gt;%</span></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(n_types))</span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">nrow</span>(missing_coords) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Mints missing coordinates (top 20 by volume):</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(<span class="fu">head</span>(missing_coords <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">select</span>(mint_id, mint_uri, n_types), <span class="dv">20</span>))</span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
Mints missing coordinates (top 20 by volume):
# A tibble: 10 × 3
   mint_id             mint_uri                                  n_types
   &lt;chr&gt;               &lt;chr&gt;                                       &lt;int&gt;
 1 uncertain_value     http://nomisma.org/id/uncertain_value        2263
 2 narbo               http://nomisma.org/id/narbo                   379
 3 italy_north_rrc     http://nomisma.org/id/italy_north_rrc         297
 4 italy_southeast_rrc http://nomisma.org/id/italy_southeast_rrc      53
 5 sicily2_rrc         http://nomisma.org/id/sicily2_rrc              45
 6 italy_central_rrc   http://nomisma.org/id/italy_central_rrc        24
 7 sicily1_rrc         http://nomisma.org/id/sicily1_rrc              12
 8 osca                http://nomisma.org/id/osca                      4
 9 lugdunum            http://nomisma.org/id/lugdunum                  3
10 salpesa             http://nomisma.org/id/salpesa                   3</code></pre>
</div>
</div>
</section>
<section id="manual-coordinate-additions" class="level2" data-number="3.4">
<h2 data-number="3.4" class="anchored" data-anchor-id="manual-coordinate-additions"><span class="header-section-number">3.4</span> 1.4 Manual Coordinate Additions</h2>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Comprehensive manual coordinates for Roman Republican mints</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Since Nomisma API may not return coordinates, we provide known locations</span></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>manual_coords <span class="ot">&lt;-</span> <span class="fu">tribble</span>(</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>  <span class="sc">~</span>mint_id, <span class="sc">~</span>mint_lat, <span class="sc">~</span>mint_lon,</span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Rome and Italy</span></span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>  <span class="st">"rome"</span>, <span class="fl">41.9028</span>, <span class="fl">12.4964</span>,</span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>  <span class="st">"roma"</span>, <span class="fl">41.9028</span>, <span class="fl">12.4964</span>,</span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a>  <span class="st">"luceria"</span>, <span class="fl">41.5089</span>, <span class="fl">15.3350</span>,</span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a>  <span class="st">"capua"</span>, <span class="fl">41.1067</span>, <span class="fl">14.2133</span>,</span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a>  <span class="st">"croton"</span>, <span class="fl">39.0811</span>, <span class="fl">17.1275</span>,</span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a>  <span class="st">"crotona"</span>, <span class="fl">39.0811</span>, <span class="fl">17.1275</span>,</span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a>  <span class="st">"brundisium"</span>, <span class="fl">40.6333</span>, <span class="fl">17.9333</span>,</span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a>  <span class="st">"tarentum"</span>, <span class="fl">40.4667</span>, <span class="fl">17.2333</span>,</span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true" tabindex="-1"></a>  <span class="st">"venusia"</span>, <span class="fl">40.9667</span>, <span class="fl">15.8167</span>,</span>
<span id="cb21-15"><a href="#cb21-15" aria-hidden="true" tabindex="-1"></a>  <span class="st">"canusium"</span>, <span class="fl">41.2167</span>, <span class="fl">16.0667</span>,</span>
<span id="cb21-16"><a href="#cb21-16" aria-hidden="true" tabindex="-1"></a>  <span class="st">"hatria"</span>, <span class="fl">42.8333</span>, <span class="fl">13.9833</span>,</span>
<span id="cb21-17"><a href="#cb21-17" aria-hidden="true" tabindex="-1"></a>  <span class="st">"cales"</span>, <span class="fl">41.2000</span>, <span class="fl">14.2167</span>,</span>
<span id="cb21-18"><a href="#cb21-18" aria-hidden="true" tabindex="-1"></a>  <span class="st">"suessa"</span>, <span class="fl">41.2333</span>, <span class="fl">13.9333</span>,</span>
<span id="cb21-19"><a href="#cb21-19" aria-hidden="true" tabindex="-1"></a>  <span class="st">"teanum"</span>, <span class="fl">41.2500</span>, <span class="fl">14.0667</span>,</span>
<span id="cb21-20"><a href="#cb21-20" aria-hidden="true" tabindex="-1"></a>  <span class="st">"aquileia"</span>, <span class="fl">45.7667</span>, <span class="fl">13.3667</span>,</span>
<span id="cb21-21"><a href="#cb21-21" aria-hidden="true" tabindex="-1"></a>  <span class="st">"arretium"</span>, <span class="fl">43.4633</span>, <span class="fl">11.8783</span>,</span>
<span id="cb21-22"><a href="#cb21-22" aria-hidden="true" tabindex="-1"></a>  <span class="st">"ariminum"</span>, <span class="fl">44.0594</span>, <span class="fl">12.5683</span>,</span>
<span id="cb21-23"><a href="#cb21-23" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb21-24"><a href="#cb21-24" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Regional Italian</span></span>
<span id="cb21-25"><a href="#cb21-25" aria-hidden="true" tabindex="-1"></a>  <span class="st">"italy_north_rrc"</span>, <span class="fl">45.0000</span>, <span class="fl">11.0000</span>,  <span class="co"># Centroid</span></span>
<span id="cb21-26"><a href="#cb21-26" aria-hidden="true" tabindex="-1"></a>  <span class="st">"italy_central_rrc"</span>, <span class="fl">42.5000</span>, <span class="fl">12.5000</span>,</span>
<span id="cb21-27"><a href="#cb21-27" aria-hidden="true" tabindex="-1"></a>  <span class="st">"italy_southeast_rrc"</span>, <span class="fl">40.5000</span>, <span class="fl">17.0000</span>,</span>
<span id="cb21-28"><a href="#cb21-28" aria-hidden="true" tabindex="-1"></a>  <span class="st">"italy_south_rrc"</span>, <span class="fl">40.0000</span>, <span class="fl">16.0000</span>,</span>
<span id="cb21-29"><a href="#cb21-29" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb21-30"><a href="#cb21-30" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Sicily and Sardinia  </span></span>
<span id="cb21-31"><a href="#cb21-31" aria-hidden="true" tabindex="-1"></a>  <span class="st">"sicily2_rrc"</span>, <span class="fl">37.5000</span>, <span class="fl">14.0000</span>,</span>
<span id="cb21-32"><a href="#cb21-32" aria-hidden="true" tabindex="-1"></a>  <span class="st">"sicily_rrc"</span>, <span class="fl">37.5000</span>, <span class="fl">14.0000</span>,</span>
<span id="cb21-33"><a href="#cb21-33" aria-hidden="true" tabindex="-1"></a>  <span class="st">"syracusae"</span>, <span class="fl">37.0755</span>, <span class="fl">15.2866</span>,</span>
<span id="cb21-34"><a href="#cb21-34" aria-hidden="true" tabindex="-1"></a>  <span class="st">"syracuse"</span>, <span class="fl">37.0755</span>, <span class="fl">15.2866</span>,</span>
<span id="cb21-35"><a href="#cb21-35" aria-hidden="true" tabindex="-1"></a>  <span class="st">"panormus"</span>, <span class="fl">38.1157</span>, <span class="fl">13.3615</span>,</span>
<span id="cb21-36"><a href="#cb21-36" aria-hidden="true" tabindex="-1"></a>  <span class="st">"lilybaeum"</span>, <span class="fl">37.8000</span>, <span class="fl">12.4333</span>,</span>
<span id="cb21-37"><a href="#cb21-37" aria-hidden="true" tabindex="-1"></a>  <span class="st">"sardinia_rrc"</span>, <span class="fl">40.0000</span>, <span class="fl">9.0000</span>,</span>
<span id="cb21-38"><a href="#cb21-38" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb21-39"><a href="#cb21-39" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Gaul</span></span>
<span id="cb21-40"><a href="#cb21-40" aria-hidden="true" tabindex="-1"></a>  <span class="st">"massalia"</span>, <span class="fl">43.2965</span>, <span class="fl">5.3698</span>,</span>
<span id="cb21-41"><a href="#cb21-41" aria-hidden="true" tabindex="-1"></a>  <span class="st">"narbo"</span>, <span class="fl">43.1833</span>, <span class="fl">3.0000</span>,</span>
<span id="cb21-42"><a href="#cb21-42" aria-hidden="true" tabindex="-1"></a>  <span class="st">"lugdunum"</span>, <span class="fl">45.7640</span>, <span class="fl">4.8357</span>,</span>
<span id="cb21-43"><a href="#cb21-43" aria-hidden="true" tabindex="-1"></a>  <span class="st">"vienna"</span>, <span class="fl">45.5167</span>, <span class="fl">4.8833</span>,</span>
<span id="cb21-44"><a href="#cb21-44" aria-hidden="true" tabindex="-1"></a>  <span class="st">"nemausus"</span>, <span class="fl">43.8367</span>, <span class="fl">4.3600</span>,</span>
<span id="cb21-45"><a href="#cb21-45" aria-hidden="true" tabindex="-1"></a>  <span class="st">"gallia_rrc"</span>, <span class="fl">45.0000</span>, <span class="fl">3.0000</span>,</span>
<span id="cb21-46"><a href="#cb21-46" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb21-47"><a href="#cb21-47" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Hispania</span></span>
<span id="cb21-48"><a href="#cb21-48" aria-hidden="true" tabindex="-1"></a>  <span class="st">"tarraco"</span>, <span class="fl">41.1189</span>, <span class="fl">1.2445</span>,</span>
<span id="cb21-49"><a href="#cb21-49" aria-hidden="true" tabindex="-1"></a>  <span class="st">"carthago_nova"</span>, <span class="fl">37.6000</span>, <span class="sc">-</span><span class="fl">0.9833</span>,</span>
<span id="cb21-50"><a href="#cb21-50" aria-hidden="true" tabindex="-1"></a>  <span class="st">"emporiae"</span>, <span class="fl">42.1333</span>, <span class="fl">3.1167</span>,</span>
<span id="cb21-51"><a href="#cb21-51" aria-hidden="true" tabindex="-1"></a>  <span class="st">"emporia"</span>, <span class="fl">42.1333</span>, <span class="fl">3.1167</span>,</span>
<span id="cb21-52"><a href="#cb21-52" aria-hidden="true" tabindex="-1"></a>  <span class="st">"osca"</span>, <span class="fl">42.1400</span>, <span class="sc">-</span><span class="fl">0.4083</span>,</span>
<span id="cb21-53"><a href="#cb21-53" aria-hidden="true" tabindex="-1"></a>  <span class="st">"saguntum"</span>, <span class="fl">39.6833</span>, <span class="sc">-</span><span class="fl">0.2667</span>,</span>
<span id="cb21-54"><a href="#cb21-54" aria-hidden="true" tabindex="-1"></a>  <span class="st">"corduba"</span>, <span class="fl">37.8833</span>, <span class="sc">-</span><span class="fl">4.7667</span>,</span>
<span id="cb21-55"><a href="#cb21-55" aria-hidden="true" tabindex="-1"></a>  <span class="st">"hispania_rrc"</span>, <span class="fl">40.0000</span>, <span class="sc">-</span><span class="fl">3.0000</span>,</span>
<span id="cb21-56"><a href="#cb21-56" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb21-57"><a href="#cb21-57" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Greece and Macedonia</span></span>
<span id="cb21-58"><a href="#cb21-58" aria-hidden="true" tabindex="-1"></a>  <span class="st">"apollonia_illyria"</span>, <span class="fl">40.7167</span>, <span class="fl">19.4833</span>,</span>
<span id="cb21-59"><a href="#cb21-59" aria-hidden="true" tabindex="-1"></a>  <span class="st">"apollonia"</span>, <span class="fl">40.7167</span>, <span class="fl">19.4833</span>,</span>
<span id="cb21-60"><a href="#cb21-60" aria-hidden="true" tabindex="-1"></a>  <span class="st">"dyrrhachium"</span>, <span class="fl">41.3167</span>, <span class="fl">19.4500</span>,</span>
<span id="cb21-61"><a href="#cb21-61" aria-hidden="true" tabindex="-1"></a>  <span class="st">"thessalonica"</span>, <span class="fl">40.6403</span>, <span class="fl">22.9439</span>,</span>
<span id="cb21-62"><a href="#cb21-62" aria-hidden="true" tabindex="-1"></a>  <span class="st">"thessaloniki"</span>, <span class="fl">40.6403</span>, <span class="fl">22.9439</span>,</span>
<span id="cb21-63"><a href="#cb21-63" aria-hidden="true" tabindex="-1"></a>  <span class="st">"corinthus"</span>, <span class="fl">37.9060</span>, <span class="fl">22.8800</span>,</span>
<span id="cb21-64"><a href="#cb21-64" aria-hidden="true" tabindex="-1"></a>  <span class="st">"corinth"</span>, <span class="fl">37.9060</span>, <span class="fl">22.8800</span>,</span>
<span id="cb21-65"><a href="#cb21-65" aria-hidden="true" tabindex="-1"></a>  <span class="st">"athenae"</span>, <span class="fl">37.9838</span>, <span class="fl">23.7275</span>,</span>
<span id="cb21-66"><a href="#cb21-66" aria-hidden="true" tabindex="-1"></a>  <span class="st">"athens"</span>, <span class="fl">37.9838</span>, <span class="fl">23.7275</span>,</span>
<span id="cb21-67"><a href="#cb21-67" aria-hidden="true" tabindex="-1"></a>  <span class="st">"macedonia_rrc"</span>, <span class="fl">41.0000</span>, <span class="fl">22.0000</span>,</span>
<span id="cb21-68"><a href="#cb21-68" aria-hidden="true" tabindex="-1"></a>  <span class="st">"achaea_rrc"</span>, <span class="fl">38.0000</span>, <span class="fl">22.0000</span>,</span>
<span id="cb21-69"><a href="#cb21-69" aria-hidden="true" tabindex="-1"></a>  <span class="st">"greece_rrc"</span>, <span class="fl">39.0000</span>, <span class="fl">22.0000</span>,</span>
<span id="cb21-70"><a href="#cb21-70" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb21-71"><a href="#cb21-71" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Asia Minor</span></span>
<span id="cb21-72"><a href="#cb21-72" aria-hidden="true" tabindex="-1"></a>  <span class="st">"ephesus"</span>, <span class="fl">37.9394</span>, <span class="fl">27.3417</span>,</span>
<span id="cb21-73"><a href="#cb21-73" aria-hidden="true" tabindex="-1"></a>  <span class="st">"ephesos"</span>, <span class="fl">37.9394</span>, <span class="fl">27.3417</span>,</span>
<span id="cb21-74"><a href="#cb21-74" aria-hidden="true" tabindex="-1"></a>  <span class="st">"pergamum"</span>, <span class="fl">39.1167</span>, <span class="fl">27.1833</span>,</span>
<span id="cb21-75"><a href="#cb21-75" aria-hidden="true" tabindex="-1"></a>  <span class="st">"pergamon"</span>, <span class="fl">39.1167</span>, <span class="fl">27.1833</span>,</span>
<span id="cb21-76"><a href="#cb21-76" aria-hidden="true" tabindex="-1"></a>  <span class="st">"smyrna"</span>, <span class="fl">38.4192</span>, <span class="fl">27.1287</span>,</span>
<span id="cb21-77"><a href="#cb21-77" aria-hidden="true" tabindex="-1"></a>  <span class="st">"sardis"</span>, <span class="fl">38.4833</span>, <span class="fl">28.0333</span>,</span>
<span id="cb21-78"><a href="#cb21-78" aria-hidden="true" tabindex="-1"></a>  <span class="st">"antioch"</span>, <span class="fl">36.2000</span>, <span class="fl">36.1500</span>,</span>
<span id="cb21-79"><a href="#cb21-79" aria-hidden="true" tabindex="-1"></a>  <span class="st">"antiochia"</span>, <span class="fl">36.2000</span>, <span class="fl">36.1500</span>,</span>
<span id="cb21-80"><a href="#cb21-80" aria-hidden="true" tabindex="-1"></a>  <span class="st">"asia_rrc"</span>, <span class="fl">38.5000</span>, <span class="fl">28.0000</span>,</span>
<span id="cb21-81"><a href="#cb21-81" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb21-82"><a href="#cb21-82" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Africa</span></span>
<span id="cb21-83"><a href="#cb21-83" aria-hidden="true" tabindex="-1"></a>  <span class="st">"carthago"</span>, <span class="fl">36.8528</span>, <span class="fl">10.3233</span>,</span>
<span id="cb21-84"><a href="#cb21-84" aria-hidden="true" tabindex="-1"></a>  <span class="st">"carthage"</span>, <span class="fl">36.8528</span>, <span class="fl">10.3233</span>,</span>
<span id="cb21-85"><a href="#cb21-85" aria-hidden="true" tabindex="-1"></a>  <span class="st">"utica"</span>, <span class="fl">37.0553</span>, <span class="fl">10.0617</span>,</span>
<span id="cb21-86"><a href="#cb21-86" aria-hidden="true" tabindex="-1"></a>  <span class="st">"cirta"</span>, <span class="fl">36.3650</span>, <span class="fl">6.6147</span>,</span>
<span id="cb21-87"><a href="#cb21-87" aria-hidden="true" tabindex="-1"></a>  <span class="st">"africa_rrc"</span>, <span class="fl">36.0000</span>, <span class="fl">9.0000</span>,</span>
<span id="cb21-88"><a href="#cb21-88" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb21-89"><a href="#cb21-89" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Pontus / Black Sea</span></span>
<span id="cb21-90"><a href="#cb21-90" aria-hidden="true" tabindex="-1"></a>  <span class="st">"amisus"</span>, <span class="fl">41.7167</span>, <span class="fl">36.3333</span>,</span>
<span id="cb21-91"><a href="#cb21-91" aria-hidden="true" tabindex="-1"></a>  <span class="st">"sinope"</span>, <span class="fl">42.0231</span>, <span class="fl">35.1531</span>,</span>
<span id="cb21-92"><a href="#cb21-92" aria-hidden="true" tabindex="-1"></a>  <span class="st">"pontus_rrc"</span>, <span class="fl">41.0000</span>, <span class="fl">36.0000</span>,</span>
<span id="cb21-93"><a href="#cb21-93" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb21-94"><a href="#cb21-94" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Military / Moving mints</span></span>
<span id="cb21-95"><a href="#cb21-95" aria-hidden="true" tabindex="-1"></a>  <span class="st">"military_mint_rrc"</span>, <span class="cn">NA_real_</span>, <span class="cn">NA_real_</span>,</span>
<span id="cb21-96"><a href="#cb21-96" aria-hidden="true" tabindex="-1"></a>  <span class="st">"moving_mint"</span>, <span class="cn">NA_real_</span>, <span class="cn">NA_real_</span>,</span>
<span id="cb21-97"><a href="#cb21-97" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb21-98"><a href="#cb21-98" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Uncertain</span></span>
<span id="cb21-99"><a href="#cb21-99" aria-hidden="true" tabindex="-1"></a>  <span class="st">"uncertain"</span>, <span class="cn">NA_real_</span>, <span class="cn">NA_real_</span>,</span>
<span id="cb21-100"><a href="#cb21-100" aria-hidden="true" tabindex="-1"></a>  <span class="st">"uncertain_value"</span>, <span class="cn">NA_real_</span>, <span class="cn">NA_real_</span>,</span>
<span id="cb21-101"><a href="#cb21-101" aria-hidden="true" tabindex="-1"></a>  <span class="st">"unknown"</span>, <span class="cn">NA_real_</span>, <span class="cn">NA_real_</span></span>
<span id="cb21-102"><a href="#cb21-102" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb21-103"><a href="#cb21-103" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-104"><a href="#cb21-104" aria-hidden="true" tabindex="-1"></a><span class="co"># Debug: show what mint_ids we have in mint_coords</span></span>
<span id="cb21-105"><a href="#cb21-105" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Mint IDs in mint_coords:</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
Mint IDs in mint_coords:</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(mint_coords<span class="sc">$</span>mint_id)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code> [1] "rome"                "uncertain_value"     "narbo"              
 [4] "italy_north_rrc"     "massalia"            "italy_southeast_rrc"
 [7] "sicily2_rrc"         "apollonia_illyria"   "luceria"            
[10] "italy_central_rrc"   "sicily1_rrc"         "osca"               
[13] "lugdunum"            "salpesa"            </code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Sample of manual_coords:</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
Sample of manual_coords:</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">head</span>(manual_coords, <span class="dv">10</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 10 × 3
   mint_id    mint_lat mint_lon
   &lt;chr&gt;         &lt;dbl&gt;    &lt;dbl&gt;
 1 rome           41.9     12.5
 2 roma           41.9     12.5
 3 luceria        41.5     15.3
 4 capua          41.1     14.2
 5 croton         39.1     17.1
 6 crotona        39.1     17.1
 7 brundisium     40.6     17.9
 8 tarentum       40.5     17.2
 9 venusia        41.0     15.8
10 canusium       41.2     16.1</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Update mint_coords with manual additions where GeoJSON didn't have coordinates</span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Try matching on mint_id first, then mint_id_clean</span></span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>n_updated <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">seq_len</span>(<span class="fu">nrow</span>(manual_coords))) {</span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a>  mid <span class="ot">&lt;-</span> manual_coords<span class="sc">$</span>mint_id[i]</span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a>  mlat <span class="ot">&lt;-</span> manual_coords<span class="sc">$</span>mint_lat[i]</span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a>  mlon <span class="ot">&lt;-</span> manual_coords<span class="sc">$</span>mint_lon[i]</span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.na</span>(mlat) <span class="sc">||</span> <span class="fu">is.na</span>(mlon)) <span class="cf">next</span>  <span class="co"># Skip if manual coords are NA</span></span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb29-11"><a href="#cb29-11" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Check if this mint exists in mint_coords</span></span>
<span id="cb29-12"><a href="#cb29-12" aria-hidden="true" tabindex="-1"></a>  idx <span class="ot">&lt;-</span> <span class="fu">which</span>(mint_coords<span class="sc">$</span>mint_id <span class="sc">==</span> mid)</span>
<span id="cb29-13"><a href="#cb29-13" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">length</span>(idx) <span class="sc">==</span> <span class="dv">0</span>) {</span>
<span id="cb29-14"><a href="#cb29-14" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Try mint_id_clean</span></span>
<span id="cb29-15"><a href="#cb29-15" aria-hidden="true" tabindex="-1"></a>    idx <span class="ot">&lt;-</span> <span class="fu">which</span>(mint_coords<span class="sc">$</span>mint_id_clean <span class="sc">==</span> mid)</span>
<span id="cb29-16"><a href="#cb29-16" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb29-17"><a href="#cb29-17" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb29-18"><a href="#cb29-18" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">length</span>(idx) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb29-19"><a href="#cb29-19" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Update if coords are missing</span></span>
<span id="cb29-20"><a href="#cb29-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">is.na</span>(mint_coords<span class="sc">$</span>mint_lat[idx[<span class="dv">1</span>]])) {</span>
<span id="cb29-21"><a href="#cb29-21" aria-hidden="true" tabindex="-1"></a>      mint_coords<span class="sc">$</span>mint_lat[idx] <span class="ot">&lt;-</span> mlat</span>
<span id="cb29-22"><a href="#cb29-22" aria-hidden="true" tabindex="-1"></a>      mint_coords<span class="sc">$</span>mint_lon[idx] <span class="ot">&lt;-</span> mlon</span>
<span id="cb29-23"><a href="#cb29-23" aria-hidden="true" tabindex="-1"></a>      n_updated <span class="ot">&lt;-</span> n_updated <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb29-24"><a href="#cb29-24" aria-hidden="true" tabindex="-1"></a>      <span class="fu">cat</span>(<span class="st">"  Updated:"</span>, mid, <span class="st">"-&gt;"</span>, mlat, <span class="st">","</span>, mlon, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb29-25"><a href="#cb29-25" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb29-26"><a href="#cb29-26" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb29-27"><a href="#cb29-27" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>  Updated: italy_north_rrc -&gt; 45 , 11 
  Updated: italy_central_rrc -&gt; 42.5 , 12.5 
  Updated: italy_southeast_rrc -&gt; 40.5 , 17 
  Updated: sicily2_rrc -&gt; 37.5 , 14 
  Updated: narbo -&gt; 43.1833 , 3 
  Updated: lugdunum -&gt; 45.764 , 4.8357 
  Updated: osca -&gt; 42.14 , -0.4083 </code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Updated"</span>, n_updated, <span class="st">"mints from manual coordinates</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
Updated 7 mints from manual coordinates</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Add any mints from manual_coords that aren't in mint_coords at all</span></span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>existing_ids <span class="ot">&lt;-</span> <span class="fu">c</span>(mint_coords<span class="sc">$</span>mint_id, mint_coords<span class="sc">$</span>mint_id_clean)</span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>existing_ids <span class="ot">&lt;-</span> existing_ids[<span class="sc">!</span><span class="fu">is.na</span>(existing_ids)]</span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a>missing_mints <span class="ot">&lt;-</span> manual_coords <span class="sc">%&gt;%</span></span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span>mint_id <span class="sc">%in%</span> existing_ids, <span class="sc">!</span><span class="fu">is.na</span>(mint_lat))</span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">nrow</span>(missing_mints) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Adding"</span>, <span class="fu">nrow</span>(missing_mints), <span class="st">"new mints from manual coordinates</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb33-9"><a href="#cb33-9" aria-hidden="true" tabindex="-1"></a>  missing_mints <span class="ot">&lt;-</span> missing_mints <span class="sc">%&gt;%</span></span>
<span id="cb33-10"><a href="#cb33-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb33-11"><a href="#cb33-11" aria-hidden="true" tabindex="-1"></a>      <span class="at">mint_uri =</span> <span class="fu">paste0</span>(<span class="st">"http://nomisma.org/id/"</span>, mint_id),</span>
<span id="cb33-12"><a href="#cb33-12" aria-hidden="true" tabindex="-1"></a>      <span class="at">mint_id_clean =</span> mint_id,</span>
<span id="cb33-13"><a href="#cb33-13" aria-hidden="true" tabindex="-1"></a>      <span class="at">n_types =</span> <span class="dv">0</span>,</span>
<span id="cb33-14"><a href="#cb33-14" aria-hidden="true" tabindex="-1"></a>      <span class="at">n_hoards =</span> <span class="dv">0</span></span>
<span id="cb33-15"><a href="#cb33-15" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb33-16"><a href="#cb33-16" aria-hidden="true" tabindex="-1"></a>  mint_coords <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(mint_coords, missing_mints)</span>
<span id="cb33-17"><a href="#cb33-17" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
Adding 60 new mints from manual coordinates</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Report</span></span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>n_with_manual <span class="ot">&lt;-</span> <span class="fu">sum</span>(<span class="sc">!</span><span class="fu">is.na</span>(mint_coords<span class="sc">$</span>mint_lat))</span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"✓ Mints with coordinates (after manual additions):"</span>, n_with_manual, <span class="st">"of"</span>, <span class="fu">nrow</span>(mint_coords), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>✓ Mints with coordinates (after manual additions): 71 of 74 </code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Show which mints now have coordinates</span></span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Mints with coordinates:</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
Mints with coordinates:</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a>mint_coords <span class="sc">%&gt;%</span></span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(mint_lat)) <span class="sc">%&gt;%</span></span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(mint_id, mint_lat, mint_lon, n_types) <span class="sc">%&gt;%</span></span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(n_types)) <span class="sc">%&gt;%</span></span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">head</span>(<span class="dv">20</span>) <span class="sc">%&gt;%</span></span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 20 × 4
   mint_id             mint_lat mint_lon n_types
   &lt;chr&gt;                  &lt;dbl&gt;    &lt;dbl&gt;   &lt;dbl&gt;
 1 rome                    41.9   12.5     28177
 2 narbo                   43.2    3         379
 3 italy_north_rrc         45     11         297
 4 massalia                43.3    5.38       55
 5 italy_southeast_rrc     40.5   17          53
 6 sicily2_rrc             37.5   14          45
 7 apollonia_illyria       40.7   19.5        32
 8 luceria                 41.5   15.3        25
 9 italy_central_rrc       42.5   12.5        24
10 osca                    42.1   -0.408       4
11 lugdunum                45.8    4.84        3
12 roma                    41.9   12.5         0
13 capua                   41.1   14.2         0
14 croton                  39.1   17.1         0
15 crotona                 39.1   17.1         0
16 brundisium              40.6   17.9         0
17 tarentum                40.5   17.2         0
18 venusia                 41.0   15.8         0
19 canusium                41.2   16.1         0
20 hatria                  42.8   14.0         0</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Verify Rome</span></span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a>rome_check <span class="ot">&lt;-</span> mint_coords <span class="sc">%&gt;%</span> <span class="fu">filter</span>(mint_id <span class="sc">==</span> <span class="st">"rome"</span>)</span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">nrow</span>(rome_check) <span class="sc">&gt;</span> <span class="dv">0</span> <span class="sc">&amp;&amp;</span> <span class="sc">!</span><span class="fu">is.na</span>(rome_check<span class="sc">$</span>mint_lat[<span class="dv">1</span>])) {</span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">✓ Rome coordinates verified:"</span>, rome_check<span class="sc">$</span>mint_lat[<span class="dv">1</span>], <span class="st">","</span>, rome_check<span class="sc">$</span>mint_lon[<span class="dv">1</span>], <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
✓ Rome coordinates verified: 41.9 , 12.5 </code></pre>
</div>
</div>
</section>
<section id="classify-mints-into-regions" class="level2" data-number="3.5">
<h2 data-number="3.5" class="anchored" data-anchor-id="classify-mints-into-regions"><span class="header-section-number">3.5</span> 1.5 Classify Mints into Regions</h2>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Debug: check mint_coords state before classification</span></span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"=== DEBUG: State before classification ===</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>=== DEBUG: State before classification ===</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Mints with non-NA mint_lat:</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Mints with non-NA mint_lat:</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a>mint_coords <span class="sc">%&gt;%</span> </span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(mint_lat)) <span class="sc">%&gt;%</span></span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(mint_id, mint_lat, mint_lon, n_types) <span class="sc">%&gt;%</span></span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 71 × 4
   mint_id             mint_lat mint_lon n_types
   &lt;chr&gt;                  &lt;dbl&gt;    &lt;dbl&gt;   &lt;dbl&gt;
 1 rome                    41.9   12.5     28177
 2 narbo                   43.2    3         379
 3 italy_north_rrc         45     11         297
 4 massalia                43.3    5.38       55
 5 italy_southeast_rrc     40.5   17          53
 6 sicily2_rrc             37.5   14          45
 7 apollonia_illyria       40.7   19.5        32
 8 luceria                 41.5   15.3        25
 9 italy_central_rrc       42.5   12.5        24
10 osca                    42.1   -0.408       4
# ℹ 61 more rows</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Define mint regions based on coordinates and known geography</span></span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a>classify_mint_region <span class="ot">&lt;-</span> <span class="cf">function</span>(mint_id, lat, lon) {</span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Handle missing coordinates</span></span>
<span id="cb49-5"><a href="#cb49-5" aria-hidden="true" tabindex="-1"></a> <span class="cf">if</span> (<span class="fu">is.na</span>(lat) <span class="sc">||</span> <span class="fu">is.na</span>(lon)) {</span>
<span id="cb49-6"><a href="#cb49-6" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Try to classify by mint_id patterns</span></span>
<span id="cb49-7"><a href="#cb49-7" aria-hidden="true" tabindex="-1"></a>    id_lower <span class="ot">&lt;-</span> <span class="fu">tolower</span>(mint_id)</span>
<span id="cb49-8"><a href="#cb49-8" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb49-9"><a href="#cb49-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">grepl</span>(<span class="st">"rome|roma"</span>, id_lower)) <span class="fu">return</span>(<span class="st">"ROME"</span>)</span>
<span id="cb49-10"><a href="#cb49-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">grepl</span>(<span class="st">"hispa|spain|iberi|tarraco|carthago_nova|emporiae|osca|sagunt"</span>, id_lower)) <span class="fu">return</span>(<span class="st">"HISP"</span>)</span>
<span id="cb49-11"><a href="#cb49-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">grepl</span>(<span class="st">"gaul|gall|massalia|lugdunum|narbo|vienna"</span>, id_lower)) <span class="fu">return</span>(<span class="st">"GALL"</span>)</span>
<span id="cb49-12"><a href="#cb49-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">grepl</span>(<span class="st">"africa|carthag|utica|cirta|numidia"</span>, id_lower)) <span class="fu">return</span>(<span class="st">"AFRI"</span>)</span>
<span id="cb49-13"><a href="#cb49-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">grepl</span>(<span class="st">"sicil|syracus|panormus|lilyb"</span>, id_lower)) <span class="fu">return</span>(<span class="st">"SICI"</span>)</span>
<span id="cb49-14"><a href="#cb49-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">grepl</span>(<span class="st">"sardinia|sard"</span>, id_lower)) <span class="fu">return</span>(<span class="st">"SICI"</span>)  <span class="co"># Group with Sicily</span></span>
<span id="cb49-15"><a href="#cb49-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">grepl</span>(<span class="st">"macedon|thessal|apollon|dyrr|greece|achae|corinth|athens"</span>, id_lower)) <span class="fu">return</span>(<span class="st">"GREC"</span>)</span>
<span id="cb49-16"><a href="#cb49-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">grepl</span>(<span class="st">"asia|ephes|pergam|antioch|smyrna|sardis"</span>, id_lower)) <span class="fu">return</span>(<span class="st">"ASIA"</span>)</span>
<span id="cb49-17"><a href="#cb49-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">grepl</span>(<span class="st">"pontus|amis|sinop|black"</span>, id_lower)) <span class="fu">return</span>(<span class="st">"PONT"</span>)</span>
<span id="cb49-18"><a href="#cb49-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">grepl</span>(<span class="st">"military|moving|legionary|camp"</span>, id_lower)) <span class="fu">return</span>(<span class="st">"MILI"</span>)</span>
<span id="cb49-19"><a href="#cb49-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">grepl</span>(<span class="st">"uncertain|unknown"</span>, id_lower)) <span class="fu">return</span>(<span class="st">"UNKN"</span>)</span>
<span id="cb49-20"><a href="#cb49-20" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb49-21"><a href="#cb49-21" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Italian mints</span></span>
<span id="cb49-22"><a href="#cb49-22" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">grepl</span>(<span class="st">"capua|luceria|croton|venusia|brund|tarent|canusium|hatria"</span>, id_lower)) <span class="fu">return</span>(<span class="st">"ITAL"</span>)</span>
<span id="cb49-23"><a href="#cb49-23" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb49-24"><a href="#cb49-24" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="st">"UNKN"</span>)</span>
<span id="cb49-25"><a href="#cb49-25" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb49-26"><a href="#cb49-26" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb49-27"><a href="#cb49-27" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Classify by coordinates</span></span>
<span id="cb49-28"><a href="#cb49-28" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Rome</span></span>
<span id="cb49-29"><a href="#cb49-29" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">abs</span>(lat <span class="sc">-</span> <span class="fl">41.9028</span>) <span class="sc">&lt;</span> <span class="fl">0.5</span> <span class="sc">&amp;&amp;</span> <span class="fu">abs</span>(lon <span class="sc">-</span> <span class="fl">12.4964</span>) <span class="sc">&lt;</span> <span class="fl">0.5</span>) {</span>
<span id="cb49-30"><a href="#cb49-30" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">grepl</span>(<span class="st">"rome|roma"</span>, <span class="fu">tolower</span>(mint_id))) <span class="fu">return</span>(<span class="st">"ROME"</span>)</span>
<span id="cb49-31"><a href="#cb49-31" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="st">"ITAL"</span>)  <span class="co"># Other mints near Rome</span></span>
<span id="cb49-32"><a href="#cb49-32" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb49-33"><a href="#cb49-33" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb49-34"><a href="#cb49-34" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Geographic regions</span></span>
<span id="cb49-35"><a href="#cb49-35" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (lon <span class="sc">&lt;</span> <span class="sc">-</span><span class="dv">2</span>) <span class="fu">return</span>(<span class="st">"HISP"</span>)  <span class="co"># Iberia</span></span>
<span id="cb49-36"><a href="#cb49-36" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (lon <span class="sc">&gt;=</span> <span class="sc">-</span><span class="dv">2</span> <span class="sc">&amp;&amp;</span> lon <span class="sc">&lt;</span> <span class="dv">5</span> <span class="sc">&amp;&amp;</span> lat <span class="sc">&gt;</span> <span class="dv">42</span>) <span class="fu">return</span>(<span class="st">"GALL"</span>)  <span class="co"># Gaul</span></span>
<span id="cb49-37"><a href="#cb49-37" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (lat <span class="sc">&lt;</span> <span class="dv">38</span> <span class="sc">&amp;&amp;</span> lon <span class="sc">&gt;=</span> <span class="dv">5</span> <span class="sc">&amp;&amp;</span> lon <span class="sc">&lt;</span> <span class="dv">15</span>) <span class="fu">return</span>(<span class="st">"AFRI"</span>)  <span class="co"># North Africa</span></span>
<span id="cb49-38"><a href="#cb49-38" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (lon <span class="sc">&gt;=</span> <span class="dv">12</span> <span class="sc">&amp;&amp;</span> lon <span class="sc">&lt;</span> <span class="dv">16</span> <span class="sc">&amp;&amp;</span> lat <span class="sc">&gt;=</span> <span class="dv">36</span> <span class="sc">&amp;&amp;</span> lat <span class="sc">&lt;</span> <span class="dv">39</span>) <span class="fu">return</span>(<span class="st">"SICI"</span>)  <span class="co"># Sicily</span></span>
<span id="cb49-39"><a href="#cb49-39" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (lon <span class="sc">&gt;=</span> <span class="dv">6</span> <span class="sc">&amp;&amp;</span> lon <span class="sc">&lt;</span> <span class="dv">12</span> <span class="sc">&amp;&amp;</span> lat <span class="sc">&gt;=</span> <span class="dv">38</span> <span class="sc">&amp;&amp;</span> lat <span class="sc">&lt;</span> <span class="dv">41</span>) <span class="fu">return</span>(<span class="st">"SICI"</span>)  <span class="co"># Sardinia/Corsica</span></span>
<span id="cb49-40"><a href="#cb49-40" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (lon <span class="sc">&gt;=</span> <span class="dv">19</span> <span class="sc">&amp;&amp;</span> lon <span class="sc">&lt;</span> <span class="dv">28</span> <span class="sc">&amp;&amp;</span> lat <span class="sc">&gt;=</span> <span class="dv">35</span> <span class="sc">&amp;&amp;</span> lat <span class="sc">&lt;</span> <span class="dv">43</span>) <span class="fu">return</span>(<span class="st">"GREC"</span>)  <span class="co"># Greece</span></span>
<span id="cb49-41"><a href="#cb49-41" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (lon <span class="sc">&gt;=</span> <span class="dv">28</span> <span class="sc">&amp;&amp;</span> lat <span class="sc">&gt;=</span> <span class="dv">35</span>) <span class="fu">return</span>(<span class="st">"ASIA"</span>)  <span class="co"># Asia Minor</span></span>
<span id="cb49-42"><a href="#cb49-42" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (lon <span class="sc">&gt;=</span> <span class="dv">30</span> <span class="sc">&amp;&amp;</span> lat <span class="sc">&gt;=</span> <span class="dv">40</span>) <span class="fu">return</span>(<span class="st">"PONT"</span>)  <span class="co"># Pontus/Black Sea</span></span>
<span id="cb49-43"><a href="#cb49-43" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (lon <span class="sc">&gt;=</span> <span class="dv">10</span> <span class="sc">&amp;&amp;</span> lon <span class="sc">&lt;</span> <span class="dv">19</span> <span class="sc">&amp;&amp;</span> lat <span class="sc">&gt;=</span> <span class="dv">39</span> <span class="sc">&amp;&amp;</span> lat <span class="sc">&lt;</span> <span class="dv">47</span>) <span class="fu">return</span>(<span class="st">"ITAL"</span>)  <span class="co"># Italy</span></span>
<span id="cb49-44"><a href="#cb49-44" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb49-45"><a href="#cb49-45" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="st">"UNKN"</span>)</span>
<span id="cb49-46"><a href="#cb49-46" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb49-47"><a href="#cb49-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-48"><a href="#cb49-48" aria-hidden="true" tabindex="-1"></a><span class="co"># Apply classification</span></span>
<span id="cb49-49"><a href="#cb49-49" aria-hidden="true" tabindex="-1"></a>mint_coords <span class="ot">&lt;-</span> mint_coords <span class="sc">%&gt;%</span></span>
<span id="cb49-50"><a href="#cb49-50" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb49-51"><a href="#cb49-51" aria-hidden="true" tabindex="-1"></a>    <span class="at">mint_region =</span> <span class="fu">pmap_chr</span>(<span class="fu">list</span>(mint_id, mint_lat, mint_lon), classify_mint_region)</span>
<span id="cb49-52"><a href="#cb49-52" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb49-53"><a href="#cb49-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-54"><a href="#cb49-54" aria-hidden="true" tabindex="-1"></a><span class="co"># Summary by region</span></span>
<span id="cb49-55"><a href="#cb49-55" aria-hidden="true" tabindex="-1"></a>region_summary <span class="ot">&lt;-</span> mint_coords <span class="sc">%&gt;%</span></span>
<span id="cb49-56"><a href="#cb49-56" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(mint_region) <span class="sc">%&gt;%</span></span>
<span id="cb49-57"><a href="#cb49-57" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb49-58"><a href="#cb49-58" aria-hidden="true" tabindex="-1"></a>    <span class="at">n_mints =</span> <span class="fu">n</span>(),</span>
<span id="cb49-59"><a href="#cb49-59" aria-hidden="true" tabindex="-1"></a>    <span class="at">n_types =</span> <span class="fu">sum</span>(n_types),</span>
<span id="cb49-60"><a href="#cb49-60" aria-hidden="true" tabindex="-1"></a>    <span class="at">n_hoards =</span> <span class="fu">sum</span>(n_hoards),</span>
<span id="cb49-61"><a href="#cb49-61" aria-hidden="true" tabindex="-1"></a>    <span class="at">has_coords =</span> <span class="fu">sum</span>(<span class="sc">!</span><span class="fu">is.na</span>(mint_lat)),</span>
<span id="cb49-62"><a href="#cb49-62" aria-hidden="true" tabindex="-1"></a>    <span class="at">.groups =</span> <span class="st">"drop"</span></span>
<span id="cb49-63"><a href="#cb49-63" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb49-64"><a href="#cb49-64" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(n_types))</span>
<span id="cb49-65"><a href="#cb49-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-66"><a href="#cb49-66" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Mint classification summary:</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
Mint classification summary:</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a><span class="fu">kable</span>(region_summary)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<table class="caption-top table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: left;">mint_region</th>
<th style="text-align: right;">n_mints</th>
<th style="text-align: right;">n_types</th>
<th style="text-align: right;">n_hoards</th>
<th style="text-align: right;">has_coords</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">ROME</td>
<td style="text-align: right;">2</td>
<td style="text-align: right;">28177</td>
<td style="text-align: right;">490</td>
<td style="text-align: right;">2</td>
</tr>
<tr class="even">
<td style="text-align: left;">UNKN</td>
<td style="text-align: right;">6</td>
<td style="text-align: right;">2321</td>
<td style="text-align: right;">395</td>
<td style="text-align: right;">4</td>
</tr>
<tr class="odd">
<td style="text-align: left;">ITAL</td>
<td style="text-align: right;">19</td>
<td style="text-align: right;">399</td>
<td style="text-align: right;">234</td>
<td style="text-align: right;">19</td>
</tr>
<tr class="even">
<td style="text-align: left;">GALL</td>
<td style="text-align: right;">8</td>
<td style="text-align: right;">386</td>
<td style="text-align: right;">192</td>
<td style="text-align: right;">8</td>
</tr>
<tr class="odd">
<td style="text-align: left;">AFRI</td>
<td style="text-align: right;">8</td>
<td style="text-align: right;">45</td>
<td style="text-align: right;">34</td>
<td style="text-align: right;">8</td>
</tr>
<tr class="even">
<td style="text-align: left;">GREC</td>
<td style="text-align: right;">17</td>
<td style="text-align: right;">32</td>
<td style="text-align: right;">27</td>
<td style="text-align: right;">17</td>
</tr>
<tr class="odd">
<td style="text-align: left;">SICI</td>
<td style="text-align: right;">5</td>
<td style="text-align: right;">12</td>
<td style="text-align: right;">11</td>
<td style="text-align: right;">4</td>
</tr>
<tr class="even">
<td style="text-align: left;">ASIA</td>
<td style="text-align: right;">7</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">7</td>
</tr>
<tr class="odd">
<td style="text-align: left;">HISP</td>
<td style="text-align: right;">2</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">2</td>
</tr>
</tbody>
</table>
</div>
</div>
</section>
<section id="define-production-periods-25-year-bins" class="level2" data-number="3.6">
<h2 data-number="3.6" class="anchored" data-anchor-id="define-production-periods-25-year-bins"><span class="header-section-number">3.6</span> 1.6 Define Production Periods (25-year bins)</h2>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 25-year production periods</span></span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a><span class="co"># 12 breaks create 11 intervals, so we need 11 labels</span></span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a>period_breaks <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="sc">-</span><span class="cn">Inf</span>, <span class="sc">-</span><span class="dv">200</span>, <span class="sc">-</span><span class="dv">175</span>, <span class="sc">-</span><span class="dv">150</span>, <span class="sc">-</span><span class="dv">125</span>, <span class="sc">-</span><span class="dv">100</span>, <span class="sc">-</span><span class="dv">75</span>, <span class="sc">-</span><span class="dv">50</span>, <span class="sc">-</span><span class="dv">25</span>, <span class="dv">1</span>, <span class="dv">14</span>, <span class="cn">Inf</span>)</span>
<span id="cb52-4"><a href="#cb52-4" aria-hidden="true" tabindex="-1"></a>period_labels <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb52-5"><a href="#cb52-5" aria-hidden="true" tabindex="-1"></a> <span class="st">"P01: pre-200"</span>,</span>
<span id="cb52-6"><a href="#cb52-6" aria-hidden="true" tabindex="-1"></a>  <span class="st">"P02: 200-175"</span>,</span>
<span id="cb52-7"><a href="#cb52-7" aria-hidden="true" tabindex="-1"></a>  <span class="st">"P03: 175-150"</span>, </span>
<span id="cb52-8"><a href="#cb52-8" aria-hidden="true" tabindex="-1"></a>  <span class="st">"P04: 150-125"</span>,</span>
<span id="cb52-9"><a href="#cb52-9" aria-hidden="true" tabindex="-1"></a>  <span class="st">"P05: 125-100"</span>,</span>
<span id="cb52-10"><a href="#cb52-10" aria-hidden="true" tabindex="-1"></a>  <span class="st">"P06: 100-75"</span>,</span>
<span id="cb52-11"><a href="#cb52-11" aria-hidden="true" tabindex="-1"></a>  <span class="st">"P07: 75-50"</span>,</span>
<span id="cb52-12"><a href="#cb52-12" aria-hidden="true" tabindex="-1"></a>  <span class="st">"P08: 50-25"</span>,</span>
<span id="cb52-13"><a href="#cb52-13" aria-hidden="true" tabindex="-1"></a>  <span class="st">"P09: 25-1 BCE"</span>,</span>
<span id="cb52-14"><a href="#cb52-14" aria-hidden="true" tabindex="-1"></a>  <span class="st">"P10: 1-14 CE"</span>,</span>
<span id="cb52-15"><a href="#cb52-15" aria-hidden="true" tabindex="-1"></a>  <span class="st">"P11: post-14 CE"</span></span>
<span id="cb52-16"><a href="#cb52-16" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb52-17"><a href="#cb52-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-18"><a href="#cb52-18" aria-hidden="true" tabindex="-1"></a>period_midpoints <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">225</span>, <span class="sc">-</span><span class="dv">187</span>, <span class="sc">-</span><span class="dv">162</span>, <span class="sc">-</span><span class="dv">137</span>, <span class="sc">-</span><span class="dv">112</span>, <span class="sc">-</span><span class="dv">87</span>, <span class="sc">-</span><span class="dv">62</span>, <span class="sc">-</span><span class="dv">37</span>, <span class="sc">-</span><span class="dv">12</span>, <span class="dv">7</span>, <span class="dv">25</span>)</span>
<span id="cb52-19"><a href="#cb52-19" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(period_midpoints) <span class="ot">&lt;-</span> period_labels</span>
<span id="cb52-20"><a href="#cb52-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-21"><a href="#cb52-21" aria-hidden="true" tabindex="-1"></a><span class="co"># Deposition periods (for TPQ)</span></span>
<span id="cb52-22"><a href="#cb52-22" aria-hidden="true" tabindex="-1"></a>deposition_breaks <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="sc">-</span><span class="cn">Inf</span>, <span class="sc">-</span><span class="dv">150</span>, <span class="sc">-</span><span class="dv">100</span>, <span class="sc">-</span><span class="dv">50</span>, <span class="dv">14</span>, <span class="cn">Inf</span>)</span>
<span id="cb52-23"><a href="#cb52-23" aria-hidden="true" tabindex="-1"></a>deposition_labels <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"Early Republic"</span>, <span class="st">"Late Republic I"</span>, </span>
<span id="cb52-24"><a href="#cb52-24" aria-hidden="true" tabindex="-1"></a>                        <span class="st">"Late Republic II"</span>, <span class="st">"Triumviral/Augustan"</span>, <span class="st">"Early Imperial"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="build-analysis-dataset" class="level2" data-number="3.7">
<h2 data-number="3.7" class="anchored" data-anchor-id="build-analysis-dataset"><span class="header-section-number">3.7</span> 1.7 Build Analysis Dataset</h2>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a><span class="co"># First, ensure mint_coords has mint_id properly set for joining</span></span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a><span class="co"># The coordinates may have come from mint_id_clean (from URI), so unify them</span></span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="st">"mint_id_clean"</span> <span class="sc">%in%</span> <span class="fu">names</span>(mint_coords)) {</span>
<span id="cb53-4"><a href="#cb53-4" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Use mint_id if available, otherwise mint_id_clean</span></span>
<span id="cb53-5"><a href="#cb53-5" aria-hidden="true" tabindex="-1"></a>  mint_coords <span class="ot">&lt;-</span> mint_coords <span class="sc">%&gt;%</span></span>
<span id="cb53-6"><a href="#cb53-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">mint_id =</span> <span class="fu">coalesce</span>(mint_id, mint_id_clean))</span>
<span id="cb53-7"><a href="#cb53-7" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb53-8"><a href="#cb53-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-9"><a href="#cb53-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Debug: show what we're joining</span></span>
<span id="cb53-10"><a href="#cb53-10" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Mints available for joining:</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Mints available for joining:</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"  Total mints:"</span>, <span class="fu">nrow</span>(mint_coords), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>  Total mints: 74 </code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"  With coordinates:"</span>, <span class="fu">sum</span>(<span class="sc">!</span><span class="fu">is.na</span>(mint_coords<span class="sc">$</span>mint_lat)), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>  With coordinates: 71 </code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"  With region:"</span>, <span class="fu">sum</span>(<span class="sc">!</span><span class="fu">is.na</span>(mint_coords<span class="sc">$</span>mint_region)), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>  With region: 74 </code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Show sample of mint_coords</span></span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Sample of mint_coords:</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
Sample of mint_coords:</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb63"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(mint_coords <span class="sc">%&gt;%</span> </span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a>        <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(mint_lat)) <span class="sc">%&gt;%</span></span>
<span id="cb63-3"><a href="#cb63-3" aria-hidden="true" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">select</span>(mint_id, mint_lat, mint_lon, mint_region, n_types) <span class="sc">%&gt;%</span></span>
<span id="cb63-4"><a href="#cb63-4" aria-hidden="true" tabindex="-1"></a>        <span class="fu">head</span>(<span class="dv">10</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 10 × 5
   mint_id             mint_lat mint_lon mint_region n_types
   &lt;chr&gt;                  &lt;dbl&gt;    &lt;dbl&gt; &lt;chr&gt;         &lt;dbl&gt;
 1 rome                    41.9   12.5   ROME          28177
 2 narbo                   43.2    3     GALL            379
 3 italy_north_rrc         45     11     ITAL            297
 4 massalia                43.3    5.38  UNKN             55
 5 italy_southeast_rrc     40.5   17     ITAL             53
 6 sicily2_rrc             37.5   14     AFRI             45
 7 apollonia_illyria       40.7   19.5   GREC             32
 8 luceria                 41.5   15.3   ITAL             25
 9 italy_central_rrc       42.5   12.5   ITAL             24
10 osca                    42.1   -0.408 GALL              4</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb65"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Parse dates and join mint info</span></span>
<span id="cb65-2"><a href="#cb65-2" aria-hidden="true" tabindex="-1"></a>chrr_analysis <span class="ot">&lt;-</span> chrr_raw <span class="sc">%&gt;%</span></span>
<span id="cb65-3"><a href="#cb65-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Parse mint dates</span></span>
<span id="cb65-4"><a href="#cb65-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb65-5"><a href="#cb65-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">mint_start =</span> <span class="fu">as.numeric</span>(start_year),</span>
<span id="cb65-6"><a href="#cb65-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">mint_end =</span> <span class="fu">as.numeric</span>(end_year),</span>
<span id="cb65-7"><a href="#cb65-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">mint_mid =</span> (mint_start <span class="sc">+</span> mint_end) <span class="sc">/</span> <span class="dv">2</span>,</span>
<span id="cb65-8"><a href="#cb65-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">tpq_year =</span> readr<span class="sc">::</span><span class="fu">parse_number</span>(<span class="fu">as.character</span>(hoard_tpq))</span>
<span id="cb65-9"><a href="#cb65-9" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb65-10"><a href="#cb65-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(</span>
<span id="cb65-11"><a href="#cb65-11" aria-hidden="true" tabindex="-1"></a>    <span class="sc">!</span><span class="fu">is.na</span>(mint_mid),</span>
<span id="cb65-12"><a href="#cb65-12" aria-hidden="true" tabindex="-1"></a>    <span class="sc">!</span><span class="fu">is.na</span>(tpq_year),</span>
<span id="cb65-13"><a href="#cb65-13" aria-hidden="true" tabindex="-1"></a>    <span class="sc">!</span><span class="fu">is.na</span>(hoard_lat),</span>
<span id="cb65-14"><a href="#cb65-14" aria-hidden="true" tabindex="-1"></a>    <span class="sc">!</span><span class="fu">is.na</span>(hoard_long)</span>
<span id="cb65-15"><a href="#cb65-15" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb65-16"><a href="#cb65-16" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Assign production period</span></span>
<span id="cb65-17"><a href="#cb65-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb65-18"><a href="#cb65-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">prod_period =</span> <span class="fu">cut</span>(mint_mid, <span class="at">breaks =</span> period_breaks, <span class="at">labels =</span> period_labels, <span class="at">right =</span> <span class="cn">TRUE</span>),</span>
<span id="cb65-19"><a href="#cb65-19" aria-hidden="true" tabindex="-1"></a>    <span class="at">depo_period =</span> <span class="fu">cut</span>(tpq_year, <span class="at">breaks =</span> deposition_breaks, <span class="at">labels =</span> deposition_labels, <span class="at">right =</span> <span class="cn">TRUE</span>)</span>
<span id="cb65-20"><a href="#cb65-20" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb65-21"><a href="#cb65-21" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Join mint coordinates and region</span></span>
<span id="cb65-22"><a href="#cb65-22" aria-hidden="true" tabindex="-1"></a> <span class="fu">left_join</span>(</span>
<span id="cb65-23"><a href="#cb65-23" aria-hidden="true" tabindex="-1"></a>    mint_coords <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">select</span>(mint_id, mint_lat, mint_lon, mint_region),</span>
<span id="cb65-24"><a href="#cb65-24" aria-hidden="true" tabindex="-1"></a>    <span class="at">by =</span> <span class="st">"mint_id"</span></span>
<span id="cb65-25"><a href="#cb65-25" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb65-26"><a href="#cb65-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-27"><a href="#cb65-27" aria-hidden="true" tabindex="-1"></a><span class="co"># Debug: check join success</span></span>
<span id="cb65-28"><a href="#cb65-28" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Join results:</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
Join results:</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb67"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"  Records with mint_lat:"</span>, <span class="fu">sum</span>(<span class="sc">!</span><span class="fu">is.na</span>(chrr_analysis<span class="sc">$</span>mint_lat)), <span class="st">"of"</span>, <span class="fu">nrow</span>(chrr_analysis), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>  Records with mint_lat: 27673 of 29871 </code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb69"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"  Records with mint_region:"</span>, <span class="fu">sum</span>(<span class="sc">!</span><span class="fu">is.na</span>(chrr_analysis<span class="sc">$</span>mint_region)), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>  Records with mint_region: 29871 </code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb71"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Show which mints didn't join</span></span>
<span id="cb71-2"><a href="#cb71-2" aria-hidden="true" tabindex="-1"></a>missing_join <span class="ot">&lt;-</span> chrr_analysis <span class="sc">%&gt;%</span></span>
<span id="cb71-3"><a href="#cb71-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">is.na</span>(mint_lat)) <span class="sc">%&gt;%</span></span>
<span id="cb71-4"><a href="#cb71-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">count</span>(mint_id, <span class="at">sort =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span></span>
<span id="cb71-5"><a href="#cb71-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">head</span>(<span class="dv">10</span>)</span>
<span id="cb71-6"><a href="#cb71-6" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">nrow</span>(missing_join) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb71-7"><a href="#cb71-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Top mints that didn't get coordinates:</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb71-8"><a href="#cb71-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(missing_join)</span>
<span id="cb71-9"><a href="#cb71-9" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
Top mints that didn't get coordinates:
# A tibble: 3 × 2
  mint_id             n
  &lt;chr&gt;           &lt;int&gt;
1 uncertain_value  2183
2 sicily1_rrc        12
3 salpesa             3</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb73"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Now calculate distances</span></span>
<span id="cb73-2"><a href="#cb73-2" aria-hidden="true" tabindex="-1"></a>chrr_analysis <span class="ot">&lt;-</span> chrr_analysis <span class="sc">%&gt;%</span></span>
<span id="cb73-3"><a href="#cb73-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb73-4"><a href="#cb73-4" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Distance from mint to hoard (km)</span></span>
<span id="cb73-5"><a href="#cb73-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">delta_lon_mint =</span> hoard_long <span class="sc">-</span> mint_lon,</span>
<span id="cb73-6"><a href="#cb73-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">delta_lat_mint =</span> hoard_lat <span class="sc">-</span> mint_lat,</span>
<span id="cb73-7"><a href="#cb73-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">dist_from_mint_km =</span> <span class="fu">sqrt</span>(</span>
<span id="cb73-8"><a href="#cb73-8" aria-hidden="true" tabindex="-1"></a>      (delta_lon_mint <span class="sc">*</span> <span class="dv">111</span> <span class="sc">*</span> <span class="fu">cos</span>(mint_lat <span class="sc">*</span> pi<span class="sc">/</span><span class="dv">180</span>))<span class="sc">^</span><span class="dv">2</span> <span class="sc">+</span> </span>
<span id="cb73-9"><a href="#cb73-9" aria-hidden="true" tabindex="-1"></a>      (delta_lat_mint <span class="sc">*</span> <span class="dv">111</span>)<span class="sc">^</span><span class="dv">2</span></span>
<span id="cb73-10"><a href="#cb73-10" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb73-11"><a href="#cb73-11" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb73-12"><a href="#cb73-12" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Bearing from mint to hoard</span></span>
<span id="cb73-13"><a href="#cb73-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">bearing_from_mint_rad =</span> <span class="fu">atan2</span>(</span>
<span id="cb73-14"><a href="#cb73-14" aria-hidden="true" tabindex="-1"></a>      delta_lon_mint <span class="sc">*</span> <span class="fu">cos</span>(mint_lat <span class="sc">*</span> pi<span class="sc">/</span><span class="dv">180</span>), </span>
<span id="cb73-15"><a href="#cb73-15" aria-hidden="true" tabindex="-1"></a>      delta_lat_mint</span>
<span id="cb73-16"><a href="#cb73-16" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb73-17"><a href="#cb73-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">bearing_from_mint_deg =</span> (bearing_from_mint_rad <span class="sc">*</span> <span class="dv">180</span> <span class="sc">/</span> pi <span class="sc">+</span> <span class="dv">360</span>) <span class="sc">%%</span> <span class="dv">360</span>,</span>
<span id="cb73-18"><a href="#cb73-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">cos_bearing_mint =</span> <span class="fu">cos</span>(bearing_from_mint_rad),</span>
<span id="cb73-19"><a href="#cb73-19" aria-hidden="true" tabindex="-1"></a>    <span class="at">sin_bearing_mint =</span> <span class="fu">sin</span>(bearing_from_mint_rad),</span>
<span id="cb73-20"><a href="#cb73-20" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb73-21"><a href="#cb73-21" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Distance from Rome to hoard (for comparison)</span></span>
<span id="cb73-22"><a href="#cb73-22" aria-hidden="true" tabindex="-1"></a>    <span class="at">delta_lon_rome =</span> hoard_long <span class="sc">-</span> rome_lon,</span>
<span id="cb73-23"><a href="#cb73-23" aria-hidden="true" tabindex="-1"></a>    <span class="at">delta_lat_rome =</span> hoard_lat <span class="sc">-</span> rome_lat,</span>
<span id="cb73-24"><a href="#cb73-24" aria-hidden="true" tabindex="-1"></a>    <span class="at">dist_from_rome_km =</span> <span class="fu">sqrt</span>(</span>
<span id="cb73-25"><a href="#cb73-25" aria-hidden="true" tabindex="-1"></a>      (delta_lon_rome <span class="sc">*</span> <span class="dv">111</span> <span class="sc">*</span> <span class="fu">cos</span>(rome_lat <span class="sc">*</span> pi<span class="sc">/</span><span class="dv">180</span>))<span class="sc">^</span><span class="dv">2</span> <span class="sc">+</span> </span>
<span id="cb73-26"><a href="#cb73-26" aria-hidden="true" tabindex="-1"></a>      (delta_lat_rome <span class="sc">*</span> <span class="dv">111</span>)<span class="sc">^</span><span class="dv">2</span></span>
<span id="cb73-27"><a href="#cb73-27" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb73-28"><a href="#cb73-28" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb73-29"><a href="#cb73-29" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Circulation age</span></span>
<span id="cb73-30"><a href="#cb73-30" aria-hidden="true" tabindex="-1"></a>    <span class="at">circ_age =</span> tpq_year <span class="sc">-</span> mint_mid</span>
<span id="cb73-31"><a href="#cb73-31" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb73-32"><a href="#cb73-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(</span>
<span id="cb73-33"><a href="#cb73-33" aria-hidden="true" tabindex="-1"></a>    <span class="sc">!</span><span class="fu">is.na</span>(mint_region),</span>
<span id="cb73-34"><a href="#cb73-34" aria-hidden="true" tabindex="-1"></a>    <span class="sc">!</span><span class="fu">is.na</span>(dist_from_mint_km),</span>
<span id="cb73-35"><a href="#cb73-35" aria-hidden="true" tabindex="-1"></a>    circ_age <span class="sc">&gt;=</span> <span class="dv">0</span>  <span class="co"># Valid circulation time</span></span>
<span id="cb73-36"><a href="#cb73-36" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb73-37"><a href="#cb73-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-38"><a href="#cb73-38" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"✓ Analysis dataset:"</span>, <span class="fu">nrow</span>(chrr_analysis), <span class="st">"coin-type records</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>✓ Analysis dataset: 27641 coin-type records</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb75"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"  With mint coordinates:"</span>, <span class="fu">sum</span>(<span class="sc">!</span><span class="fu">is.na</span>(chrr_analysis<span class="sc">$</span>mint_lat)), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>  With mint coordinates: 27641 </code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb77"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"  Unique hoards:"</span>, <span class="fu">n_distinct</span>(chrr_analysis<span class="sc">$</span>hoard_id), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>  Unique hoards: 461 </code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb79"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb79-1"><a href="#cb79-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"  Unique mints:"</span>, <span class="fu">n_distinct</span>(chrr_analysis<span class="sc">$</span>mint_id), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>  Unique mints: 11 </code></pre>
</div>
</div>
</section>
<section id="aggregate-to-hoard-mint-level" class="level2" data-number="3.8">
<h2 data-number="3.8" class="anchored" data-anchor-id="aggregate-to-hoard-mint-level"><span class="header-section-number">3.8</span> 1.8 Aggregate to Hoard-Mint Level</h2>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb81"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb81-1"><a href="#cb81-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Aggregate: count of each mint-region in each hoard</span></span>
<span id="cb81-2"><a href="#cb81-2" aria-hidden="true" tabindex="-1"></a>hoard_mint <span class="ot">&lt;-</span> chrr_analysis <span class="sc">%&gt;%</span></span>
<span id="cb81-3"><a href="#cb81-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(</span>
<span id="cb81-4"><a href="#cb81-4" aria-hidden="true" tabindex="-1"></a>    hoard_id, hoard_lat, hoard_long, tpq_year, depo_period,</span>
<span id="cb81-5"><a href="#cb81-5" aria-hidden="true" tabindex="-1"></a>    mint_region, mint_lat, mint_lon</span>
<span id="cb81-6"><a href="#cb81-6" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb81-7"><a href="#cb81-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb81-8"><a href="#cb81-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">n_types =</span> <span class="fu">n</span>(),</span>
<span id="cb81-9"><a href="#cb81-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">mean_circ_age =</span> <span class="fu">mean</span>(circ_age, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb81-10"><a href="#cb81-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">.groups =</span> <span class="st">"drop"</span></span>
<span id="cb81-11"><a href="#cb81-11" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb81-12"><a href="#cb81-12" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Recalculate distances at aggregated level</span></span>
<span id="cb81-13"><a href="#cb81-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb81-14"><a href="#cb81-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">dist_from_mint_km =</span> <span class="fu">sqrt</span>(</span>
<span id="cb81-15"><a href="#cb81-15" aria-hidden="true" tabindex="-1"></a>      ((hoard_long <span class="sc">-</span> mint_lon) <span class="sc">*</span> <span class="dv">111</span> <span class="sc">*</span> <span class="fu">cos</span>(mint_lat <span class="sc">*</span> pi<span class="sc">/</span><span class="dv">180</span>))<span class="sc">^</span><span class="dv">2</span> <span class="sc">+</span> </span>
<span id="cb81-16"><a href="#cb81-16" aria-hidden="true" tabindex="-1"></a>      ((hoard_lat <span class="sc">-</span> mint_lat) <span class="sc">*</span> <span class="dv">111</span>)<span class="sc">^</span><span class="dv">2</span></span>
<span id="cb81-17"><a href="#cb81-17" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb81-18"><a href="#cb81-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">bearing_rad =</span> <span class="fu">atan2</span>(</span>
<span id="cb81-19"><a href="#cb81-19" aria-hidden="true" tabindex="-1"></a>      (hoard_long <span class="sc">-</span> mint_lon) <span class="sc">*</span> <span class="fu">cos</span>(mint_lat <span class="sc">*</span> pi<span class="sc">/</span><span class="dv">180</span>),</span>
<span id="cb81-20"><a href="#cb81-20" aria-hidden="true" tabindex="-1"></a>      hoard_lat <span class="sc">-</span> mint_lat</span>
<span id="cb81-21"><a href="#cb81-21" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb81-22"><a href="#cb81-22" aria-hidden="true" tabindex="-1"></a>    <span class="at">cos_bearing =</span> <span class="fu">cos</span>(bearing_rad),</span>
<span id="cb81-23"><a href="#cb81-23" aria-hidden="true" tabindex="-1"></a>    <span class="at">sin_bearing =</span> <span class="fu">sin</span>(bearing_rad)</span>
<span id="cb81-24"><a href="#cb81-24" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb81-25"><a href="#cb81-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-26"><a href="#cb81-26" aria-hidden="true" tabindex="-1"></a><span class="co"># Get hoard totals</span></span>
<span id="cb81-27"><a href="#cb81-27" aria-hidden="true" tabindex="-1"></a>hoard_totals <span class="ot">&lt;-</span> hoard_mint <span class="sc">%&gt;%</span></span>
<span id="cb81-28"><a href="#cb81-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(hoard_id) <span class="sc">%&gt;%</span></span>
<span id="cb81-29"><a href="#cb81-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">n_total =</span> <span class="fu">sum</span>(n_types), <span class="at">.groups =</span> <span class="st">"drop"</span>)</span>
<span id="cb81-30"><a href="#cb81-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-31"><a href="#cb81-31" aria-hidden="true" tabindex="-1"></a>hoard_mint <span class="ot">&lt;-</span> hoard_mint <span class="sc">%&gt;%</span></span>
<span id="cb81-32"><a href="#cb81-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(hoard_totals, <span class="at">by =</span> <span class="st">"hoard_id"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb81-33"><a href="#cb81-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">prop_mint =</span> n_types <span class="sc">/</span> n_total)</span>
<span id="cb81-34"><a href="#cb81-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-35"><a href="#cb81-35" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"✓ Hoard-mint aggregation:"</span>, <span class="fu">nrow</span>(hoard_mint), <span class="st">"records</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>✓ Hoard-mint aggregation: 970 records</code></pre>
</div>
</div>
<hr>
</section>
</section>
<section id="chunk-2-exploratory-analysis" class="level1" data-number="4">
<h1 data-number="4"><span class="header-section-number">4</span> CHUNK 2: Exploratory Analysis</h1>
<section id="map-mint-locations-by-region" class="level2" data-number="4.1">
<h2 data-number="4.1" class="anchored" data-anchor-id="map-mint-locations-by-region"><span class="header-section-number">4.1</span> 2.1 Map Mint Locations by Region</h2>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb83"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb83-1"><a href="#cb83-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(rnaturalearth)</span>
<span id="cb83-2"><a href="#cb83-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(rnaturalearthdata)</span>
<span id="cb83-3"><a href="#cb83-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb83-4"><a href="#cb83-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Debug: check mint_coords state at map time</span></span>
<span id="cb83-5"><a href="#cb83-5" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"=== DEBUG: mint_coords at map time ===</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>=== DEBUG: mint_coords at map time ===</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb85"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb85-1"><a href="#cb85-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Total mints:"</span>, <span class="fu">nrow</span>(mint_coords), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Total mints: 74 </code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb87"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb87-1"><a href="#cb87-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"With coordinates:"</span>, <span class="fu">sum</span>(<span class="sc">!</span><span class="fu">is.na</span>(mint_coords<span class="sc">$</span>mint_lat)), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>With coordinates: 71 </code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb89"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb89-1"><a href="#cb89-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Unique regions:"</span>, <span class="fu">unique</span>(mint_coords<span class="sc">$</span>mint_region), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Unique regions: ROME UNKN GALL ITAL AFRI GREC SICI HISP ASIA </code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb91"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb91-1"><a href="#cb91-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Get basemap</span></span>
<span id="cb91-2"><a href="#cb91-2" aria-hidden="true" tabindex="-1"></a>land <span class="ot">&lt;-</span> <span class="fu">ne_countries</span>(<span class="at">scale =</span> <span class="st">"medium"</span>, <span class="at">returnclass =</span> <span class="st">"sf"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb91-3"><a href="#cb91-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_union</span>()</span>
<span id="cb91-4"><a href="#cb91-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-5"><a href="#cb91-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Mint locations</span></span>
<span id="cb91-6"><a href="#cb91-6" aria-hidden="true" tabindex="-1"></a>mint_sf <span class="ot">&lt;-</span> mint_coords <span class="sc">%&gt;%</span></span>
<span id="cb91-7"><a href="#cb91-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(mint_lat), <span class="sc">!</span><span class="fu">is.na</span>(mint_lon)) <span class="sc">%&gt;%</span></span>
<span id="cb91-8"><a href="#cb91-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_as_sf</span>(<span class="at">coords =</span> <span class="fu">c</span>(<span class="st">"mint_lon"</span>, <span class="st">"mint_lat"</span>), <span class="at">crs =</span> <span class="dv">4326</span>, <span class="at">remove =</span> <span class="cn">FALSE</span>)</span>
<span id="cb91-9"><a href="#cb91-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-10"><a href="#cb91-10" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"mint_sf has"</span>, <span class="fu">nrow</span>(mint_sf), <span class="st">"rows</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>mint_sf has 71 rows</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb93"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb93-1"><a href="#cb93-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Color palette for regions</span></span>
<span id="cb93-2"><a href="#cb93-2" aria-hidden="true" tabindex="-1"></a>region_colors <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb93-3"><a href="#cb93-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">"ROME"</span> <span class="ot">=</span> <span class="st">"#E41A1C"</span>,</span>
<span id="cb93-4"><a href="#cb93-4" aria-hidden="true" tabindex="-1"></a>  <span class="st">"ITAL"</span> <span class="ot">=</span> <span class="st">"#FF7F00"</span>,</span>
<span id="cb93-5"><a href="#cb93-5" aria-hidden="true" tabindex="-1"></a>  <span class="st">"HISP"</span> <span class="ot">=</span> <span class="st">"#377EB8"</span>,</span>
<span id="cb93-6"><a href="#cb93-6" aria-hidden="true" tabindex="-1"></a>  <span class="st">"GALL"</span> <span class="ot">=</span> <span class="st">"#4DAF4A"</span>,</span>
<span id="cb93-7"><a href="#cb93-7" aria-hidden="true" tabindex="-1"></a>  <span class="st">"AFRI"</span> <span class="ot">=</span> <span class="st">"#984EA3"</span>,</span>
<span id="cb93-8"><a href="#cb93-8" aria-hidden="true" tabindex="-1"></a>  <span class="st">"SICI"</span> <span class="ot">=</span> <span class="st">"#FFFF33"</span>,</span>
<span id="cb93-9"><a href="#cb93-9" aria-hidden="true" tabindex="-1"></a>  <span class="st">"GREC"</span> <span class="ot">=</span> <span class="st">"#A65628"</span>,</span>
<span id="cb93-10"><a href="#cb93-10" aria-hidden="true" tabindex="-1"></a>  <span class="st">"ASIA"</span> <span class="ot">=</span> <span class="st">"#F781BF"</span>,</span>
<span id="cb93-11"><a href="#cb93-11" aria-hidden="true" tabindex="-1"></a>  <span class="st">"PONT"</span> <span class="ot">=</span> <span class="st">"#999999"</span>,</span>
<span id="cb93-12"><a href="#cb93-12" aria-hidden="true" tabindex="-1"></a>  <span class="st">"MILI"</span> <span class="ot">=</span> <span class="st">"#000000"</span>,</span>
<span id="cb93-13"><a href="#cb93-13" aria-hidden="true" tabindex="-1"></a>  <span class="st">"UNKN"</span> <span class="ot">=</span> <span class="st">"#CCCCCC"</span></span>
<span id="cb93-14"><a href="#cb93-14" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb93-15"><a href="#cb93-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-16"><a href="#cb93-16" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb93-17"><a href="#cb93-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> land, <span class="at">fill =</span> <span class="st">"grey95"</span>, <span class="at">color =</span> <span class="st">"grey70"</span>) <span class="sc">+</span></span>
<span id="cb93-18"><a href="#cb93-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> mint_sf, <span class="fu">aes</span>(<span class="at">color =</span> mint_region, <span class="at">size =</span> n_types), <span class="at">alpha =</span> <span class="fl">0.7</span>) <span class="sc">+</span></span>
<span id="cb93-19"><a href="#cb93-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values =</span> region_colors, <span class="at">name =</span> <span class="st">"Mint Region"</span>) <span class="sc">+</span></span>
<span id="cb93-20"><a href="#cb93-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_size_continuous</span>(<span class="at">name =</span> <span class="st">"N Types"</span>, <span class="at">range =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">10</span>), <span class="at">trans =</span> <span class="st">"sqrt"</span>) <span class="sc">+</span></span>
<span id="cb93-21"><a href="#cb93-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_sf</span>(<span class="at">xlim =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">10</span>, <span class="dv">45</span>), <span class="at">ylim =</span> <span class="fu">c</span>(<span class="dv">30</span>, <span class="dv">55</span>)) <span class="sc">+</span></span>
<span id="cb93-22"><a href="#cb93-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb93-23"><a href="#cb93-23" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Mint Locations by Region"</span>,</span>
<span id="cb93-24"><a href="#cb93-24" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="fu">paste</span>(<span class="fu">sum</span>(<span class="sc">!</span><span class="fu">is.na</span>(mint_coords<span class="sc">$</span>mint_lat)), <span class="st">"mints with coordinates"</span>)</span>
<span id="cb93-25"><a href="#cb93-25" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb93-26"><a href="#cb93-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb93-27"><a href="#cb93-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">axis.text =</span> <span class="fu">element_blank</span>(), <span class="at">axis.title =</span> <span class="fu">element_blank</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="circulation_model_files/figure-html/map-mints-1.png" class="img-fluid figure-img" width="1152"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="production-volume-by-region-and-period" class="level2" data-number="4.2">
<h2 data-number="4.2" class="anchored" data-anchor-id="production-volume-by-region-and-period"><span class="header-section-number">4.2</span> 2.2 Production Volume by Region and Period</h2>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb94"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb94-1"><a href="#cb94-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Count types by mint region and production period</span></span>
<span id="cb94-2"><a href="#cb94-2" aria-hidden="true" tabindex="-1"></a>production <span class="ot">&lt;-</span> chrr_analysis <span class="sc">%&gt;%</span></span>
<span id="cb94-3"><a href="#cb94-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(mint_region <span class="sc">!=</span> <span class="st">"UNKN"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb94-4"><a href="#cb94-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(mint_region, prod_period) <span class="sc">%&gt;%</span></span>
<span id="cb94-5"><a href="#cb94-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">n_types =</span> <span class="fu">n</span>(), <span class="at">.groups =</span> <span class="st">"drop"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb94-6"><a href="#cb94-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">complete</span>(mint_region, prod_period, <span class="at">fill =</span> <span class="fu">list</span>(<span class="at">n_types =</span> <span class="dv">0</span>))</span>
<span id="cb94-7"><a href="#cb94-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-8"><a href="#cb94-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Heatmap</span></span>
<span id="cb94-9"><a href="#cb94-9" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(production, <span class="fu">aes</span>(<span class="at">x =</span> prod_period, <span class="at">y =</span> mint_region, <span class="at">fill =</span> n_types)) <span class="sc">+</span></span>
<span id="cb94-10"><a href="#cb94-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_tile</span>(<span class="at">color =</span> <span class="st">"white"</span>) <span class="sc">+</span></span>
<span id="cb94-11"><a href="#cb94-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_text</span>(<span class="fu">aes</span>(<span class="at">label =</span> <span class="fu">ifelse</span>(n_types <span class="sc">&gt;</span> <span class="dv">0</span>, n_types, <span class="st">""</span>)), <span class="at">size =</span> <span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb94-12"><a href="#cb94-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_viridis_c</span>(<span class="at">option =</span> <span class="st">"plasma"</span>, <span class="at">name =</span> <span class="st">"N Types"</span>, <span class="at">trans =</span> <span class="st">"sqrt"</span>) <span class="sc">+</span></span>
<span id="cb94-13"><a href="#cb94-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb94-14"><a href="#cb94-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Coin Production by Mint Region and Period"</span>,</span>
<span id="cb94-15"><a href="#cb94-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Production Period"</span>,</span>
<span id="cb94-16"><a href="#cb94-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Mint Region"</span></span>
<span id="cb94-17"><a href="#cb94-17" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb94-18"><a href="#cb94-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb94-19"><a href="#cb94-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">angle =</span> <span class="dv">45</span>, <span class="at">hjust =</span> <span class="dv">1</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="circulation_model_files/figure-html/production-volume-1.png" class="img-fluid figure-img" width="1344"></p>
</figure>
</div>
</div>
</div>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb95"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb95-1"><a href="#cb95-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Time series of production</span></span>
<span id="cb95-2"><a href="#cb95-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(production, <span class="fu">aes</span>(<span class="at">x =</span> prod_period, <span class="at">y =</span> n_types, <span class="at">fill =</span> mint_region)) <span class="sc">+</span></span>
<span id="cb95-3"><a href="#cb95-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_col</span>(<span class="at">position =</span> <span class="st">"stack"</span>) <span class="sc">+</span></span>
<span id="cb95-4"><a href="#cb95-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> region_colors, <span class="at">name =</span> <span class="st">"Mint Region"</span>) <span class="sc">+</span></span>
<span id="cb95-5"><a href="#cb95-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb95-6"><a href="#cb95-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Coin Production Over Time"</span>,</span>
<span id="cb95-7"><a href="#cb95-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Production Period"</span>,</span>
<span id="cb95-8"><a href="#cb95-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Number of Coin Types"</span></span>
<span id="cb95-9"><a href="#cb95-9" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb95-10"><a href="#cb95-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb95-11"><a href="#cb95-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">angle =</span> <span class="dv">45</span>, <span class="at">hjust =</span> <span class="dv">1</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="circulation_model_files/figure-html/production-timeseries-1.png" class="img-fluid figure-img" width="1152"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="distance-distributions-by-mint-region" class="level2" data-number="4.3">
<h2 data-number="4.3" class="anchored" data-anchor-id="distance-distributions-by-mint-region"><span class="header-section-number">4.3</span> 2.3 Distance Distributions by Mint Region</h2>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb96"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb96-1"><a href="#cb96-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Filter to regions with enough data</span></span>
<span id="cb96-2"><a href="#cb96-2" aria-hidden="true" tabindex="-1"></a>major_regions <span class="ot">&lt;-</span> hoard_mint <span class="sc">%&gt;%</span></span>
<span id="cb96-3"><a href="#cb96-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(mint_region <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"ROME"</span>, <span class="st">"HISP"</span>, <span class="st">"GALL"</span>, <span class="st">"GREC"</span>, <span class="st">"ASIA"</span>, <span class="st">"ITAL"</span>, <span class="st">"SICI"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb96-4"><a href="#cb96-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(dist_from_mint_km))</span>
<span id="cb96-5"><a href="#cb96-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb96-6"><a href="#cb96-6" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(major_regions, <span class="fu">aes</span>(<span class="at">x =</span> dist_from_mint_km, <span class="at">fill =</span> mint_region)) <span class="sc">+</span></span>
<span id="cb96-7"><a href="#cb96-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(<span class="at">bins =</span> <span class="dv">30</span>, <span class="at">alpha =</span> <span class="fl">0.7</span>, <span class="at">color =</span> <span class="st">"white"</span>) <span class="sc">+</span></span>
<span id="cb96-8"><a href="#cb96-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>mint_region, <span class="at">scales =</span> <span class="st">"free_y"</span>, <span class="at">ncol =</span> <span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb96-9"><a href="#cb96-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> region_colors) <span class="sc">+</span></span>
<span id="cb96-10"><a href="#cb96-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb96-11"><a href="#cb96-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"How Far Did Coins Travel from Their Mint?"</span>,</span>
<span id="cb96-12"><a href="#cb96-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Distance from mint (km)"</span>,</span>
<span id="cb96-13"><a href="#cb96-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Count"</span></span>
<span id="cb96-14"><a href="#cb96-14" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb96-15"><a href="#cb96-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb96-16"><a href="#cb96-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"none"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="circulation_model_files/figure-html/distance-distributions-1.png" class="img-fluid figure-img" width="1344"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="distance-vs-proportion-by-mint-region" class="level2" data-number="4.4">
<h2 data-number="4.4" class="anchored" data-anchor-id="distance-vs-proportion-by-mint-region"><span class="header-section-number">4.4</span> 2.4 Distance vs Proportion by Mint Region</h2>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb97"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb97-1"><a href="#cb97-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(major_regions, <span class="fu">aes</span>(<span class="at">x =</span> dist_from_mint_km, <span class="at">y =</span> prop_mint)) <span class="sc">+</span></span>
<span id="cb97-2"><a href="#cb97-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">alpha =</span> <span class="fl">0.3</span>, <span class="at">size =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb97-3"><a href="#cb97-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_smooth</span>(<span class="at">method =</span> <span class="st">"glm"</span>, <span class="at">method.args =</span> <span class="fu">list</span>(<span class="at">family =</span> <span class="st">"quasibinomial"</span>),</span>
<span id="cb97-4"><a href="#cb97-4" aria-hidden="true" tabindex="-1"></a>              <span class="at">color =</span> <span class="st">"darkred"</span>, <span class="at">se =</span> <span class="cn">TRUE</span>) <span class="sc">+</span></span>
<span id="cb97-5"><a href="#cb97-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>mint_region, <span class="at">scales =</span> <span class="st">"free"</span>, <span class="at">ncol =</span> <span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb97-6"><a href="#cb97-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">labels =</span> scales<span class="sc">::</span><span class="fu">percent_format</span>()) <span class="sc">+</span></span>
<span id="cb97-7"><a href="#cb97-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb97-8"><a href="#cb97-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Mint Proportion vs Distance from Mint"</span>,</span>
<span id="cb97-9"><a href="#cb97-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"How does a mint's share decline with distance from its source?"</span>,</span>
<span id="cb97-10"><a href="#cb97-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Distance from mint (km)"</span>,</span>
<span id="cb97-11"><a href="#cb97-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Proportion of hoard from this mint"</span></span>
<span id="cb97-12"><a href="#cb97-12" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb97-13"><a href="#cb97-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="circulation_model_files/figure-html/distance-proportion-1.png" class="img-fluid figure-img" width="1344"></p>
</figure>
</div>
</div>
</div>
<hr>
</section>
</section>
<section id="chunk-3-diffusion-model-fitting" class="level1" data-number="5">
<h1 data-number="5"><span class="header-section-number">5</span> CHUNK 3: Diffusion Model Fitting</h1>
<section id="prepare-modeling-data" class="level2" data-number="5.1">
<h2 data-number="5.1" class="anchored" data-anchor-id="prepare-modeling-data"><span class="header-section-number">5.1</span> 3.1 Prepare Modeling Data</h2>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb98"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb98-1"><a href="#cb98-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Debug: check hoard_mint before filtering</span></span>
<span id="cb98-2"><a href="#cb98-2" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"=== DEBUG: hoard_mint before model filtering ===</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>=== DEBUG: hoard_mint before model filtering ===</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb100"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb100-1"><a href="#cb100-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Total rows:"</span>, <span class="fu">nrow</span>(hoard_mint), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Total rows: 970 </code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb102"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb102-1"><a href="#cb102-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Unique regions:"</span>, <span class="fu">unique</span>(hoard_mint<span class="sc">$</span>mint_region), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Unique regions: ITAL ROME GALL GREC UNKN AFRI </code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb104"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb104-1"><a href="#cb104-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Rows by region:</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Rows by region:</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb106"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb106-1"><a href="#cb106-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">table</span>(hoard_mint<span class="sc">$</span>mint_region))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
AFRI GALL GREC ITAL ROME UNKN 
  34  181   24  225  461   45 </code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb108"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb108-1"><a href="#cb108-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Rows with valid dist_from_mint_km:"</span>, <span class="fu">sum</span>(<span class="sc">!</span><span class="fu">is.na</span>(hoard_mint<span class="sc">$</span>dist_from_mint_km)), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
Rows with valid dist_from_mint_km: 970 </code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb110"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb110-1"><a href="#cb110-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Rows with valid cos_bearing:"</span>, <span class="fu">sum</span>(<span class="sc">!</span><span class="fu">is.na</span>(hoard_mint<span class="sc">$</span>cos_bearing)), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Rows with valid cos_bearing: 970 </code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb112"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb112-1"><a href="#cb112-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create modeling dataset with required columns</span></span>
<span id="cb112-2"><a href="#cb112-2" aria-hidden="true" tabindex="-1"></a>model_data <span class="ot">&lt;-</span> hoard_mint <span class="sc">%&gt;%</span></span>
<span id="cb112-3"><a href="#cb112-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(</span>
<span id="cb112-4"><a href="#cb112-4" aria-hidden="true" tabindex="-1"></a>    mint_region <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"ROME"</span>, <span class="st">"HISP"</span>, <span class="st">"GALL"</span>, <span class="st">"GREC"</span>, <span class="st">"ASIA"</span>, <span class="st">"ITAL"</span>, <span class="st">"SICI"</span>, <span class="st">"AFRI"</span>),</span>
<span id="cb112-5"><a href="#cb112-5" aria-hidden="true" tabindex="-1"></a>    <span class="sc">!</span><span class="fu">is.na</span>(dist_from_mint_km),</span>
<span id="cb112-6"><a href="#cb112-6" aria-hidden="true" tabindex="-1"></a>    <span class="sc">!</span><span class="fu">is.na</span>(cos_bearing),</span>
<span id="cb112-7"><a href="#cb112-7" aria-hidden="true" tabindex="-1"></a>    n_total <span class="sc">&gt;=</span> <span class="dv">5</span>  <span class="co"># Minimum hoard size</span></span>
<span id="cb112-8"><a href="#cb112-8" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb112-9"><a href="#cb112-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb112-10"><a href="#cb112-10" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Scale distance for numerical stability</span></span>
<span id="cb112-11"><a href="#cb112-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">dist_scaled =</span> dist_from_mint_km <span class="sc">/</span> <span class="dv">1000</span>,  <span class="co"># Units of 1000 km</span></span>
<span id="cb112-12"><a href="#cb112-12" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb112-13"><a href="#cb112-13" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Log transform for age (add 1 to avoid log(0))</span></span>
<span id="cb112-14"><a href="#cb112-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">log_circ_age =</span> <span class="fu">log</span>(mean_circ_age <span class="sc">+</span> <span class="dv">1</span>),</span>
<span id="cb112-15"><a href="#cb112-15" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb112-16"><a href="#cb112-16" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Ensure factors</span></span>
<span id="cb112-17"><a href="#cb112-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">mint_region =</span> <span class="fu">factor</span>(mint_region),</span>
<span id="cb112-18"><a href="#cb112-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">hoard_id =</span> <span class="fu">factor</span>(hoard_id)</span>
<span id="cb112-19"><a href="#cb112-19" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb112-20"><a href="#cb112-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb112-21"><a href="#cb112-21" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">=== After filtering ===</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
=== After filtering ===</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb114"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb114-1"><a href="#cb114-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Model data:"</span>, <span class="fu">nrow</span>(model_data), <span class="st">"observations</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Model data: 885 observations</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb116"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb116-1"><a href="#cb116-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Mint regions:"</span>, <span class="fu">levels</span>(model_data<span class="sc">$</span>mint_region), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Mint regions: AFRI GALL GREC ITAL ROME </code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb118"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb118-1"><a href="#cb118-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Rows by region:</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Rows by region:</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb120"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb120-1"><a href="#cb120-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">table</span>(model_data<span class="sc">$</span>mint_region))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
AFRI GALL GREC ITAL ROME 
  34  180   24  224  423 </code></pre>
</div>
</div>
</section>
<section id="independent-models-by-mint-region" class="level2" data-number="5.2">
<h2 data-number="5.2" class="anchored" data-anchor-id="independent-models-by-mint-region"><span class="header-section-number">5.2</span> 3.2 Independent Models by Mint Region</h2>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb122"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb122-1"><a href="#cb122-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Fit separate logistic models for each mint region</span></span>
<span id="cb122-2"><a href="#cb122-2" aria-hidden="true" tabindex="-1"></a>fit_region_model <span class="ot">&lt;-</span> <span class="cf">function</span>(data, region) {</span>
<span id="cb122-3"><a href="#cb122-3" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb122-4"><a href="#cb122-4" aria-hidden="true" tabindex="-1"></a>  region_data <span class="ot">&lt;-</span> data <span class="sc">%&gt;%</span> <span class="fu">filter</span>(mint_region <span class="sc">==</span> region)</span>
<span id="cb122-5"><a href="#cb122-5" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb122-6"><a href="#cb122-6" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">nrow</span>(region_data) <span class="sc">&lt;</span> <span class="dv">30</span>) {</span>
<span id="cb122-7"><a href="#cb122-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="cn">NULL</span>)</span>
<span id="cb122-8"><a href="#cb122-8" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb122-9"><a href="#cb122-9" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb122-10"><a href="#cb122-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tryCatch</span>({</span>
<span id="cb122-11"><a href="#cb122-11" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Fit GLM with binomial-like weights</span></span>
<span id="cb122-12"><a href="#cb122-12" aria-hidden="true" tabindex="-1"></a>    model <span class="ot">&lt;-</span> <span class="fu">glm</span>(</span>
<span id="cb122-13"><a href="#cb122-13" aria-hidden="true" tabindex="-1"></a>      prop_mint <span class="sc">~</span> dist_scaled <span class="sc">+</span> cos_bearing <span class="sc">+</span> sin_bearing,</span>
<span id="cb122-14"><a href="#cb122-14" aria-hidden="true" tabindex="-1"></a>      <span class="at">data =</span> region_data,</span>
<span id="cb122-15"><a href="#cb122-15" aria-hidden="true" tabindex="-1"></a>      <span class="at">family =</span> <span class="fu">quasibinomial</span>(<span class="at">link =</span> <span class="st">"logit"</span>),</span>
<span id="cb122-16"><a href="#cb122-16" aria-hidden="true" tabindex="-1"></a>      <span class="at">weights =</span> n_total</span>
<span id="cb122-17"><a href="#cb122-17" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb122-18"><a href="#cb122-18" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb122-19"><a href="#cb122-19" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(model)</span>
<span id="cb122-20"><a href="#cb122-20" aria-hidden="true" tabindex="-1"></a>  }, <span class="at">error =</span> <span class="cf">function</span>(e) {</span>
<span id="cb122-21"><a href="#cb122-21" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="cn">NULL</span>)</span>
<span id="cb122-22"><a href="#cb122-22" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb122-23"><a href="#cb122-23" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb122-24"><a href="#cb122-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb122-25"><a href="#cb122-25" aria-hidden="true" tabindex="-1"></a><span class="co"># Fit models</span></span>
<span id="cb122-26"><a href="#cb122-26" aria-hidden="true" tabindex="-1"></a>regions <span class="ot">&lt;-</span> <span class="fu">unique</span>(model_data<span class="sc">$</span>mint_region)</span>
<span id="cb122-27"><a href="#cb122-27" aria-hidden="true" tabindex="-1"></a>region_models <span class="ot">&lt;-</span> <span class="fu">setNames</span>(</span>
<span id="cb122-28"><a href="#cb122-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lapply</span>(regions, <span class="cf">function</span>(r) <span class="fu">fit_region_model</span>(model_data, r)),</span>
<span id="cb122-29"><a href="#cb122-29" aria-hidden="true" tabindex="-1"></a>  regions</span>
<span id="cb122-30"><a href="#cb122-30" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb122-31"><a href="#cb122-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb122-32"><a href="#cb122-32" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract coefficients</span></span>
<span id="cb122-33"><a href="#cb122-33" aria-hidden="true" tabindex="-1"></a>region_coefs <span class="ot">&lt;-</span> <span class="fu">map_dfr</span>(<span class="fu">names</span>(region_models), <span class="cf">function</span>(r) {</span>
<span id="cb122-34"><a href="#cb122-34" aria-hidden="true" tabindex="-1"></a>  model <span class="ot">&lt;-</span> region_models[[r]]</span>
<span id="cb122-35"><a href="#cb122-35" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.null</span>(model)) <span class="fu">return</span>(<span class="cn">NULL</span>)</span>
<span id="cb122-36"><a href="#cb122-36" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb122-37"><a href="#cb122-37" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tidy</span>(model) <span class="sc">%&gt;%</span></span>
<span id="cb122-38"><a href="#cb122-38" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">mint_region =</span> r)</span>
<span id="cb122-39"><a href="#cb122-39" aria-hidden="true" tabindex="-1"></a>}) <span class="sc">%&gt;%</span></span>
<span id="cb122-40"><a href="#cb122-40" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(estimate))</span>
<span id="cb122-41"><a href="#cb122-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb122-42"><a href="#cb122-42" aria-hidden="true" tabindex="-1"></a><span class="co"># Display distance decay coefficients</span></span>
<span id="cb122-43"><a href="#cb122-43" aria-hidden="true" tabindex="-1"></a>distance_effects <span class="ot">&lt;-</span> region_coefs <span class="sc">%&gt;%</span></span>
<span id="cb122-44"><a href="#cb122-44" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(term <span class="sc">==</span> <span class="st">"dist_scaled"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb122-45"><a href="#cb122-45" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(estimate)</span>
<span id="cb122-46"><a href="#cb122-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb122-47"><a href="#cb122-47" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Distance decay coefficients by region:</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
Distance decay coefficients by region:</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb124"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb124-1"><a href="#cb124-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"(More negative = stronger decay with distance)</span><span class="sc">\n\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>(More negative = stronger decay with distance)</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb126"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb126-1"><a href="#cb126-1" aria-hidden="true" tabindex="-1"></a><span class="fu">kable</span>(distance_effects <span class="sc">%&gt;%</span> </span>
<span id="cb126-2"><a href="#cb126-2" aria-hidden="true" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">select</span>(mint_region, estimate, std.error, p.value) <span class="sc">%&gt;%</span></span>
<span id="cb126-3"><a href="#cb126-3" aria-hidden="true" tabindex="-1"></a>        <span class="fu">mutate</span>(</span>
<span id="cb126-4"><a href="#cb126-4" aria-hidden="true" tabindex="-1"></a>          <span class="at">or_per_1000km =</span> <span class="fu">exp</span>(estimate),</span>
<span id="cb126-5"><a href="#cb126-5" aria-hidden="true" tabindex="-1"></a>          <span class="at">sig =</span> <span class="fu">ifelse</span>(p.value <span class="sc">&lt;</span> <span class="fl">0.05</span>, <span class="st">"*"</span>, <span class="st">""</span>)</span>
<span id="cb126-6"><a href="#cb126-6" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="cb126-7"><a href="#cb126-7" aria-hidden="true" tabindex="-1"></a>      <span class="at">digits =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">3</span>, <span class="dv">3</span>, <span class="dv">4</span>, <span class="dv">3</span>, <span class="dv">0</span>),</span>
<span id="cb126-8"><a href="#cb126-8" aria-hidden="true" tabindex="-1"></a>      <span class="at">col.names =</span> <span class="fu">c</span>(<span class="st">"Region"</span>, <span class="st">"Coefficient"</span>, <span class="st">"SE"</span>, <span class="st">"p-value"</span>, <span class="st">"OR/1000km"</span>, <span class="st">""</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<table class="caption-top table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: left;">Region</th>
<th style="text-align: right;">Coefficient</th>
<th style="text-align: right;">SE</th>
<th style="text-align: right;">p-value</th>
<th style="text-align: right;">OR/1000km</th>
<th style="text-align: left;"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">ROME</td>
<td style="text-align: right;">0.068</td>
<td style="text-align: right;">0.106</td>
<td style="text-align: right;">0.5186</td>
<td style="text-align: right;">1.071</td>
<td style="text-align: left;"></td>
</tr>
<tr class="even">
<td style="text-align: left;">ITAL</td>
<td style="text-align: right;">0.140</td>
<td style="text-align: right;">0.131</td>
<td style="text-align: right;">0.2848</td>
<td style="text-align: right;">1.150</td>
<td style="text-align: left;"></td>
</tr>
<tr class="odd">
<td style="text-align: left;">GALL</td>
<td style="text-align: right;">0.155</td>
<td style="text-align: right;">0.134</td>
<td style="text-align: right;">0.2476</td>
<td style="text-align: right;">1.168</td>
<td style="text-align: left;"></td>
</tr>
<tr class="even">
<td style="text-align: left;">AFRI</td>
<td style="text-align: right;">0.409</td>
<td style="text-align: right;">0.979</td>
<td style="text-align: right;">0.6790</td>
<td style="text-align: right;">1.505</td>
<td style="text-align: left;"></td>
</tr>
</tbody>
</table>
</div>
</div>
</section>
<section id="visualize-independent-model-fits" class="level2" data-number="5.3">
<h2 data-number="5.3" class="anchored" data-anchor-id="visualize-independent-model-fits"><span class="header-section-number">5.3</span> 3.3 Visualize Independent Model Fits</h2>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb127"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb127-1"><a href="#cb127-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create predictions for each region</span></span>
<span id="cb127-2"><a href="#cb127-2" aria-hidden="true" tabindex="-1"></a>pred_data <span class="ot">&lt;-</span> <span class="fu">expand_grid</span>(</span>
<span id="cb127-3"><a href="#cb127-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">dist_scaled =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">3</span>, <span class="fl">0.1</span>),</span>
<span id="cb127-4"><a href="#cb127-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">cos_bearing =</span> <span class="dv">0</span>,</span>
<span id="cb127-5"><a href="#cb127-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">sin_bearing =</span> <span class="dv">0</span></span>
<span id="cb127-6"><a href="#cb127-6" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb127-7"><a href="#cb127-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-8"><a href="#cb127-8" aria-hidden="true" tabindex="-1"></a>predictions <span class="ot">&lt;-</span> <span class="fu">map_dfr</span>(<span class="fu">names</span>(region_models), <span class="cf">function</span>(r) {</span>
<span id="cb127-9"><a href="#cb127-9" aria-hidden="true" tabindex="-1"></a>  model <span class="ot">&lt;-</span> region_models[[r]]</span>
<span id="cb127-10"><a href="#cb127-10" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.null</span>(model)) <span class="fu">return</span>(<span class="cn">NULL</span>)</span>
<span id="cb127-11"><a href="#cb127-11" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb127-12"><a href="#cb127-12" aria-hidden="true" tabindex="-1"></a>  preds <span class="ot">&lt;-</span> <span class="fu">predict</span>(model, <span class="at">newdata =</span> pred_data, <span class="at">type =</span> <span class="st">"response"</span>, <span class="at">se.fit =</span> <span class="cn">TRUE</span>)</span>
<span id="cb127-13"><a href="#cb127-13" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb127-14"><a href="#cb127-14" aria-hidden="true" tabindex="-1"></a>  pred_data <span class="sc">%&gt;%</span></span>
<span id="cb127-15"><a href="#cb127-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb127-16"><a href="#cb127-16" aria-hidden="true" tabindex="-1"></a>      <span class="at">mint_region =</span> r,</span>
<span id="cb127-17"><a href="#cb127-17" aria-hidden="true" tabindex="-1"></a>      <span class="at">pred =</span> preds<span class="sc">$</span>fit,</span>
<span id="cb127-18"><a href="#cb127-18" aria-hidden="true" tabindex="-1"></a>      <span class="at">se =</span> preds<span class="sc">$</span>se.fit,</span>
<span id="cb127-19"><a href="#cb127-19" aria-hidden="true" tabindex="-1"></a>      <span class="at">lower =</span> pred <span class="sc">-</span> <span class="fl">1.96</span> <span class="sc">*</span> se,</span>
<span id="cb127-20"><a href="#cb127-20" aria-hidden="true" tabindex="-1"></a>      <span class="at">upper =</span> pred <span class="sc">+</span> <span class="fl">1.96</span> <span class="sc">*</span> se,</span>
<span id="cb127-21"><a href="#cb127-21" aria-hidden="true" tabindex="-1"></a>      <span class="at">dist_km =</span> dist_scaled <span class="sc">*</span> <span class="dv">1000</span></span>
<span id="cb127-22"><a href="#cb127-22" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb127-23"><a href="#cb127-23" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb127-24"><a href="#cb127-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-25"><a href="#cb127-25" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(predictions, <span class="fu">aes</span>(<span class="at">x =</span> dist_km, <span class="at">y =</span> pred, <span class="at">color =</span> mint_region, <span class="at">fill =</span> mint_region)) <span class="sc">+</span></span>
<span id="cb127-26"><a href="#cb127-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_ribbon</span>(<span class="fu">aes</span>(<span class="at">ymin =</span> lower, <span class="at">ymax =</span> upper), <span class="at">alpha =</span> <span class="fl">0.2</span>, <span class="at">color =</span> <span class="cn">NA</span>) <span class="sc">+</span></span>
<span id="cb127-27"><a href="#cb127-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">linewidth =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb127-28"><a href="#cb127-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values =</span> region_colors) <span class="sc">+</span></span>
<span id="cb127-29"><a href="#cb127-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> region_colors) <span class="sc">+</span></span>
<span id="cb127-30"><a href="#cb127-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">labels =</span> scales<span class="sc">::</span><span class="fu">percent_format</span>(), <span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>)) <span class="sc">+</span></span>
<span id="cb127-31"><a href="#cb127-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb127-32"><a href="#cb127-32" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Distance Decay Curves by Mint Region"</span>,</span>
<span id="cb127-33"><a href="#cb127-33" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Predicted proportion vs distance from mint of origin"</span>,</span>
<span id="cb127-34"><a href="#cb127-34" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Distance from mint (km)"</span>,</span>
<span id="cb127-35"><a href="#cb127-35" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Predicted proportion"</span>,</span>
<span id="cb127-36"><a href="#cb127-36" aria-hidden="true" tabindex="-1"></a>    <span class="at">color =</span> <span class="st">"Mint Region"</span>,</span>
<span id="cb127-37"><a href="#cb127-37" aria-hidden="true" tabindex="-1"></a>    <span class="at">fill =</span> <span class="st">"Mint Region"</span></span>
<span id="cb127-38"><a href="#cb127-38" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb127-39"><a href="#cb127-39" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="circulation_model_files/figure-html/model-fit-viz-1.png" class="img-fluid figure-img" width="1344"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="hierarchical-model-partial-pooling" class="level2" data-number="5.4">
<h2 data-number="5.4" class="anchored" data-anchor-id="hierarchical-model-partial-pooling"><span class="header-section-number">5.4</span> 3.4 Hierarchical Model (Partial Pooling)</h2>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb128"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb128-1"><a href="#cb128-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Check we have enough regions for hierarchical model</span></span>
<span id="cb128-2"><a href="#cb128-2" aria-hidden="true" tabindex="-1"></a>n_regions <span class="ot">&lt;-</span> <span class="fu">n_distinct</span>(model_data<span class="sc">$</span>mint_region)</span>
<span id="cb128-3"><a href="#cb128-3" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Number of mint regions in model data:"</span>, n_regions, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Number of mint regions in model data: 5 </code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb130"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb130-1"><a href="#cb130-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Observations per region:</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Observations per region:</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb132"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb132-1"><a href="#cb132-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">table</span>(model_data<span class="sc">$</span>mint_region))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
AFRI GALL GREC ITAL ROME 
  34  180   24  224  423 </code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb134"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb134-1"><a href="#cb134-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (n_regions <span class="sc">&lt;</span> <span class="dv">2</span>) {</span>
<span id="cb134-2"><a href="#cb134-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">⚠ Only one mint region with data - cannot fit hierarchical model</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb134-3"><a href="#cb134-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Falling back to simple linear model</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb134-4"><a href="#cb134-4" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb134-5"><a href="#cb134-5" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Fallback: simple model without random effects</span></span>
<span id="cb134-6"><a href="#cb134-6" aria-hidden="true" tabindex="-1"></a>  hierarchical_model <span class="ot">&lt;-</span> <span class="fu">lm</span>(</span>
<span id="cb134-7"><a href="#cb134-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">qlogis</span>(<span class="fu">pmax</span>(<span class="fu">pmin</span>(prop_mint, <span class="fl">0.999</span>), <span class="fl">0.001</span>)) <span class="sc">~</span> </span>
<span id="cb134-8"><a href="#cb134-8" aria-hidden="true" tabindex="-1"></a>      dist_scaled <span class="sc">+</span> cos_bearing <span class="sc">+</span> sin_bearing,</span>
<span id="cb134-9"><a href="#cb134-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> model_data,</span>
<span id="cb134-10"><a href="#cb134-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">weights =</span> <span class="fu">sqrt</span>(n_total)</span>
<span id="cb134-11"><a href="#cb134-11" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb134-12"><a href="#cb134-12" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb134-13"><a href="#cb134-13" aria-hidden="true" tabindex="-1"></a>  use_hierarchical <span class="ot">&lt;-</span> <span class="cn">FALSE</span></span>
<span id="cb134-14"><a href="#cb134-14" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb134-15"><a href="#cb134-15" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Fit mixed effects model with random slopes by mint region</span></span>
<span id="cb134-16"><a href="#cb134-16" aria-hidden="true" tabindex="-1"></a>  hierarchical_model <span class="ot">&lt;-</span> <span class="fu">lmer</span>(</span>
<span id="cb134-17"><a href="#cb134-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">qlogis</span>(<span class="fu">pmax</span>(<span class="fu">pmin</span>(prop_mint, <span class="fl">0.999</span>), <span class="fl">0.001</span>)) <span class="sc">~</span> </span>
<span id="cb134-18"><a href="#cb134-18" aria-hidden="true" tabindex="-1"></a>      dist_scaled <span class="sc">+</span> cos_bearing <span class="sc">+</span> sin_bearing <span class="sc">+</span></span>
<span id="cb134-19"><a href="#cb134-19" aria-hidden="true" tabindex="-1"></a>      (<span class="dv">1</span> <span class="sc">+</span> dist_scaled <span class="sc">|</span> mint_region),</span>
<span id="cb134-20"><a href="#cb134-20" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> model_data,</span>
<span id="cb134-21"><a href="#cb134-21" aria-hidden="true" tabindex="-1"></a>    <span class="at">weights =</span> <span class="fu">sqrt</span>(n_total),</span>
<span id="cb134-22"><a href="#cb134-22" aria-hidden="true" tabindex="-1"></a>    <span class="at">control =</span> <span class="fu">lmerControl</span>(<span class="at">optimizer =</span> <span class="st">"bobyqa"</span>, <span class="at">optCtrl =</span> <span class="fu">list</span>(<span class="at">maxfun =</span> <span class="dv">100000</span>))</span>
<span id="cb134-23"><a href="#cb134-23" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb134-24"><a href="#cb134-24" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb134-25"><a href="#cb134-25" aria-hidden="true" tabindex="-1"></a>  use_hierarchical <span class="ot">&lt;-</span> <span class="cn">TRUE</span></span>
<span id="cb134-26"><a href="#cb134-26" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb134-27"><a href="#cb134-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb134-28"><a href="#cb134-28" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(hierarchical_model)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Linear mixed model fit by REML ['lmerMod']
Formula: 
qlogis(pmax(pmin(prop_mint, 0.999), 0.001)) ~ dist_scaled + cos_bearing +  
    sin_bearing + (1 + dist_scaled | mint_region)
   Data: model_data
Weights: sqrt(n_total)
Control: lmerControl(optimizer = "bobyqa", optCtrl = list(maxfun = 1e+05))

REML criterion at convergence: 2896.1

Scaled residuals: 
     Min       1Q   Median       3Q      Max 
-2.65796 -0.63284 -0.00942  0.80317  2.97420 

Random effects:
 Groups      Name        Variance  Std.Dev. Corr
 mint_region (Intercept) 1.469e+01 3.83340      
             dist_scaled 1.343e-04 0.01159  1.00
 Residual                1.134e+01 3.36738      
Number of obs: 885, groups:  mint_region, 5

Fixed effects:
            Estimate Std. Error t value
(Intercept) -2.78546    1.71681  -1.622
dist_scaled  0.15486    0.07952   1.947
cos_bearing -0.11323    0.07605  -1.489
sin_bearing  0.01621    0.05164   0.314

Correlation of Fixed Effects:
            (Intr) dst_sc cs_brn
dist_scaled  0.026              
cos_bearing -0.012  0.076       
sin_bearing -0.002  0.065  0.013
optimizer (bobyqa) convergence code: 0 (OK)
boundary (singular) fit: see help('isSingular')</code></pre>
</div>
</div>
</section>
<section id="extract-hierarchical-coefficients" class="level2" data-number="5.5">
<h2 data-number="5.5" class="anchored" data-anchor-id="extract-hierarchical-coefficients"><span class="header-section-number">5.5</span> 3.5 Extract Hierarchical Coefficients</h2>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb136"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb136-1"><a href="#cb136-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (use_hierarchical) {</span>
<span id="cb136-2"><a href="#cb136-2" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Fixed effects (population average)</span></span>
<span id="cb136-3"><a href="#cb136-3" aria-hidden="true" tabindex="-1"></a>  fixed_eff <span class="ot">&lt;-</span> <span class="fu">fixef</span>(hierarchical_model)</span>
<span id="cb136-4"><a href="#cb136-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Fixed effects (population average):</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb136-5"><a href="#cb136-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(fixed_eff)</span>
<span id="cb136-6"><a href="#cb136-6" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb136-7"><a href="#cb136-7" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Random effects (mint-specific deviations)</span></span>
<span id="cb136-8"><a href="#cb136-8" aria-hidden="true" tabindex="-1"></a>  random_eff <span class="ot">&lt;-</span> <span class="fu">ranef</span>(hierarchical_model)<span class="sc">$</span>mint_region</span>
<span id="cb136-9"><a href="#cb136-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Random effects (deviations from population average):</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb136-10"><a href="#cb136-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(random_eff)</span>
<span id="cb136-11"><a href="#cb136-11" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb136-12"><a href="#cb136-12" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Combine to get mint-specific coefficients</span></span>
<span id="cb136-13"><a href="#cb136-13" aria-hidden="true" tabindex="-1"></a>  hier_coefs <span class="ot">&lt;-</span> random_eff <span class="sc">%&gt;%</span></span>
<span id="cb136-14"><a href="#cb136-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rownames_to_column</span>(<span class="st">"mint_region"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb136-15"><a href="#cb136-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rename</span>(</span>
<span id="cb136-16"><a href="#cb136-16" aria-hidden="true" tabindex="-1"></a>      <span class="at">intercept_dev =</span> <span class="st">`</span><span class="at">(Intercept)</span><span class="st">`</span>,</span>
<span id="cb136-17"><a href="#cb136-17" aria-hidden="true" tabindex="-1"></a>      <span class="at">slope_dev =</span> dist_scaled</span>
<span id="cb136-18"><a href="#cb136-18" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb136-19"><a href="#cb136-19" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb136-20"><a href="#cb136-20" aria-hidden="true" tabindex="-1"></a>      <span class="at">intercept_total =</span> fixed_eff[<span class="st">"(Intercept)"</span>] <span class="sc">+</span> intercept_dev,</span>
<span id="cb136-21"><a href="#cb136-21" aria-hidden="true" tabindex="-1"></a>      <span class="at">slope_total =</span> fixed_eff[<span class="st">"dist_scaled"</span>] <span class="sc">+</span> slope_dev,</span>
<span id="cb136-22"><a href="#cb136-22" aria-hidden="true" tabindex="-1"></a>      <span class="at">or_per_1000km =</span> <span class="fu">exp</span>(slope_total)</span>
<span id="cb136-23"><a href="#cb136-23" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb136-24"><a href="#cb136-24" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb136-25"><a href="#cb136-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Mint-specific coefficients (with partial pooling):</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb136-26"><a href="#cb136-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable</span>(hier_coefs, <span class="at">digits =</span> <span class="dv">3</span>)</span>
<span id="cb136-27"><a href="#cb136-27" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb136-28"><a href="#cb136-28" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb136-29"><a href="#cb136-29" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Fallback: use coefficients from simple model</span></span>
<span id="cb136-30"><a href="#cb136-30" aria-hidden="true" tabindex="-1"></a>  fixed_eff <span class="ot">&lt;-</span> <span class="fu">coef</span>(hierarchical_model)</span>
<span id="cb136-31"><a href="#cb136-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Fixed effects (simple model - no pooling):</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb136-32"><a href="#cb136-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(fixed_eff)</span>
<span id="cb136-33"><a href="#cb136-33" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb136-34"><a href="#cb136-34" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Create single-row hier_coefs for compatibility</span></span>
<span id="cb136-35"><a href="#cb136-35" aria-hidden="true" tabindex="-1"></a>  hier_coefs <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb136-36"><a href="#cb136-36" aria-hidden="true" tabindex="-1"></a>    <span class="at">mint_region =</span> <span class="fu">unique</span>(model_data<span class="sc">$</span>mint_region)[<span class="dv">1</span>],</span>
<span id="cb136-37"><a href="#cb136-37" aria-hidden="true" tabindex="-1"></a>    <span class="at">intercept_dev =</span> <span class="dv">0</span>,</span>
<span id="cb136-38"><a href="#cb136-38" aria-hidden="true" tabindex="-1"></a>    <span class="at">slope_dev =</span> <span class="dv">0</span>,</span>
<span id="cb136-39"><a href="#cb136-39" aria-hidden="true" tabindex="-1"></a>    <span class="at">intercept_total =</span> fixed_eff[<span class="st">"(Intercept)"</span>],</span>
<span id="cb136-40"><a href="#cb136-40" aria-hidden="true" tabindex="-1"></a>    <span class="at">slope_total =</span> fixed_eff[<span class="st">"dist_scaled"</span>],</span>
<span id="cb136-41"><a href="#cb136-41" aria-hidden="true" tabindex="-1"></a>    <span class="at">or_per_1000km =</span> <span class="fu">exp</span>(fixed_eff[<span class="st">"dist_scaled"</span>])</span>
<span id="cb136-42"><a href="#cb136-42" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb136-43"><a href="#cb136-43" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb136-44"><a href="#cb136-44" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Note: Only one region available, using pooled estimates</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb136-45"><a href="#cb136-45" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
Fixed effects (population average):
(Intercept) dist_scaled cos_bearing sin_bearing 
 -2.7854641   0.1548551  -0.1132298   0.0162056 

Random effects (deviations from population average):
     (Intercept)  dist_scaled
AFRI   -1.732748 -0.005237600
GALL   -1.481108 -0.004476966
GREC   -2.162990 -0.006538101
ITAL   -1.457126 -0.004404474
ROME    6.833972  0.020657141

Mint-specific coefficients (with partial pooling):</code></pre>
</div>
<div class="cell-output-display">
<table class="caption-top table table-sm table-striped small">
<colgroup>
<col style="width: 15%">
<col style="width: 17%">
<col style="width: 12%">
<col style="width: 20%">
<col style="width: 15%">
<col style="width: 17%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">mint_region</th>
<th style="text-align: right;">intercept_dev</th>
<th style="text-align: right;">slope_dev</th>
<th style="text-align: right;">intercept_total</th>
<th style="text-align: right;">slope_total</th>
<th style="text-align: right;">or_per_1000km</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">AFRI</td>
<td style="text-align: right;">-1.733</td>
<td style="text-align: right;">-0.005</td>
<td style="text-align: right;">-4.518</td>
<td style="text-align: right;">0.150</td>
<td style="text-align: right;">1.161</td>
</tr>
<tr class="even">
<td style="text-align: left;">GALL</td>
<td style="text-align: right;">-1.481</td>
<td style="text-align: right;">-0.004</td>
<td style="text-align: right;">-4.267</td>
<td style="text-align: right;">0.150</td>
<td style="text-align: right;">1.162</td>
</tr>
<tr class="odd">
<td style="text-align: left;">GREC</td>
<td style="text-align: right;">-2.163</td>
<td style="text-align: right;">-0.007</td>
<td style="text-align: right;">-4.948</td>
<td style="text-align: right;">0.148</td>
<td style="text-align: right;">1.160</td>
</tr>
<tr class="even">
<td style="text-align: left;">ITAL</td>
<td style="text-align: right;">-1.457</td>
<td style="text-align: right;">-0.004</td>
<td style="text-align: right;">-4.243</td>
<td style="text-align: right;">0.150</td>
<td style="text-align: right;">1.162</td>
</tr>
<tr class="odd">
<td style="text-align: left;">ROME</td>
<td style="text-align: right;">6.834</td>
<td style="text-align: right;">0.021</td>
<td style="text-align: right;">4.049</td>
<td style="text-align: right;">0.176</td>
<td style="text-align: right;">1.192</td>
</tr>
</tbody>
</table>
</div>
</div>
</section>
<section id="compare-independent-vs-hierarchical-estimates" class="level2" data-number="5.6">
<h2 data-number="5.6" class="anchored" data-anchor-id="compare-independent-vs-hierarchical-estimates"><span class="header-section-number">5.6</span> 3.6 Compare Independent vs Hierarchical Estimates</h2>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb138"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb138-1"><a href="#cb138-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (use_hierarchical <span class="sc">&amp;&amp;</span> <span class="fu">nrow</span>(hier_coefs) <span class="sc">&gt;</span> <span class="dv">1</span>) {</span>
<span id="cb138-2"><a href="#cb138-2" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Combine estimates</span></span>
<span id="cb138-3"><a href="#cb138-3" aria-hidden="true" tabindex="-1"></a>  comparison <span class="ot">&lt;-</span> distance_effects <span class="sc">%&gt;%</span></span>
<span id="cb138-4"><a href="#cb138-4" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">select</span>(mint_region, <span class="at">ind_estimate =</span> estimate, <span class="at">ind_se =</span> std.error) <span class="sc">%&gt;%</span></span>
<span id="cb138-5"><a href="#cb138-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">left_join</span>(</span>
<span id="cb138-6"><a href="#cb138-6" aria-hidden="true" tabindex="-1"></a>      hier_coefs <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">select</span>(mint_region, <span class="at">hier_estimate =</span> slope_total),</span>
<span id="cb138-7"><a href="#cb138-7" aria-hidden="true" tabindex="-1"></a>      <span class="at">by =</span> <span class="st">"mint_region"</span></span>
<span id="cb138-8"><a href="#cb138-8" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb138-9"><a href="#cb138-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(hier_estimate))</span>
<span id="cb138-10"><a href="#cb138-10" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb138-11"><a href="#cb138-11" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">nrow</span>(comparison) <span class="sc">&gt;</span> <span class="dv">1</span>) {</span>
<span id="cb138-12"><a href="#cb138-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggplot</span>(comparison, <span class="fu">aes</span>(<span class="at">x =</span> ind_estimate, <span class="at">y =</span> hier_estimate)) <span class="sc">+</span></span>
<span id="cb138-13"><a href="#cb138-13" aria-hidden="true" tabindex="-1"></a>      <span class="fu">geom_abline</span>(<span class="at">slope =</span> <span class="dv">1</span>, <span class="at">intercept =</span> <span class="dv">0</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">color =</span> <span class="st">"grey50"</span>) <span class="sc">+</span></span>
<span id="cb138-14"><a href="#cb138-14" aria-hidden="true" tabindex="-1"></a>      <span class="fu">geom_errorbarh</span>(<span class="fu">aes</span>(<span class="at">xmin =</span> ind_estimate <span class="sc">-</span> <span class="fl">1.96</span><span class="sc">*</span>ind_se, </span>
<span id="cb138-15"><a href="#cb138-15" aria-hidden="true" tabindex="-1"></a>                         <span class="at">xmax =</span> ind_estimate <span class="sc">+</span> <span class="fl">1.96</span><span class="sc">*</span>ind_se),</span>
<span id="cb138-16"><a href="#cb138-16" aria-hidden="true" tabindex="-1"></a>                     <span class="at">height =</span> <span class="dv">0</span>, <span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb138-17"><a href="#cb138-17" aria-hidden="true" tabindex="-1"></a>      <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">color =</span> mint_region), <span class="at">size =</span> <span class="dv">4</span>) <span class="sc">+</span></span>
<span id="cb138-18"><a href="#cb138-18" aria-hidden="true" tabindex="-1"></a>      <span class="fu">geom_text</span>(<span class="fu">aes</span>(<span class="at">label =</span> mint_region), <span class="at">vjust =</span> <span class="sc">-</span><span class="dv">1</span>, <span class="at">size =</span> <span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb138-19"><a href="#cb138-19" aria-hidden="true" tabindex="-1"></a>      <span class="fu">scale_color_manual</span>(<span class="at">values =</span> region_colors) <span class="sc">+</span></span>
<span id="cb138-20"><a href="#cb138-20" aria-hidden="true" tabindex="-1"></a>      <span class="fu">labs</span>(</span>
<span id="cb138-21"><a href="#cb138-21" aria-hidden="true" tabindex="-1"></a>        <span class="at">title =</span> <span class="st">"Shrinkage: Independent vs Hierarchical Estimates"</span>,</span>
<span id="cb138-22"><a href="#cb138-22" aria-hidden="true" tabindex="-1"></a>        <span class="at">subtitle =</span> <span class="st">"Points closer to diagonal = less shrinkage; away = more pooling"</span>,</span>
<span id="cb138-23"><a href="#cb138-23" aria-hidden="true" tabindex="-1"></a>        <span class="at">x =</span> <span class="st">"Independent estimate (no pooling)"</span>,</span>
<span id="cb138-24"><a href="#cb138-24" aria-hidden="true" tabindex="-1"></a>        <span class="at">y =</span> <span class="st">"Hierarchical estimate (partial pooling)"</span></span>
<span id="cb138-25"><a href="#cb138-25" aria-hidden="true" tabindex="-1"></a>      ) <span class="sc">+</span></span>
<span id="cb138-26"><a href="#cb138-26" aria-hidden="true" tabindex="-1"></a>      <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb138-27"><a href="#cb138-27" aria-hidden="true" tabindex="-1"></a>      <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"none"</span>)</span>
<span id="cb138-28"><a href="#cb138-28" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb138-29"><a href="#cb138-29" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"Not enough regions to compare estimates</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb138-30"><a href="#cb138-30" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb138-31"><a href="#cb138-31" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb138-32"><a href="#cb138-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Hierarchical model not fitted or only one region - skipping comparison plot</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb138-33"><a href="#cb138-33" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="circulation_model_files/figure-html/compare-estimates-1.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="add-circulation-age-effect" class="level2" data-number="5.7">
<h2 data-number="5.7" class="anchored" data-anchor-id="add-circulation-age-effect"><span class="header-section-number">5.7</span> 3.7 Add Circulation Age Effect</h2>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb139"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb139-1"><a href="#cb139-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (use_hierarchical) {</span>
<span id="cb139-2"><a href="#cb139-2" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Model with circulation age</span></span>
<span id="cb139-3"><a href="#cb139-3" aria-hidden="true" tabindex="-1"></a>  age_model <span class="ot">&lt;-</span> <span class="fu">lmer</span>(</span>
<span id="cb139-4"><a href="#cb139-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">qlogis</span>(<span class="fu">pmax</span>(<span class="fu">pmin</span>(prop_mint, <span class="fl">0.999</span>), <span class="fl">0.001</span>)) <span class="sc">~</span> </span>
<span id="cb139-5"><a href="#cb139-5" aria-hidden="true" tabindex="-1"></a>      dist_scaled <span class="sc">+</span> cos_bearing <span class="sc">+</span> sin_bearing <span class="sc">+</span> log_circ_age <span class="sc">+</span></span>
<span id="cb139-6"><a href="#cb139-6" aria-hidden="true" tabindex="-1"></a>      (<span class="dv">1</span> <span class="sc">+</span> dist_scaled <span class="sc">|</span> mint_region),</span>
<span id="cb139-7"><a href="#cb139-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> model_data <span class="sc">%&gt;%</span> <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(log_circ_age)),</span>
<span id="cb139-8"><a href="#cb139-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">weights =</span> <span class="fu">sqrt</span>(n_total),</span>
<span id="cb139-9"><a href="#cb139-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">control =</span> <span class="fu">lmerControl</span>(<span class="at">optimizer =</span> <span class="st">"bobyqa"</span>, <span class="at">optCtrl =</span> <span class="fu">list</span>(<span class="at">maxfun =</span> <span class="dv">100000</span>))</span>
<span id="cb139-10"><a href="#cb139-10" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb139-11"><a href="#cb139-11" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb139-12"><a href="#cb139-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Model with circulation age:</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb139-13"><a href="#cb139-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summary</span>(age_model)</span>
<span id="cb139-14"><a href="#cb139-14" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb139-15"><a href="#cb139-15" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Compare AIC</span></span>
<span id="cb139-16"><a href="#cb139-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n\n</span><span class="st">Model comparison:</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb139-17"><a href="#cb139-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Without age:"</span>, <span class="fu">AIC</span>(hierarchical_model), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb139-18"><a href="#cb139-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"With age:"</span>, <span class="fu">AIC</span>(age_model), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb139-19"><a href="#cb139-19" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb139-20"><a href="#cb139-20" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Fallback: simple model with age</span></span>
<span id="cb139-21"><a href="#cb139-21" aria-hidden="true" tabindex="-1"></a>  age_model <span class="ot">&lt;-</span> <span class="fu">lm</span>(</span>
<span id="cb139-22"><a href="#cb139-22" aria-hidden="true" tabindex="-1"></a>    <span class="fu">qlogis</span>(<span class="fu">pmax</span>(<span class="fu">pmin</span>(prop_mint, <span class="fl">0.999</span>), <span class="fl">0.001</span>)) <span class="sc">~</span> </span>
<span id="cb139-23"><a href="#cb139-23" aria-hidden="true" tabindex="-1"></a>      dist_scaled <span class="sc">+</span> cos_bearing <span class="sc">+</span> sin_bearing <span class="sc">+</span> log_circ_age,</span>
<span id="cb139-24"><a href="#cb139-24" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> model_data <span class="sc">%&gt;%</span> <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(log_circ_age)),</span>
<span id="cb139-25"><a href="#cb139-25" aria-hidden="true" tabindex="-1"></a>    <span class="at">weights =</span> <span class="fu">sqrt</span>(n_total)</span>
<span id="cb139-26"><a href="#cb139-26" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb139-27"><a href="#cb139-27" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb139-28"><a href="#cb139-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Model with circulation age (simple, no random effects):</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb139-29"><a href="#cb139-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summary</span>(age_model)</span>
<span id="cb139-30"><a href="#cb139-30" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
Model with circulation age:


Model comparison:
Without age: 2912.069 
With age: 2884.028 </code></pre>
</div>
</div>
<hr>
</section>
</section>
<section id="chunk-4-probability-surface-generation" class="level1" data-number="6">
<h1 data-number="6"><span class="header-section-number">6</span> CHUNK 4: Probability Surface Generation</h1>
<section id="create-prediction-grid" class="level2" data-number="6.1">
<h2 data-number="6.1" class="anchored" data-anchor-id="create-prediction-grid"><span class="header-section-number">6.1</span> 4.1 Create Prediction Grid</h2>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb141"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb141-1"><a href="#cb141-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create hexagonal grid covering study area</span></span>
<span id="cb141-2"><a href="#cb141-2" aria-hidden="true" tabindex="-1"></a>study_bbox <span class="ot">&lt;-</span> <span class="fu">st_bbox</span>(<span class="fu">c</span>(<span class="at">xmin =</span> <span class="sc">-</span><span class="dv">10</span>, <span class="at">ymin =</span> <span class="dv">30</span>, <span class="at">xmax =</span> <span class="dv">45</span>, <span class="at">ymax =</span> <span class="dv">55</span>), <span class="at">crs =</span> <span class="dv">4326</span>)</span>
<span id="cb141-3"><a href="#cb141-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-4"><a href="#cb141-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Project for hexagon creation</span></span>
<span id="cb141-5"><a href="#cb141-5" aria-hidden="true" tabindex="-1"></a>study_poly <span class="ot">&lt;-</span> <span class="fu">st_as_sfc</span>(study_bbox) <span class="sc">%&gt;%</span> <span class="fu">st_transform</span>(<span class="dv">3035</span>)</span>
<span id="cb141-6"><a href="#cb141-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-7"><a href="#cb141-7" aria-hidden="true" tabindex="-1"></a>hex_grid <span class="ot">&lt;-</span> <span class="fu">st_make_grid</span>(study_poly, <span class="at">cellsize =</span> <span class="dv">100000</span>, <span class="at">square =</span> <span class="cn">FALSE</span>) <span class="sc">%&gt;%</span></span>
<span id="cb141-8"><a href="#cb141-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_sf</span>(<span class="at">hex_id =</span> <span class="fu">seq_along</span>(.), <span class="at">geometry =</span> .) <span class="sc">%&gt;%</span></span>
<span id="cb141-9"><a href="#cb141-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_transform</span>(<span class="dv">4326</span>)</span>
<span id="cb141-10"><a href="#cb141-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-11"><a href="#cb141-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Get centroids</span></span>
<span id="cb141-12"><a href="#cb141-12" aria-hidden="true" tabindex="-1"></a>hex_centroids <span class="ot">&lt;-</span> <span class="fu">st_centroid</span>(hex_grid)</span>
<span id="cb141-13"><a href="#cb141-13" aria-hidden="true" tabindex="-1"></a>cent_coords <span class="ot">&lt;-</span> <span class="fu">st_coordinates</span>(hex_centroids)</span>
<span id="cb141-14"><a href="#cb141-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-15"><a href="#cb141-15" aria-hidden="true" tabindex="-1"></a>hex_grid <span class="ot">&lt;-</span> hex_grid <span class="sc">%&gt;%</span></span>
<span id="cb141-16"><a href="#cb141-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb141-17"><a href="#cb141-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">cent_lon =</span> cent_coords[, <span class="dv">1</span>],</span>
<span id="cb141-18"><a href="#cb141-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">cent_lat =</span> cent_coords[, <span class="dv">2</span>]</span>
<span id="cb141-19"><a href="#cb141-19" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb141-20"><a href="#cb141-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-21"><a href="#cb141-21" aria-hidden="true" tabindex="-1"></a><span class="co"># Filter to land (approximate)</span></span>
<span id="cb141-22"><a href="#cb141-22" aria-hidden="true" tabindex="-1"></a>land_simple <span class="ot">&lt;-</span> <span class="fu">ne_countries</span>(<span class="at">scale =</span> <span class="st">"medium"</span>, <span class="at">returnclass =</span> <span class="st">"sf"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb141-23"><a href="#cb141-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(continent <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"Europe"</span>, <span class="st">"Africa"</span>, <span class="st">"Asia"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb141-24"><a href="#cb141-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_union</span>() <span class="sc">%&gt;%</span></span>
<span id="cb141-25"><a href="#cb141-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_simplify</span>(<span class="at">dTolerance =</span> <span class="dv">10000</span>)</span>
<span id="cb141-26"><a href="#cb141-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-27"><a href="#cb141-27" aria-hidden="true" tabindex="-1"></a>hex_land <span class="ot">&lt;-</span> hex_grid <span class="sc">%&gt;%</span></span>
<span id="cb141-28"><a href="#cb141-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">lengths</span>(<span class="fu">st_intersects</span>(., land_simple)) <span class="sc">&gt;</span> <span class="dv">0</span>)</span>
<span id="cb141-29"><a href="#cb141-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-30"><a href="#cb141-30" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Prediction grid:"</span>, <span class="fu">nrow</span>(hex_land), <span class="st">"hexes</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Prediction grid: 1461 hexes</code></pre>
</div>
</div>
</section>
<section id="compute-distances-from-each-mint-region" class="level2" data-number="6.2">
<h2 data-number="6.2" class="anchored" data-anchor-id="compute-distances-from-each-mint-region"><span class="header-section-number">6.2</span> 4.2 Compute Distances from Each Mint Region</h2>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb143"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb143-1"><a href="#cb143-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Get representative coordinates for each mint region</span></span>
<span id="cb143-2"><a href="#cb143-2" aria-hidden="true" tabindex="-1"></a>mint_region_coords <span class="ot">&lt;-</span> mint_coords <span class="sc">%&gt;%</span></span>
<span id="cb143-3"><a href="#cb143-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(mint_lat), mint_region <span class="sc">%in%</span> <span class="fu">levels</span>(model_data<span class="sc">$</span>mint_region)) <span class="sc">%&gt;%</span></span>
<span id="cb143-4"><a href="#cb143-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(mint_region) <span class="sc">%&gt;%</span></span>
<span id="cb143-5"><a href="#cb143-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb143-6"><a href="#cb143-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">region_lat =</span> <span class="fu">weighted.mean</span>(mint_lat, n_types, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb143-7"><a href="#cb143-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">region_lon =</span> <span class="fu">weighted.mean</span>(mint_lon, n_types, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb143-8"><a href="#cb143-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">n_mints =</span> <span class="fu">n</span>(),</span>
<span id="cb143-9"><a href="#cb143-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">n_types =</span> <span class="fu">sum</span>(n_types),</span>
<span id="cb143-10"><a href="#cb143-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">.groups =</span> <span class="st">"drop"</span></span>
<span id="cb143-11"><a href="#cb143-11" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb143-12"><a href="#cb143-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb143-13"><a href="#cb143-13" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Mint region centroids:</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Mint region centroids:</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb145"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb145-1"><a href="#cb145-1" aria-hidden="true" tabindex="-1"></a><span class="fu">kable</span>(mint_region_coords, <span class="at">digits =</span> <span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<table class="caption-top table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: left;">mint_region</th>
<th style="text-align: right;">region_lat</th>
<th style="text-align: right;">region_lon</th>
<th style="text-align: right;">n_mints</th>
<th style="text-align: right;">n_types</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">AFRI</td>
<td style="text-align: right;">37.50</td>
<td style="text-align: right;">14.00</td>
<td style="text-align: right;">8</td>
<td style="text-align: right;">45</td>
</tr>
<tr class="even">
<td style="text-align: left;">GALL</td>
<td style="text-align: right;">43.19</td>
<td style="text-align: right;">2.98</td>
<td style="text-align: right;">8</td>
<td style="text-align: right;">386</td>
</tr>
<tr class="odd">
<td style="text-align: left;">GREC</td>
<td style="text-align: right;">40.72</td>
<td style="text-align: right;">19.47</td>
<td style="text-align: right;">17</td>
<td style="text-align: right;">32</td>
</tr>
<tr class="even">
<td style="text-align: left;">ITAL</td>
<td style="text-align: right;">44.03</td>
<td style="text-align: right;">12.16</td>
<td style="text-align: right;">19</td>
<td style="text-align: right;">399</td>
</tr>
<tr class="odd">
<td style="text-align: left;">ROME</td>
<td style="text-align: right;">41.90</td>
<td style="text-align: right;">12.50</td>
<td style="text-align: right;">2</td>
<td style="text-align: right;">28177</td>
</tr>
</tbody>
</table>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb146"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb146-1"><a href="#cb146-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Compute distance from each hex to each mint region</span></span>
<span id="cb146-2"><a href="#cb146-2" aria-hidden="true" tabindex="-1"></a>hex_to_mint <span class="ot">&lt;-</span> <span class="fu">expand_grid</span>(</span>
<span id="cb146-3"><a href="#cb146-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">hex_id =</span> hex_land<span class="sc">$</span>hex_id,</span>
<span id="cb146-4"><a href="#cb146-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">mint_region =</span> mint_region_coords<span class="sc">$</span>mint_region</span>
<span id="cb146-5"><a href="#cb146-5" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%&gt;%</span></span>
<span id="cb146-6"><a href="#cb146-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(hex_land <span class="sc">%&gt;%</span> <span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">select</span>(hex_id, cent_lon, cent_lat), </span>
<span id="cb146-7"><a href="#cb146-7" aria-hidden="true" tabindex="-1"></a>            <span class="at">by =</span> <span class="st">"hex_id"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb146-8"><a href="#cb146-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(mint_region_coords, <span class="at">by =</span> <span class="st">"mint_region"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb146-9"><a href="#cb146-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb146-10"><a href="#cb146-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">delta_lon =</span> cent_lon <span class="sc">-</span> region_lon,</span>
<span id="cb146-11"><a href="#cb146-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">delta_lat =</span> cent_lat <span class="sc">-</span> region_lat,</span>
<span id="cb146-12"><a href="#cb146-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">dist_km =</span> <span class="fu">sqrt</span>(</span>
<span id="cb146-13"><a href="#cb146-13" aria-hidden="true" tabindex="-1"></a>      (delta_lon <span class="sc">*</span> <span class="dv">111</span> <span class="sc">*</span> <span class="fu">cos</span>(region_lat <span class="sc">*</span> pi<span class="sc">/</span><span class="dv">180</span>))<span class="sc">^</span><span class="dv">2</span> <span class="sc">+</span></span>
<span id="cb146-14"><a href="#cb146-14" aria-hidden="true" tabindex="-1"></a>      (delta_lat <span class="sc">*</span> <span class="dv">111</span>)<span class="sc">^</span><span class="dv">2</span></span>
<span id="cb146-15"><a href="#cb146-15" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb146-16"><a href="#cb146-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">dist_scaled =</span> dist_km <span class="sc">/</span> <span class="dv">1000</span>,</span>
<span id="cb146-17"><a href="#cb146-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">bearing_rad =</span> <span class="fu">atan2</span>(</span>
<span id="cb146-18"><a href="#cb146-18" aria-hidden="true" tabindex="-1"></a>      delta_lon <span class="sc">*</span> <span class="fu">cos</span>(region_lat <span class="sc">*</span> pi<span class="sc">/</span><span class="dv">180</span>),</span>
<span id="cb146-19"><a href="#cb146-19" aria-hidden="true" tabindex="-1"></a>      delta_lat</span>
<span id="cb146-20"><a href="#cb146-20" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb146-21"><a href="#cb146-21" aria-hidden="true" tabindex="-1"></a>    <span class="at">cos_bearing =</span> <span class="fu">cos</span>(bearing_rad),</span>
<span id="cb146-22"><a href="#cb146-22" aria-hidden="true" tabindex="-1"></a>    <span class="at">sin_bearing =</span> <span class="fu">sin</span>(bearing_rad)</span>
<span id="cb146-23"><a href="#cb146-23" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb146-24"><a href="#cb146-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb146-25"><a href="#cb146-25" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"✓ Computed distances:"</span>, <span class="fu">nrow</span>(hex_to_mint), <span class="st">"hex-mint pairs</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>✓ Computed distances: 7305 hex-mint pairs</code></pre>
</div>
</div>
</section>
<section id="generate-probability-surface-for-each-mint-region" class="level2" data-number="6.3">
<h2 data-number="6.3" class="anchored" data-anchor-id="generate-probability-surface-for-each-mint-region"><span class="header-section-number">6.3</span> 4.3 Generate Probability Surface for Each Mint Region</h2>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb148"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb148-1"><a href="#cb148-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Predict using the fitted model</span></span>
<span id="cb148-2"><a href="#cb148-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Create prediction data</span></span>
<span id="cb148-3"><a href="#cb148-3" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (use_hierarchical) {</span>
<span id="cb148-4"><a href="#cb148-4" aria-hidden="true" tabindex="-1"></a>  pred_surface <span class="ot">&lt;-</span> hex_to_mint <span class="sc">%&gt;%</span></span>
<span id="cb148-5"><a href="#cb148-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb148-6"><a href="#cb148-6" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Predict linear predictor with random effects</span></span>
<span id="cb148-7"><a href="#cb148-7" aria-hidden="true" tabindex="-1"></a>      <span class="at">eta =</span> <span class="fu">predict</span>(hierarchical_model, </span>
<span id="cb148-8"><a href="#cb148-8" aria-hidden="true" tabindex="-1"></a>                    <span class="at">newdata =</span> <span class="fu">data.frame</span>(</span>
<span id="cb148-9"><a href="#cb148-9" aria-hidden="true" tabindex="-1"></a>                      <span class="at">dist_scaled =</span> dist_scaled,</span>
<span id="cb148-10"><a href="#cb148-10" aria-hidden="true" tabindex="-1"></a>                      <span class="at">cos_bearing =</span> cos_bearing,</span>
<span id="cb148-11"><a href="#cb148-11" aria-hidden="true" tabindex="-1"></a>                      <span class="at">sin_bearing =</span> sin_bearing,</span>
<span id="cb148-12"><a href="#cb148-12" aria-hidden="true" tabindex="-1"></a>                      <span class="at">mint_region =</span> <span class="fu">factor</span>(mint_region, <span class="at">levels =</span> <span class="fu">levels</span>(model_data<span class="sc">$</span>mint_region))</span>
<span id="cb148-13"><a href="#cb148-13" aria-hidden="true" tabindex="-1"></a>                    ),</span>
<span id="cb148-14"><a href="#cb148-14" aria-hidden="true" tabindex="-1"></a>                    <span class="at">allow.new.levels =</span> <span class="cn">FALSE</span>,</span>
<span id="cb148-15"><a href="#cb148-15" aria-hidden="true" tabindex="-1"></a>                    <span class="at">re.form =</span> <span class="cn">NULL</span>),  <span class="co"># Include random effects</span></span>
<span id="cb148-16"><a href="#cb148-16" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb148-17"><a href="#cb148-17" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Convert to probability</span></span>
<span id="cb148-18"><a href="#cb148-18" aria-hidden="true" tabindex="-1"></a>      <span class="at">prob_raw =</span> <span class="fu">plogis</span>(eta)</span>
<span id="cb148-19"><a href="#cb148-19" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb148-20"><a href="#cb148-20" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb148-21"><a href="#cb148-21" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Simple model prediction (no random effects)</span></span>
<span id="cb148-22"><a href="#cb148-22" aria-hidden="true" tabindex="-1"></a>  pred_surface <span class="ot">&lt;-</span> hex_to_mint <span class="sc">%&gt;%</span></span>
<span id="cb148-23"><a href="#cb148-23" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb148-24"><a href="#cb148-24" aria-hidden="true" tabindex="-1"></a>      <span class="at">eta =</span> <span class="fu">predict</span>(hierarchical_model, </span>
<span id="cb148-25"><a href="#cb148-25" aria-hidden="true" tabindex="-1"></a>                    <span class="at">newdata =</span> <span class="fu">data.frame</span>(</span>
<span id="cb148-26"><a href="#cb148-26" aria-hidden="true" tabindex="-1"></a>                      <span class="at">dist_scaled =</span> dist_scaled,</span>
<span id="cb148-27"><a href="#cb148-27" aria-hidden="true" tabindex="-1"></a>                      <span class="at">cos_bearing =</span> cos_bearing,</span>
<span id="cb148-28"><a href="#cb148-28" aria-hidden="true" tabindex="-1"></a>                      <span class="at">sin_bearing =</span> sin_bearing</span>
<span id="cb148-29"><a href="#cb148-29" aria-hidden="true" tabindex="-1"></a>                    )),</span>
<span id="cb148-30"><a href="#cb148-30" aria-hidden="true" tabindex="-1"></a>      <span class="at">prob_raw =</span> <span class="fu">plogis</span>(eta)</span>
<span id="cb148-31"><a href="#cb148-31" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb148-32"><a href="#cb148-32" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb148-33"><a href="#cb148-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb148-34"><a href="#cb148-34" aria-hidden="true" tabindex="-1"></a><span class="co"># Handle regions not in model</span></span>
<span id="cb148-35"><a href="#cb148-35" aria-hidden="true" tabindex="-1"></a>pred_surface <span class="ot">&lt;-</span> pred_surface <span class="sc">%&gt;%</span></span>
<span id="cb148-36"><a href="#cb148-36" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb148-37"><a href="#cb148-37" aria-hidden="true" tabindex="-1"></a>    <span class="at">prob_raw =</span> <span class="fu">ifelse</span>(<span class="fu">is.na</span>(prob_raw), <span class="fl">0.01</span>, prob_raw)  <span class="co"># Small baseline for missing</span></span>
<span id="cb148-38"><a href="#cb148-38" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb148-39"><a href="#cb148-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb148-40"><a href="#cb148-40" aria-hidden="true" tabindex="-1"></a><span class="co"># Get production weights (total types per region)</span></span>
<span id="cb148-41"><a href="#cb148-41" aria-hidden="true" tabindex="-1"></a>production_weights <span class="ot">&lt;-</span> chrr_analysis <span class="sc">%&gt;%</span></span>
<span id="cb148-42"><a href="#cb148-42" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(mint_region <span class="sc">%in%</span> mint_region_coords<span class="sc">$</span>mint_region) <span class="sc">%&gt;%</span></span>
<span id="cb148-43"><a href="#cb148-43" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(mint_region) <span class="sc">%&gt;%</span></span>
<span id="cb148-44"><a href="#cb148-44" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">production =</span> <span class="fu">n</span>(), <span class="at">.groups =</span> <span class="st">"drop"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb148-45"><a href="#cb148-45" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">prod_weight =</span> production <span class="sc">/</span> <span class="fu">sum</span>(production))</span>
<span id="cb148-46"><a href="#cb148-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb148-47"><a href="#cb148-47" aria-hidden="true" tabindex="-1"></a><span class="co"># Add production weights</span></span>
<span id="cb148-48"><a href="#cb148-48" aria-hidden="true" tabindex="-1"></a>pred_surface <span class="ot">&lt;-</span> pred_surface <span class="sc">%&gt;%</span></span>
<span id="cb148-49"><a href="#cb148-49" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(production_weights, <span class="at">by =</span> <span class="st">"mint_region"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb148-50"><a href="#cb148-50" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb148-51"><a href="#cb148-51" aria-hidden="true" tabindex="-1"></a>    <span class="at">weighted_prob =</span> prob_raw <span class="sc">*</span> prod_weight</span>
<span id="cb148-52"><a href="#cb148-52" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb148-53"><a href="#cb148-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb148-54"><a href="#cb148-54" aria-hidden="true" tabindex="-1"></a><span class="co"># Normalize within each hex</span></span>
<span id="cb148-55"><a href="#cb148-55" aria-hidden="true" tabindex="-1"></a>pred_normalized <span class="ot">&lt;-</span> pred_surface <span class="sc">%&gt;%</span></span>
<span id="cb148-56"><a href="#cb148-56" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(hex_id) <span class="sc">%&gt;%</span></span>
<span id="cb148-57"><a href="#cb148-57" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb148-58"><a href="#cb148-58" aria-hidden="true" tabindex="-1"></a>    <span class="at">total_prob =</span> <span class="fu">sum</span>(weighted_prob),</span>
<span id="cb148-59"><a href="#cb148-59" aria-hidden="true" tabindex="-1"></a>    <span class="at">expected_prop =</span> weighted_prob <span class="sc">/</span> total_prob</span>
<span id="cb148-60"><a href="#cb148-60" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb148-61"><a href="#cb148-61" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb148-62"><a href="#cb148-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb148-63"><a href="#cb148-63" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"✓ Probability surface generated</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>✓ Probability surface generated</code></pre>
</div>
</div>
</section>
<section id="create-multi-layer-spatial-object" class="level2" data-number="6.4">
<h2 data-number="6.4" class="anchored" data-anchor-id="create-multi-layer-spatial-object"><span class="header-section-number">6.4</span> 4.4 Create Multi-Layer Spatial Object</h2>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb150"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb150-1"><a href="#cb150-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Pivot to wide format</span></span>
<span id="cb150-2"><a href="#cb150-2" aria-hidden="true" tabindex="-1"></a>prob_wide <span class="ot">&lt;-</span> pred_normalized <span class="sc">%&gt;%</span></span>
<span id="cb150-3"><a href="#cb150-3" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(hex_id, mint_region, expected_prop, dist_km) <span class="sc">%&gt;%</span></span>
<span id="cb150-4"><a href="#cb150-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_wider</span>(</span>
<span id="cb150-5"><a href="#cb150-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">id_cols =</span> hex_id,</span>
<span id="cb150-6"><a href="#cb150-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">names_from =</span> mint_region,</span>
<span id="cb150-7"><a href="#cb150-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">values_from =</span> <span class="fu">c</span>(expected_prop, dist_km),</span>
<span id="cb150-8"><a href="#cb150-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">names_sep =</span> <span class="st">"_"</span></span>
<span id="cb150-9"><a href="#cb150-9" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb150-10"><a href="#cb150-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb150-11"><a href="#cb150-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate summary metrics</span></span>
<span id="cb150-12"><a href="#cb150-12" aria-hidden="true" tabindex="-1"></a>prob_summary <span class="ot">&lt;-</span> pred_normalized <span class="sc">%&gt;%</span></span>
<span id="cb150-13"><a href="#cb150-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(hex_id) <span class="sc">%&gt;%</span></span>
<span id="cb150-14"><a href="#cb150-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb150-15"><a href="#cb150-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">dominant_mint =</span> mint_region[<span class="fu">which.max</span>(expected_prop)],</span>
<span id="cb150-16"><a href="#cb150-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">max_prop =</span> <span class="fu">max</span>(expected_prop),</span>
<span id="cb150-17"><a href="#cb150-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">entropy =</span> <span class="sc">-</span><span class="fu">sum</span>(expected_prop <span class="sc">*</span> <span class="fu">log</span>(expected_prop <span class="sc">+</span> <span class="fl">1e-10</span>)),</span>
<span id="cb150-18"><a href="#cb150-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">rome_prop =</span> <span class="fu">sum</span>(expected_prop[mint_region <span class="sc">==</span> <span class="st">"ROME"</span>]),</span>
<span id="cb150-19"><a href="#cb150-19" aria-hidden="true" tabindex="-1"></a>    <span class="at">.groups =</span> <span class="st">"drop"</span></span>
<span id="cb150-20"><a href="#cb150-20" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb150-21"><a href="#cb150-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb150-22"><a href="#cb150-22" aria-hidden="true" tabindex="-1"></a><span class="co"># Join to hex grid</span></span>
<span id="cb150-23"><a href="#cb150-23" aria-hidden="true" tabindex="-1"></a>hex_probs <span class="ot">&lt;-</span> hex_land <span class="sc">%&gt;%</span></span>
<span id="cb150-24"><a href="#cb150-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(prob_wide, <span class="at">by =</span> <span class="st">"hex_id"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb150-25"><a href="#cb150-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(prob_summary, <span class="at">by =</span> <span class="st">"hex_id"</span>)</span>
<span id="cb150-26"><a href="#cb150-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb150-27"><a href="#cb150-27" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"✓ Multi-layer spatial object created</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>✓ Multi-layer spatial object created</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb152"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb152-1"><a href="#cb152-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"  Columns:"</span>, <span class="fu">ncol</span>(hex_probs), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>  Columns: 18 </code></pre>
</div>
</div>
<hr>
</section>
</section>
<section id="chunk-5-visualization" class="level1" data-number="7">
<h1 data-number="7"><span class="header-section-number">7</span> CHUNK 5: Visualization</h1>
<section id="rome-proportion-surface" class="level2" data-number="7.1">
<h2 data-number="7.1" class="anchored" data-anchor-id="rome-proportion-surface"><span class="header-section-number">7.1</span> 5.1 Rome Proportion Surface</h2>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb154"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb154-1"><a href="#cb154-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Rome proportion map</span></span>
<span id="cb154-2"><a href="#cb154-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb154-3"><a href="#cb154-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> land_simple, <span class="at">fill =</span> <span class="st">"grey95"</span>, <span class="at">color =</span> <span class="st">"grey70"</span>) <span class="sc">+</span></span>
<span id="cb154-4"><a href="#cb154-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> hex_probs, <span class="fu">aes</span>(<span class="at">fill =</span> expected_prop_ROME), <span class="at">color =</span> <span class="cn">NA</span>) <span class="sc">+</span></span>
<span id="cb154-5"><a href="#cb154-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">data =</span> mint_region_coords <span class="sc">%&gt;%</span> <span class="fu">filter</span>(mint_region <span class="sc">==</span> <span class="st">"ROME"</span>),</span>
<span id="cb154-6"><a href="#cb154-6" aria-hidden="true" tabindex="-1"></a>             <span class="fu">aes</span>(<span class="at">x =</span> region_lon, <span class="at">y =</span> region_lat), </span>
<span id="cb154-7"><a href="#cb154-7" aria-hidden="true" tabindex="-1"></a>             <span class="at">shape =</span> <span class="dv">8</span>, <span class="at">size =</span> <span class="dv">5</span>, <span class="at">color =</span> <span class="st">"black"</span>, <span class="at">stroke =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb154-8"><a href="#cb154-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_viridis_c</span>(</span>
<span id="cb154-9"><a href="#cb154-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">name =</span> <span class="st">"Expected</span><span class="sc">\n</span><span class="st">Rome %"</span>,</span>
<span id="cb154-10"><a href="#cb154-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">option =</span> <span class="st">"plasma"</span>,</span>
<span id="cb154-11"><a href="#cb154-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">labels =</span> scales<span class="sc">::</span><span class="fu">percent_format</span>(),</span>
<span id="cb154-12"><a href="#cb154-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb154-13"><a href="#cb154-13" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb154-14"><a href="#cb154-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_sf</span>(<span class="at">xlim =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">10</span>, <span class="dv">42</span>), <span class="at">ylim =</span> <span class="fu">c</span>(<span class="dv">30</span>, <span class="dv">55</span>)) <span class="sc">+</span></span>
<span id="cb154-15"><a href="#cb154-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb154-16"><a href="#cb154-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Expected Proportion of Rome-Minted Coins"</span>,</span>
<span id="cb154-17"><a href="#cb154-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Based on hierarchical diffusion model | Star = Rome"</span></span>
<span id="cb154-18"><a href="#cb154-18" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb154-19"><a href="#cb154-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb154-20"><a href="#cb154-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">axis.text =</span> <span class="fu">element_blank</span>(), <span class="at">axis.title =</span> <span class="fu">element_blank</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="circulation_model_files/figure-html/map-rome-prop-1.png" class="img-fluid figure-img" width="1344"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="dominant-mint-map" class="level2" data-number="7.2">
<h2 data-number="7.2" class="anchored" data-anchor-id="dominant-mint-map"><span class="header-section-number">7.2</span> 5.2 Dominant Mint Map</h2>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb155"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb155-1"><a href="#cb155-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb155-2"><a href="#cb155-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> land_simple, <span class="at">fill =</span> <span class="st">"grey95"</span>, <span class="at">color =</span> <span class="st">"grey70"</span>) <span class="sc">+</span></span>
<span id="cb155-3"><a href="#cb155-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> hex_probs, <span class="fu">aes</span>(<span class="at">fill =</span> dominant_mint), <span class="at">color =</span> <span class="st">"white"</span>, <span class="at">linewidth =</span> <span class="fl">0.1</span>) <span class="sc">+</span></span>
<span id="cb155-4"><a href="#cb155-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">data =</span> mint_region_coords,</span>
<span id="cb155-5"><a href="#cb155-5" aria-hidden="true" tabindex="-1"></a>             <span class="fu">aes</span>(<span class="at">x =</span> region_lon, <span class="at">y =</span> region_lat, <span class="at">color =</span> mint_region),</span>
<span id="cb155-6"><a href="#cb155-6" aria-hidden="true" tabindex="-1"></a>             <span class="at">shape =</span> <span class="dv">17</span>, <span class="at">size =</span> <span class="dv">4</span>) <span class="sc">+</span></span>
<span id="cb155-7"><a href="#cb155-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> region_colors, <span class="at">name =</span> <span class="st">"Dominant</span><span class="sc">\n</span><span class="st">Mint"</span>) <span class="sc">+</span></span>
<span id="cb155-8"><a href="#cb155-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values =</span> region_colors, <span class="at">guide =</span> <span class="st">"none"</span>) <span class="sc">+</span></span>
<span id="cb155-9"><a href="#cb155-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_sf</span>(<span class="at">xlim =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">10</span>, <span class="dv">42</span>), <span class="at">ylim =</span> <span class="fu">c</span>(<span class="dv">30</span>, <span class="dv">55</span>)) <span class="sc">+</span></span>
<span id="cb155-10"><a href="#cb155-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb155-11"><a href="#cb155-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Dominant Mint Region by Location"</span>,</span>
<span id="cb155-12"><a href="#cb155-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Which mint is expected to contribute most coins?"</span></span>
<span id="cb155-13"><a href="#cb155-13" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb155-14"><a href="#cb155-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb155-15"><a href="#cb155-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">axis.text =</span> <span class="fu">element_blank</span>(), <span class="at">axis.title =</span> <span class="fu">element_blank</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="circulation_model_files/figure-html/map-dominant-1.png" class="img-fluid figure-img" width="1344"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="compositional-entropy-map" class="level2" data-number="7.3">
<h2 data-number="7.3" class="anchored" data-anchor-id="compositional-entropy-map"><span class="header-section-number">7.3</span> 5.3 Compositional Entropy Map</h2>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb156"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb156-1"><a href="#cb156-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb156-2"><a href="#cb156-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> land_simple, <span class="at">fill =</span> <span class="st">"grey95"</span>, <span class="at">color =</span> <span class="st">"grey70"</span>) <span class="sc">+</span></span>
<span id="cb156-3"><a href="#cb156-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> hex_probs, <span class="fu">aes</span>(<span class="at">fill =</span> entropy), <span class="at">color =</span> <span class="cn">NA</span>) <span class="sc">+</span></span>
<span id="cb156-4"><a href="#cb156-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">data =</span> mint_region_coords,</span>
<span id="cb156-5"><a href="#cb156-5" aria-hidden="true" tabindex="-1"></a>             <span class="fu">aes</span>(<span class="at">x =</span> region_lon, <span class="at">y =</span> region_lat),</span>
<span id="cb156-6"><a href="#cb156-6" aria-hidden="true" tabindex="-1"></a>             <span class="at">shape =</span> <span class="dv">17</span>, <span class="at">size =</span> <span class="dv">3</span>, <span class="at">color =</span> <span class="st">"black"</span>) <span class="sc">+</span></span>
<span id="cb156-7"><a href="#cb156-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_viridis_c</span>(</span>
<span id="cb156-8"><a href="#cb156-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">name =</span> <span class="st">"Entropy"</span>,</span>
<span id="cb156-9"><a href="#cb156-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">option =</span> <span class="st">"viridis"</span></span>
<span id="cb156-10"><a href="#cb156-10" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb156-11"><a href="#cb156-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_sf</span>(<span class="at">xlim =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">10</span>, <span class="dv">42</span>), <span class="at">ylim =</span> <span class="fu">c</span>(<span class="dv">30</span>, <span class="dv">55</span>)) <span class="sc">+</span></span>
<span id="cb156-12"><a href="#cb156-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb156-13"><a href="#cb156-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Compositional Diversity (Entropy)"</span>,</span>
<span id="cb156-14"><a href="#cb156-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Higher entropy = more mixed sources | Triangles = mint region centroids"</span></span>
<span id="cb156-15"><a href="#cb156-15" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb156-16"><a href="#cb156-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb156-17"><a href="#cb156-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">axis.text =</span> <span class="fu">element_blank</span>(), <span class="at">axis.title =</span> <span class="fu">element_blank</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="circulation_model_files/figure-html/map-entropy-1.png" class="img-fluid figure-img" width="1344"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="individual-mint-surfaces" class="level2" data-number="7.4">
<h2 data-number="7.4" class="anchored" data-anchor-id="individual-mint-surfaces"><span class="header-section-number">7.4</span> 5.4 Individual Mint Surfaces</h2>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb157"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb157-1"><a href="#cb157-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create individual panels for each mint region</span></span>
<span id="cb157-2"><a href="#cb157-2" aria-hidden="true" tabindex="-1"></a>mint_panels <span class="ot">&lt;-</span> pred_normalized <span class="sc">%&gt;%</span></span>
<span id="cb157-3"><a href="#cb157-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(mint_region <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"ROME"</span>, <span class="st">"HISP"</span>, <span class="st">"GALL"</span>, <span class="st">"GREC"</span>, <span class="st">"ASIA"</span>, <span class="st">"ITAL"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb157-4"><a href="#cb157-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(hex_land <span class="sc">%&gt;%</span> <span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">select</span>(hex_id, cent_lon, cent_lat),</span>
<span id="cb157-5"><a href="#cb157-5" aria-hidden="true" tabindex="-1"></a>            <span class="at">by =</span> <span class="st">"hex_id"</span>)</span>
<span id="cb157-6"><a href="#cb157-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb157-7"><a href="#cb157-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Get hex geometries</span></span>
<span id="cb157-8"><a href="#cb157-8" aria-hidden="true" tabindex="-1"></a>hex_for_plot <span class="ot">&lt;-</span> hex_land <span class="sc">%&gt;%</span></span>
<span id="cb157-9"><a href="#cb157-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">inner_join</span>(</span>
<span id="cb157-10"><a href="#cb157-10" aria-hidden="true" tabindex="-1"></a>    pred_normalized <span class="sc">%&gt;%</span> </span>
<span id="cb157-11"><a href="#cb157-11" aria-hidden="true" tabindex="-1"></a>      <span class="fu">filter</span>(mint_region <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"ROME"</span>, <span class="st">"HISP"</span>, <span class="st">"GALL"</span>, <span class="st">"GREC"</span>, <span class="st">"ASIA"</span>, <span class="st">"ITAL"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb157-12"><a href="#cb157-12" aria-hidden="true" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">select</span>(hex_id, mint_region, expected_prop),</span>
<span id="cb157-13"><a href="#cb157-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">by =</span> <span class="st">"hex_id"</span></span>
<span id="cb157-14"><a href="#cb157-14" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb157-15"><a href="#cb157-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb157-16"><a href="#cb157-16" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb157-17"><a href="#cb157-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> land_simple, <span class="at">fill =</span> <span class="st">"grey95"</span>, <span class="at">color =</span> <span class="st">"grey70"</span>) <span class="sc">+</span></span>
<span id="cb157-18"><a href="#cb157-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> hex_for_plot, <span class="fu">aes</span>(<span class="at">fill =</span> expected_prop), <span class="at">color =</span> <span class="cn">NA</span>) <span class="sc">+</span></span>
<span id="cb157-19"><a href="#cb157-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">data =</span> mint_region_coords <span class="sc">%&gt;%</span> </span>
<span id="cb157-20"><a href="#cb157-20" aria-hidden="true" tabindex="-1"></a>               <span class="fu">filter</span>(mint_region <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"ROME"</span>, <span class="st">"HISP"</span>, <span class="st">"GALL"</span>, <span class="st">"GREC"</span>, <span class="st">"ASIA"</span>, <span class="st">"ITAL"</span>)),</span>
<span id="cb157-21"><a href="#cb157-21" aria-hidden="true" tabindex="-1"></a>             <span class="fu">aes</span>(<span class="at">x =</span> region_lon, <span class="at">y =</span> region_lat),</span>
<span id="cb157-22"><a href="#cb157-22" aria-hidden="true" tabindex="-1"></a>             <span class="at">shape =</span> <span class="dv">8</span>, <span class="at">size =</span> <span class="dv">3</span>, <span class="at">color =</span> <span class="st">"black"</span>, <span class="at">stroke =</span> <span class="fl">1.5</span>) <span class="sc">+</span></span>
<span id="cb157-23"><a href="#cb157-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>mint_region, <span class="at">ncol =</span> <span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb157-24"><a href="#cb157-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_viridis_c</span>(</span>
<span id="cb157-25"><a href="#cb157-25" aria-hidden="true" tabindex="-1"></a>    <span class="at">name =</span> <span class="st">"Expected</span><span class="sc">\n</span><span class="st">Proportion"</span>,</span>
<span id="cb157-26"><a href="#cb157-26" aria-hidden="true" tabindex="-1"></a>    <span class="at">option =</span> <span class="st">"plasma"</span>,</span>
<span id="cb157-27"><a href="#cb157-27" aria-hidden="true" tabindex="-1"></a>    <span class="at">labels =</span> scales<span class="sc">::</span><span class="fu">percent_format</span>()</span>
<span id="cb157-28"><a href="#cb157-28" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb157-29"><a href="#cb157-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_sf</span>(<span class="at">xlim =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">10</span>, <span class="dv">42</span>), <span class="at">ylim =</span> <span class="fu">c</span>(<span class="dv">30</span>, <span class="dv">55</span>)) <span class="sc">+</span></span>
<span id="cb157-30"><a href="#cb157-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb157-31"><a href="#cb157-31" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Expected Coin Proportion by Mint Region"</span>,</span>
<span id="cb157-32"><a href="#cb157-32" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Stars = mint centroid locations"</span></span>
<span id="cb157-33"><a href="#cb157-33" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb157-34"><a href="#cb157-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb157-35"><a href="#cb157-35" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb157-36"><a href="#cb157-36" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.text =</span> <span class="fu">element_blank</span>(), </span>
<span id="cb157-37"><a href="#cb157-37" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.title =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb157-38"><a href="#cb157-38" aria-hidden="true" tabindex="-1"></a>    <span class="at">strip.text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">12</span>, <span class="at">face =</span> <span class="st">"bold"</span>)</span>
<span id="cb157-39"><a href="#cb157-39" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="circulation_model_files/figure-html/map-all-mints-1.png" class="img-fluid figure-img" width="1536"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="mint-catchment-areas" class="level2" data-number="7.5">
<h2 data-number="7.5" class="anchored" data-anchor-id="mint-catchment-areas"><span class="header-section-number">7.5</span> 5.5 Mint Catchment Areas</h2>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb158"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb158-1"><a href="#cb158-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Define catchment as area where mint is dominant or &gt;20% share</span></span>
<span id="cb158-2"><a href="#cb158-2" aria-hidden="true" tabindex="-1"></a>catchment_data <span class="ot">&lt;-</span> pred_normalized <span class="sc">%&gt;%</span></span>
<span id="cb158-3"><a href="#cb158-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(expected_prop <span class="sc">&gt;</span> <span class="fl">0.15</span>) <span class="sc">%&gt;%</span></span>
<span id="cb158-4"><a href="#cb158-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(hex_land <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">select</span>(hex_id), <span class="at">by =</span> <span class="st">"hex_id"</span>)</span>
<span id="cb158-5"><a href="#cb158-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb158-6"><a href="#cb158-6" aria-hidden="true" tabindex="-1"></a>catchment_sf <span class="ot">&lt;-</span> hex_land <span class="sc">%&gt;%</span></span>
<span id="cb158-7"><a href="#cb158-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">inner_join</span>(</span>
<span id="cb158-8"><a href="#cb158-8" aria-hidden="true" tabindex="-1"></a>    catchment_data <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">select</span>(hex_id, mint_region, expected_prop),</span>
<span id="cb158-9"><a href="#cb158-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">by =</span> <span class="st">"hex_id"</span></span>
<span id="cb158-10"><a href="#cb158-10" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb158-11"><a href="#cb158-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb158-12"><a href="#cb158-12" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb158-13"><a href="#cb158-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> land_simple, <span class="at">fill =</span> <span class="st">"grey95"</span>, <span class="at">color =</span> <span class="st">"grey70"</span>) <span class="sc">+</span></span>
<span id="cb158-14"><a href="#cb158-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> catchment_sf, <span class="fu">aes</span>(<span class="at">fill =</span> mint_region), <span class="at">alpha =</span> <span class="fl">0.6</span>, <span class="at">color =</span> <span class="st">"white"</span>, <span class="at">linewidth =</span> <span class="fl">0.1</span>) <span class="sc">+</span></span>
<span id="cb158-15"><a href="#cb158-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">data =</span> mint_region_coords,</span>
<span id="cb158-16"><a href="#cb158-16" aria-hidden="true" tabindex="-1"></a>             <span class="fu">aes</span>(<span class="at">x =</span> region_lon, <span class="at">y =</span> region_lat, <span class="at">color =</span> mint_region),</span>
<span id="cb158-17"><a href="#cb158-17" aria-hidden="true" tabindex="-1"></a>             <span class="at">shape =</span> <span class="dv">17</span>, <span class="at">size =</span> <span class="dv">5</span>) <span class="sc">+</span></span>
<span id="cb158-18"><a href="#cb158-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> region_colors, <span class="at">name =</span> <span class="st">"Mint Region"</span>) <span class="sc">+</span></span>
<span id="cb158-19"><a href="#cb158-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values =</span> region_colors, <span class="at">guide =</span> <span class="st">"none"</span>) <span class="sc">+</span></span>
<span id="cb158-20"><a href="#cb158-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_sf</span>(<span class="at">xlim =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">10</span>, <span class="dv">42</span>), <span class="at">ylim =</span> <span class="fu">c</span>(<span class="dv">30</span>, <span class="dv">55</span>)) <span class="sc">+</span></span>
<span id="cb158-21"><a href="#cb158-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb158-22"><a href="#cb158-22" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Mint Catchment Areas (&gt;15% expected share)"</span>,</span>
<span id="cb158-23"><a href="#cb158-23" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Overlapping areas show competing mint influences"</span></span>
<span id="cb158-24"><a href="#cb158-24" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb158-25"><a href="#cb158-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb158-26"><a href="#cb158-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">axis.text =</span> <span class="fu">element_blank</span>(), <span class="at">axis.title =</span> <span class="fu">element_blank</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="circulation_model_files/figure-html/catchment-areas-1.png" class="img-fluid figure-img" width="1344"></p>
</figure>
</div>
</div>
</div>
<hr>
</section>
</section>
<section id="chunk-6-validation-interpretation" class="level1" data-number="8">
<h1 data-number="8"><span class="header-section-number">8</span> CHUNK 6: Validation &amp; Interpretation</h1>
<section id="cross-validation" class="level2" data-number="8.1">
<h2 data-number="8.1" class="anchored" data-anchor-id="cross-validation"><span class="header-section-number">8.1</span> 6.1 Cross-Validation</h2>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb159"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb159-1"><a href="#cb159-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Simple validation: compare predicted vs observed for hoards</span></span>
<span id="cb159-2"><a href="#cb159-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Aggregate observed data to hoard level by mint region</span></span>
<span id="cb159-3"><a href="#cb159-3" aria-hidden="true" tabindex="-1"></a>observed_props <span class="ot">&lt;-</span> hoard_mint <span class="sc">%&gt;%</span></span>
<span id="cb159-4"><a href="#cb159-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(mint_region <span class="sc">%in%</span> mint_region_coords<span class="sc">$</span>mint_region) <span class="sc">%&gt;%</span></span>
<span id="cb159-5"><a href="#cb159-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(hoard_id, hoard_lat, hoard_long, mint_region) <span class="sc">%&gt;%</span></span>
<span id="cb159-6"><a href="#cb159-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb159-7"><a href="#cb159-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">observed_prop =</span> <span class="fu">sum</span>(n_types) <span class="sc">/</span> <span class="fu">first</span>(n_total),</span>
<span id="cb159-8"><a href="#cb159-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">n_total =</span> <span class="fu">first</span>(n_total),</span>
<span id="cb159-9"><a href="#cb159-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">.groups =</span> <span class="st">"drop"</span></span>
<span id="cb159-10"><a href="#cb159-10" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb159-11"><a href="#cb159-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb159-12"><a href="#cb159-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Find nearest hex for each hoard</span></span>
<span id="cb159-13"><a href="#cb159-13" aria-hidden="true" tabindex="-1"></a>hoard_sf <span class="ot">&lt;-</span> observed_props <span class="sc">%&gt;%</span></span>
<span id="cb159-14"><a href="#cb159-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">distinct</span>(hoard_id, hoard_lat, hoard_long) <span class="sc">%&gt;%</span></span>
<span id="cb159-15"><a href="#cb159-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_as_sf</span>(<span class="at">coords =</span> <span class="fu">c</span>(<span class="st">"hoard_long"</span>, <span class="st">"hoard_lat"</span>), <span class="at">crs =</span> <span class="dv">4326</span>)</span>
<span id="cb159-16"><a href="#cb159-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb159-17"><a href="#cb159-17" aria-hidden="true" tabindex="-1"></a>hex_centroids_sf <span class="ot">&lt;-</span> hex_land <span class="sc">%&gt;%</span> <span class="fu">st_centroid</span>()</span>
<span id="cb159-18"><a href="#cb159-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb159-19"><a href="#cb159-19" aria-hidden="true" tabindex="-1"></a>nearest_hex <span class="ot">&lt;-</span> <span class="fu">st_nearest_feature</span>(hoard_sf, hex_centroids_sf)</span>
<span id="cb159-20"><a href="#cb159-20" aria-hidden="true" tabindex="-1"></a>hoard_hex_map <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb159-21"><a href="#cb159-21" aria-hidden="true" tabindex="-1"></a>  <span class="at">hoard_id =</span> hoard_sf<span class="sc">$</span>hoard_id,</span>
<span id="cb159-22"><a href="#cb159-22" aria-hidden="true" tabindex="-1"></a>  <span class="at">hex_id =</span> hex_land<span class="sc">$</span>hex_id[nearest_hex]</span>
<span id="cb159-23"><a href="#cb159-23" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb159-24"><a href="#cb159-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb159-25"><a href="#cb159-25" aria-hidden="true" tabindex="-1"></a><span class="co"># Join predictions to observations</span></span>
<span id="cb159-26"><a href="#cb159-26" aria-hidden="true" tabindex="-1"></a>validation <span class="ot">&lt;-</span> observed_props <span class="sc">%&gt;%</span></span>
<span id="cb159-27"><a href="#cb159-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(hoard_hex_map, <span class="at">by =</span> <span class="st">"hoard_id"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb159-28"><a href="#cb159-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(</span>
<span id="cb159-29"><a href="#cb159-29" aria-hidden="true" tabindex="-1"></a>    pred_normalized <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">select</span>(hex_id, mint_region, expected_prop),</span>
<span id="cb159-30"><a href="#cb159-30" aria-hidden="true" tabindex="-1"></a>    <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"hex_id"</span>, <span class="st">"mint_region"</span>)</span>
<span id="cb159-31"><a href="#cb159-31" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb159-32"><a href="#cb159-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(expected_prop))</span>
<span id="cb159-33"><a href="#cb159-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb159-34"><a href="#cb159-34" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate metrics</span></span>
<span id="cb159-35"><a href="#cb159-35" aria-hidden="true" tabindex="-1"></a>validation_metrics <span class="ot">&lt;-</span> validation <span class="sc">%&gt;%</span></span>
<span id="cb159-36"><a href="#cb159-36" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(mint_region) <span class="sc">%&gt;%</span></span>
<span id="cb159-37"><a href="#cb159-37" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb159-38"><a href="#cb159-38" aria-hidden="true" tabindex="-1"></a>    <span class="at">n_obs =</span> <span class="fu">n</span>(),</span>
<span id="cb159-39"><a href="#cb159-39" aria-hidden="true" tabindex="-1"></a>    <span class="at">rmse =</span> <span class="fu">sqrt</span>(<span class="fu">mean</span>((observed_prop <span class="sc">-</span> expected_prop)<span class="sc">^</span><span class="dv">2</span>)),</span>
<span id="cb159-40"><a href="#cb159-40" aria-hidden="true" tabindex="-1"></a>    <span class="at">mae =</span> <span class="fu">mean</span>(<span class="fu">abs</span>(observed_prop <span class="sc">-</span> expected_prop)),</span>
<span id="cb159-41"><a href="#cb159-41" aria-hidden="true" tabindex="-1"></a>    <span class="at">cor =</span> <span class="fu">cor</span>(observed_prop, expected_prop, <span class="at">use =</span> <span class="st">"complete.obs"</span>),</span>
<span id="cb159-42"><a href="#cb159-42" aria-hidden="true" tabindex="-1"></a>    <span class="at">.groups =</span> <span class="st">"drop"</span></span>
<span id="cb159-43"><a href="#cb159-43" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb159-44"><a href="#cb159-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb159-45"><a href="#cb159-45" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Validation metrics by mint region:</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
Validation metrics by mint region:</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb161"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb161-1"><a href="#cb161-1" aria-hidden="true" tabindex="-1"></a><span class="fu">kable</span>(validation_metrics, <span class="at">digits =</span> <span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<table class="caption-top table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: left;">mint_region</th>
<th style="text-align: right;">n_obs</th>
<th style="text-align: right;">rmse</th>
<th style="text-align: right;">mae</th>
<th style="text-align: right;">cor</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">AFRI</td>
<td style="text-align: right;">34</td>
<td style="text-align: right;">0.056</td>
<td style="text-align: right;">0.035</td>
<td style="text-align: right;">-0.095</td>
</tr>
<tr class="even">
<td style="text-align: left;">GALL</td>
<td style="text-align: right;">175</td>
<td style="text-align: right;">0.050</td>
<td style="text-align: right;">0.028</td>
<td style="text-align: right;">0.147</td>
</tr>
<tr class="odd">
<td style="text-align: left;">GREC</td>
<td style="text-align: right;">24</td>
<td style="text-align: right;">0.019</td>
<td style="text-align: right;">0.014</td>
<td style="text-align: right;">-0.233</td>
</tr>
<tr class="even">
<td style="text-align: left;">ITAL</td>
<td style="text-align: right;">195</td>
<td style="text-align: right;">0.061</td>
<td style="text-align: right;">0.036</td>
<td style="text-align: right;">0.045</td>
</tr>
<tr class="odd">
<td style="text-align: left;">ROME</td>
<td style="text-align: right;">461</td>
<td style="text-align: right;">0.063</td>
<td style="text-align: right;">0.030</td>
<td style="text-align: right;">-0.019</td>
</tr>
</tbody>
</table>
</div>
</div>
</section>
<section id="observed-vs-predicted-plot" class="level2" data-number="8.2">
<h2 data-number="8.2" class="anchored" data-anchor-id="observed-vs-predicted-plot"><span class="header-section-number">8.2</span> 6.2 Observed vs Predicted Plot</h2>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb162"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb162-1"><a href="#cb162-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(validation <span class="sc">%&gt;%</span> <span class="fu">filter</span>(mint_region <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"ROME"</span>, <span class="st">"HISP"</span>, <span class="st">"GREC"</span>, <span class="st">"GALL"</span>)), </span>
<span id="cb162-2"><a href="#cb162-2" aria-hidden="true" tabindex="-1"></a>       <span class="fu">aes</span>(<span class="at">x =</span> expected_prop, <span class="at">y =</span> observed_prop)) <span class="sc">+</span></span>
<span id="cb162-3"><a href="#cb162-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_abline</span>(<span class="at">slope =</span> <span class="dv">1</span>, <span class="at">intercept =</span> <span class="dv">0</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">color =</span> <span class="st">"grey50"</span>) <span class="sc">+</span></span>
<span id="cb162-4"><a href="#cb162-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">alpha =</span> <span class="fl">0.3</span>, <span class="at">size =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb162-5"><a href="#cb162-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_smooth</span>(<span class="at">method =</span> <span class="st">"lm"</span>, <span class="at">color =</span> <span class="st">"darkred"</span>, <span class="at">se =</span> <span class="cn">TRUE</span>) <span class="sc">+</span></span>
<span id="cb162-6"><a href="#cb162-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>mint_region, <span class="at">scales =</span> <span class="st">"free"</span>) <span class="sc">+</span></span>
<span id="cb162-7"><a href="#cb162-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">labels =</span> scales<span class="sc">::</span><span class="fu">percent_format</span>()) <span class="sc">+</span></span>
<span id="cb162-8"><a href="#cb162-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">labels =</span> scales<span class="sc">::</span><span class="fu">percent_format</span>()) <span class="sc">+</span></span>
<span id="cb162-9"><a href="#cb162-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb162-10"><a href="#cb162-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Observed vs Predicted Mint Proportions"</span>,</span>
<span id="cb162-11"><a href="#cb162-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Dashed line = perfect prediction; red line = actual fit"</span>,</span>
<span id="cb162-12"><a href="#cb162-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Predicted proportion (from model)"</span>,</span>
<span id="cb162-13"><a href="#cb162-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Observed proportion (in hoards)"</span></span>
<span id="cb162-14"><a href="#cb162-14" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb162-15"><a href="#cb162-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="circulation_model_files/figure-html/obs-vs-pred-1.png" class="img-fluid figure-img" width="1152"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="residual-mapping" class="level2" data-number="8.3">
<h2 data-number="8.3" class="anchored" data-anchor-id="residual-mapping"><span class="header-section-number">8.3</span> 6.3 Residual Mapping</h2>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb163"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb163-1"><a href="#cb163-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate residuals for Rome - get coordinates from hoard_mint</span></span>
<span id="cb163-2"><a href="#cb163-2" aria-hidden="true" tabindex="-1"></a>rome_residuals <span class="ot">&lt;-</span> validation <span class="sc">%&gt;%</span></span>
<span id="cb163-3"><a href="#cb163-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(mint_region <span class="sc">==</span> <span class="st">"ROME"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb163-4"><a href="#cb163-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">residual =</span> observed_prop <span class="sc">-</span> expected_prop)</span>
<span id="cb163-5"><a href="#cb163-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb163-6"><a href="#cb163-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Check if we have hoard_lat in validation, if not join it</span></span>
<span id="cb163-7"><a href="#cb163-7" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="st">"hoard_lat"</span> <span class="sc">%in%</span> <span class="fu">names</span>(rome_residuals)) {</span>
<span id="cb163-8"><a href="#cb163-8" aria-hidden="true" tabindex="-1"></a>  rome_residuals <span class="ot">&lt;-</span> rome_residuals <span class="sc">%&gt;%</span></span>
<span id="cb163-9"><a href="#cb163-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">left_join</span>(</span>
<span id="cb163-10"><a href="#cb163-10" aria-hidden="true" tabindex="-1"></a>      hoard_mint <span class="sc">%&gt;%</span> </span>
<span id="cb163-11"><a href="#cb163-11" aria-hidden="true" tabindex="-1"></a>        <span class="fu">distinct</span>(hoard_id, hoard_lat, hoard_long),</span>
<span id="cb163-12"><a href="#cb163-12" aria-hidden="true" tabindex="-1"></a>      <span class="at">by =</span> <span class="st">"hoard_id"</span></span>
<span id="cb163-13"><a href="#cb163-13" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb163-14"><a href="#cb163-14" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb163-15"><a href="#cb163-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb163-16"><a href="#cb163-16" aria-hidden="true" tabindex="-1"></a>rome_resid_sf <span class="ot">&lt;-</span> rome_residuals <span class="sc">%&gt;%</span></span>
<span id="cb163-17"><a href="#cb163-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(hoard_lat), <span class="sc">!</span><span class="fu">is.na</span>(hoard_long)) <span class="sc">%&gt;%</span></span>
<span id="cb163-18"><a href="#cb163-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_as_sf</span>(<span class="at">coords =</span> <span class="fu">c</span>(<span class="st">"hoard_long"</span>, <span class="st">"hoard_lat"</span>), <span class="at">crs =</span> <span class="dv">4326</span>)</span>
<span id="cb163-19"><a href="#cb163-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb163-20"><a href="#cb163-20" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">nrow</span>(rome_resid_sf) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb163-21"><a href="#cb163-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb163-22"><a href="#cb163-22" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_sf</span>(<span class="at">data =</span> land_simple, <span class="at">fill =</span> <span class="st">"grey95"</span>, <span class="at">color =</span> <span class="st">"grey70"</span>) <span class="sc">+</span></span>
<span id="cb163-23"><a href="#cb163-23" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_sf</span>(<span class="at">data =</span> rome_resid_sf, <span class="fu">aes</span>(<span class="at">color =</span> residual), <span class="at">size =</span> <span class="dv">2</span>, <span class="at">alpha =</span> <span class="fl">0.7</span>) <span class="sc">+</span></span>
<span id="cb163-24"><a href="#cb163-24" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_color_gradient2</span>(</span>
<span id="cb163-25"><a href="#cb163-25" aria-hidden="true" tabindex="-1"></a>      <span class="at">name =</span> <span class="st">"Residual</span><span class="sc">\n</span><span class="st">(Obs - Pred)"</span>,</span>
<span id="cb163-26"><a href="#cb163-26" aria-hidden="true" tabindex="-1"></a>      <span class="at">low =</span> <span class="st">"blue"</span>, <span class="at">mid =</span> <span class="st">"white"</span>, <span class="at">high =</span> <span class="st">"red"</span>,</span>
<span id="cb163-27"><a href="#cb163-27" aria-hidden="true" tabindex="-1"></a>      <span class="at">midpoint =</span> <span class="dv">0</span>,</span>
<span id="cb163-28"><a href="#cb163-28" aria-hidden="true" tabindex="-1"></a>      <span class="at">limits =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="fl">0.5</span>, <span class="fl">0.5</span>),</span>
<span id="cb163-29"><a href="#cb163-29" aria-hidden="true" tabindex="-1"></a>      <span class="at">oob =</span> scales<span class="sc">::</span>squish</span>
<span id="cb163-30"><a href="#cb163-30" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb163-31"><a href="#cb163-31" aria-hidden="true" tabindex="-1"></a>    <span class="fu">coord_sf</span>(<span class="at">xlim =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">10</span>, <span class="dv">42</span>), <span class="at">ylim =</span> <span class="fu">c</span>(<span class="dv">30</span>, <span class="dv">55</span>)) <span class="sc">+</span></span>
<span id="cb163-32"><a href="#cb163-32" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(</span>
<span id="cb163-33"><a href="#cb163-33" aria-hidden="true" tabindex="-1"></a>      <span class="at">title =</span> <span class="st">"Rome Proportion Residuals"</span>,</span>
<span id="cb163-34"><a href="#cb163-34" aria-hidden="true" tabindex="-1"></a>      <span class="at">subtitle =</span> <span class="st">"Red = more Rome coins than expected | Blue = fewer than expected"</span></span>
<span id="cb163-35"><a href="#cb163-35" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb163-36"><a href="#cb163-36" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb163-37"><a href="#cb163-37" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">axis.text =</span> <span class="fu">element_blank</span>(), <span class="at">axis.title =</span> <span class="fu">element_blank</span>())</span>
<span id="cb163-38"><a href="#cb163-38" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb163-39"><a href="#cb163-39" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"No Rome residuals to map</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb163-40"><a href="#cb163-40" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="circulation_model_files/figure-html/residual-map-1.png" class="img-fluid figure-img" width="1344"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="identify-anomalous-hoards" class="level2" data-number="8.4">
<h2 data-number="8.4" class="anchored" data-anchor-id="identify-anomalous-hoards"><span class="header-section-number">8.4</span> 6.4 Identify Anomalous Hoards</h2>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb164"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb164-1"><a href="#cb164-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Find hoards with large residuals</span></span>
<span id="cb164-2"><a href="#cb164-2" aria-hidden="true" tabindex="-1"></a>anomalies <span class="ot">&lt;-</span> validation <span class="sc">%&gt;%</span></span>
<span id="cb164-3"><a href="#cb164-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(mint_region <span class="sc">==</span> <span class="st">"ROME"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb164-4"><a href="#cb164-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">residual =</span> observed_prop <span class="sc">-</span> expected_prop) <span class="sc">%&gt;%</span></span>
<span id="cb164-5"><a href="#cb164-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">abs</span>(residual) <span class="sc">&gt;</span> <span class="fl">0.3</span>) <span class="sc">%&gt;%</span></span>
<span id="cb164-6"><a href="#cb164-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(<span class="fu">abs</span>(residual)))</span>
<span id="cb164-7"><a href="#cb164-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb164-8"><a href="#cb164-8" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Anomalous hoards (Rome residual &gt; 0.3):</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
Anomalous hoards (Rome residual &gt; 0.3):</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb166"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb166-1"><a href="#cb166-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"These may represent military pay, emergency hoards, or unusual circulation patterns</span><span class="sc">\n\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>These may represent military pay, emergency hoards, or unusual circulation patterns</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb168"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb168-1"><a href="#cb168-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">nrow</span>(anomalies) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb168-2"><a href="#cb168-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable</span>(<span class="fu">head</span>(anomalies <span class="sc">%&gt;%</span> </span>
<span id="cb168-3"><a href="#cb168-3" aria-hidden="true" tabindex="-1"></a>               dplyr<span class="sc">::</span><span class="fu">select</span>(hoard_id, observed_prop, expected_prop, residual, n_total), <span class="dv">20</span>),</span>
<span id="cb168-4"><a href="#cb168-4" aria-hidden="true" tabindex="-1"></a>        <span class="at">digits =</span> <span class="dv">3</span>,</span>
<span id="cb168-5"><a href="#cb168-5" aria-hidden="true" tabindex="-1"></a>        <span class="at">col.names =</span> <span class="fu">c</span>(<span class="st">"Hoard ID"</span>, <span class="st">"Observed Rome %"</span>, <span class="st">"Expected Rome %"</span>, <span class="st">"Residual"</span>, <span class="st">"N Types"</span>))</span>
<span id="cb168-6"><a href="#cb168-6" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb168-7"><a href="#cb168-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"No hoards with residuals &gt; 0.3</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb168-8"><a href="#cb168-8" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<table class="caption-top table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: left;">Hoard ID</th>
<th style="text-align: right;">Observed Rome %</th>
<th style="text-align: right;">Expected Rome %</th>
<th style="text-align: right;">Residual</th>
<th style="text-align: right;">N Types</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">PTS</td>
<td style="text-align: right;">0.500</td>
<td style="text-align: right;">0.999</td>
<td style="text-align: right;">-0.499</td>
<td style="text-align: right;">2</td>
</tr>
<tr class="even">
<td style="text-align: left;">CUP</td>
<td style="text-align: right;">0.556</td>
<td style="text-align: right;">0.999</td>
<td style="text-align: right;">-0.444</td>
<td style="text-align: right;">27</td>
</tr>
<tr class="odd">
<td style="text-align: left;">FAN</td>
<td style="text-align: right;">0.611</td>
<td style="text-align: right;">1.000</td>
<td style="text-align: right;">-0.388</td>
<td style="text-align: right;">18</td>
</tr>
<tr class="even">
<td style="text-align: left;">NUM</td>
<td style="text-align: right;">0.667</td>
<td style="text-align: right;">1.000</td>
<td style="text-align: right;">-0.333</td>
<td style="text-align: right;">15</td>
</tr>
<tr class="odd">
<td style="text-align: left;">FRC</td>
<td style="text-align: right;">0.667</td>
<td style="text-align: right;">1.000</td>
<td style="text-align: right;">-0.333</td>
<td style="text-align: right;">12</td>
</tr>
<tr class="even">
<td style="text-align: left;">CSN</td>
<td style="text-align: right;">0.667</td>
<td style="text-align: right;">1.000</td>
<td style="text-align: right;">-0.333</td>
<td style="text-align: right;">12</td>
</tr>
<tr class="odd">
<td style="text-align: left;">SCM</td>
<td style="text-align: right;">0.667</td>
<td style="text-align: right;">0.999</td>
<td style="text-align: right;">-0.333</td>
<td style="text-align: right;">21</td>
</tr>
</tbody>
</table>
</div>
</div>
</section>
<section id="comparison-with-hmm-regimes" class="level2" data-number="8.5">
<h2 data-number="8.5" class="anchored" data-anchor-id="comparison-with-hmm-regimes"><span class="header-section-number">8.5</span> 6.5 Comparison with HMM Regimes</h2>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb169"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb169-1"><a href="#cb169-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Compare predictions across regimes (using deposition period as proxy)</span></span>
<span id="cb169-2"><a href="#cb169-2" aria-hidden="true" tabindex="-1"></a>regime_validation <span class="ot">&lt;-</span> hoard_mint <span class="sc">%&gt;%</span></span>
<span id="cb169-3"><a href="#cb169-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(mint_region <span class="sc">==</span> <span class="st">"ROME"</span>, <span class="sc">!</span><span class="fu">is.na</span>(depo_period)) <span class="sc">%&gt;%</span></span>
<span id="cb169-4"><a href="#cb169-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(hoard_hex_map, <span class="at">by =</span> <span class="st">"hoard_id"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb169-5"><a href="#cb169-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(</span>
<span id="cb169-6"><a href="#cb169-6" aria-hidden="true" tabindex="-1"></a>    pred_normalized <span class="sc">%&gt;%</span> </span>
<span id="cb169-7"><a href="#cb169-7" aria-hidden="true" tabindex="-1"></a>      <span class="fu">filter</span>(mint_region <span class="sc">==</span> <span class="st">"ROME"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb169-8"><a href="#cb169-8" aria-hidden="true" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">select</span>(hex_id, expected_prop),</span>
<span id="cb169-9"><a href="#cb169-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">by =</span> <span class="st">"hex_id"</span></span>
<span id="cb169-10"><a href="#cb169-10" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb169-11"><a href="#cb169-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(expected_prop))</span>
<span id="cb169-12"><a href="#cb169-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb169-13"><a href="#cb169-13" aria-hidden="true" tabindex="-1"></a>regime_summary <span class="ot">&lt;-</span> regime_validation <span class="sc">%&gt;%</span></span>
<span id="cb169-14"><a href="#cb169-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(depo_period) <span class="sc">%&gt;%</span></span>
<span id="cb169-15"><a href="#cb169-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb169-16"><a href="#cb169-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">n_hoards =</span> <span class="fu">n_distinct</span>(hoard_id),</span>
<span id="cb169-17"><a href="#cb169-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">mean_observed =</span> <span class="fu">mean</span>(prop_mint),</span>
<span id="cb169-18"><a href="#cb169-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">mean_predicted =</span> <span class="fu">mean</span>(expected_prop),</span>
<span id="cb169-19"><a href="#cb169-19" aria-hidden="true" tabindex="-1"></a>    <span class="at">rmse =</span> <span class="fu">sqrt</span>(<span class="fu">mean</span>((prop_mint <span class="sc">-</span> expected_prop)<span class="sc">^</span><span class="dv">2</span>)),</span>
<span id="cb169-20"><a href="#cb169-20" aria-hidden="true" tabindex="-1"></a>    <span class="at">.groups =</span> <span class="st">"drop"</span></span>
<span id="cb169-21"><a href="#cb169-21" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb169-22"><a href="#cb169-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb169-23"><a href="#cb169-23" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Model performance by deposition period:</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
Model performance by deposition period:</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb171"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb171-1"><a href="#cb171-1" aria-hidden="true" tabindex="-1"></a><span class="fu">kable</span>(regime_summary, <span class="at">digits =</span> <span class="dv">3</span>,</span>
<span id="cb171-2"><a href="#cb171-2" aria-hidden="true" tabindex="-1"></a>      <span class="at">col.names =</span> <span class="fu">c</span>(<span class="st">"Period"</span>, <span class="st">"N Hoards"</span>, <span class="st">"Mean Observed"</span>, <span class="st">"Mean Predicted"</span>, <span class="st">"RMSE"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<table class="caption-top table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: left;">Period</th>
<th style="text-align: right;">N Hoards</th>
<th style="text-align: right;">Mean Observed</th>
<th style="text-align: right;">Mean Predicted</th>
<th style="text-align: right;">RMSE</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Early Republic</td>
<td style="text-align: right;">11</td>
<td style="text-align: right;">0.787</td>
<td style="text-align: right;">1.000</td>
<td style="text-align: right;">0.272</td>
</tr>
<tr class="even">
<td style="text-align: left;">Late Republic I</td>
<td style="text-align: right;">87</td>
<td style="text-align: right;">0.973</td>
<td style="text-align: right;">0.999</td>
<td style="text-align: right;">0.053</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Late Republic II</td>
<td style="text-align: right;">166</td>
<td style="text-align: right;">0.970</td>
<td style="text-align: right;">1.000</td>
<td style="text-align: right;">0.054</td>
</tr>
<tr class="even">
<td style="text-align: left;">Triumviral/Augustan</td>
<td style="text-align: right;">197</td>
<td style="text-align: right;">0.978</td>
<td style="text-align: right;">1.000</td>
<td style="text-align: right;">0.037</td>
</tr>
</tbody>
</table>
</div>
</div>
<hr>
</section>
</section>
<section id="summary" class="level1" data-number="9">
<h1 data-number="9"><span class="header-section-number">9</span> Summary</h1>
<section id="key-findings" class="level2" data-number="9.1">
<h2 data-number="9.1" class="anchored" data-anchor-id="key-findings"><span class="header-section-number">9.1</span> Key Findings</h2>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb172"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb172-1"><a href="#cb172-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span></span>
<span id="cb172-2"><a href="#cb172-2" aria-hidden="true" tabindex="-1"></a><span class="st">================================================================</span></span>
<span id="cb172-3"><a href="#cb172-3" aria-hidden="true" tabindex="-1"></a><span class="st">ROMAN COIN CIRCULATION MODEL: SUMMARY</span></span>
<span id="cb172-4"><a href="#cb172-4" aria-hidden="true" tabindex="-1"></a><span class="st">================================================================</span></span>
<span id="cb172-5"><a href="#cb172-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb172-6"><a href="#cb172-6" aria-hidden="true" tabindex="-1"></a><span class="st">1. MINT REGIONS CLASSIFIED</span></span>
<span id="cb172-7"><a href="#cb172-7" aria-hidden="true" tabindex="-1"></a><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
================================================================
ROMAN COIN CIRCULATION MODEL: SUMMARY
================================================================

1. MINT REGIONS CLASSIFIED</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb174"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb174-1"><a href="#cb174-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"   Total mints:"</span>, <span class="fu">nrow</span>(mint_coords), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>   Total mints: 74 </code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb176"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb176-1"><a href="#cb176-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"   With coordinates:"</span>, <span class="fu">sum</span>(<span class="sc">!</span><span class="fu">is.na</span>(mint_coords<span class="sc">$</span>mint_lat)), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>   With coordinates: 71 </code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb178"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb178-1"><a href="#cb178-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"   Regions:"</span>, <span class="fu">paste</span>(<span class="fu">unique</span>(mint_coords<span class="sc">$</span>mint_region), <span class="at">collapse =</span> <span class="st">", "</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>   Regions: ROME, UNKN, GALL, ITAL, AFRI, GREC, SICI, HISP, ASIA </code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb180"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb180-1"><a href="#cb180-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span></span>
<span id="cb180-2"><a href="#cb180-2" aria-hidden="true" tabindex="-1"></a><span class="st">2. DIFFUSION PARAMETERS</span></span>
<span id="cb180-3"><a href="#cb180-3" aria-hidden="true" tabindex="-1"></a><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
2. DIFFUSION PARAMETERS</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb182"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb182-1"><a href="#cb182-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (use_hierarchical) {</span>
<span id="cb182-2"><a href="#cb182-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"   Model type: Hierarchical (partial pooling)</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb182-3"><a href="#cb182-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"   Population-level distance decay:"</span>, <span class="fu">round</span>(<span class="fu">fixef</span>(hierarchical_model)[<span class="st">"dist_scaled"</span>], <span class="dv">3</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb182-4"><a href="#cb182-4" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb182-5"><a href="#cb182-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"   Model type: Simple (no pooling - single region only)</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb182-6"><a href="#cb182-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"   Distance decay:"</span>, <span class="fu">round</span>(<span class="fu">coef</span>(hierarchical_model)[<span class="st">"dist_scaled"</span>], <span class="dv">3</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb182-7"><a href="#cb182-7" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>   Model type: Hierarchical (partial pooling)
   Population-level distance decay: 0.155 </code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb184"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb184-1"><a href="#cb184-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"   (More negative = faster decay with distance)</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>   (More negative = faster decay with distance)</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb186"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb186-1"><a href="#cb186-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span></span>
<span id="cb186-2"><a href="#cb186-2" aria-hidden="true" tabindex="-1"></a><span class="st">3. MINT-SPECIFIC DECAY RATES</span></span>
<span id="cb186-3"><a href="#cb186-3" aria-hidden="true" tabindex="-1"></a><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
3. MINT-SPECIFIC DECAY RATES</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb188"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb188-1"><a href="#cb188-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (use_hierarchical <span class="sc">&amp;&amp;</span> <span class="fu">exists</span>(<span class="st">"random_eff"</span>) <span class="sc">&amp;&amp;</span> <span class="fu">nrow</span>(random_eff) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb188-2"><a href="#cb188-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (r <span class="cf">in</span> <span class="fu">rownames</span>(random_eff)) {</span>
<span id="cb188-3"><a href="#cb188-3" aria-hidden="true" tabindex="-1"></a>    total_slope <span class="ot">&lt;-</span> fixed_eff[<span class="st">"dist_scaled"</span>] <span class="sc">+</span> random_eff[r, <span class="st">"dist_scaled"</span>]</span>
<span id="cb188-4"><a href="#cb188-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"   "</span>, r, <span class="st">":"</span>, <span class="fu">round</span>(total_slope, <span class="dv">3</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb188-5"><a href="#cb188-5" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb188-6"><a href="#cb188-6" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb188-7"><a href="#cb188-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"   Single pooled estimate used for all regions</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb188-8"><a href="#cb188-8" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>    AFRI : 0.15 
    GALL : 0.15 
    GREC : 0.148 
    ITAL : 0.15 
    ROME : 0.176 </code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb190"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb190-1"><a href="#cb190-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span></span>
<span id="cb190-2"><a href="#cb190-2" aria-hidden="true" tabindex="-1"></a><span class="st">4. VALIDATION</span></span>
<span id="cb190-3"><a href="#cb190-3" aria-hidden="true" tabindex="-1"></a><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
4. VALIDATION</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb192"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb192-1"><a href="#cb192-1" aria-hidden="true" tabindex="-1"></a>rome_validation <span class="ot">&lt;-</span> validation <span class="sc">%&gt;%</span> <span class="fu">filter</span>(mint_region <span class="sc">==</span> <span class="st">"ROME"</span>)</span>
<span id="cb192-2"><a href="#cb192-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">nrow</span>(rome_validation) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb192-3"><a href="#cb192-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"   Overall correlation (Rome):"</span>, </span>
<span id="cb192-4"><a href="#cb192-4" aria-hidden="true" tabindex="-1"></a>      <span class="fu">round</span>(<span class="fu">cor</span>(rome_validation<span class="sc">$</span>observed_prop,</span>
<span id="cb192-5"><a href="#cb192-5" aria-hidden="true" tabindex="-1"></a>                rome_validation<span class="sc">$</span>expected_prop, </span>
<span id="cb192-6"><a href="#cb192-6" aria-hidden="true" tabindex="-1"></a>                <span class="at">use =</span> <span class="st">"complete.obs"</span>), <span class="dv">3</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb192-7"><a href="#cb192-7" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb192-8"><a href="#cb192-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"   No Rome validation data available</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb192-9"><a href="#cb192-9" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>   Overall correlation (Rome): -0.019 </code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb194"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb194-1"><a href="#cb194-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span></span>
<span id="cb194-2"><a href="#cb194-2" aria-hidden="true" tabindex="-1"></a><span class="st">5. OUTPUTS GENERATED</span></span>
<span id="cb194-3"><a href="#cb194-3" aria-hidden="true" tabindex="-1"></a><span class="st">   - Probability surfaces for each mint region</span></span>
<span id="cb194-4"><a href="#cb194-4" aria-hidden="true" tabindex="-1"></a><span class="st">   - Dominant mint map</span></span>
<span id="cb194-5"><a href="#cb194-5" aria-hidden="true" tabindex="-1"></a><span class="st">   - Compositional entropy map</span></span>
<span id="cb194-6"><a href="#cb194-6" aria-hidden="true" tabindex="-1"></a><span class="st">   - Catchment area visualization</span></span>
<span id="cb194-7"><a href="#cb194-7" aria-hidden="true" tabindex="-1"></a><span class="st">   - Residual analysis identifying anomalous hoards</span></span>
<span id="cb194-8"><a href="#cb194-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb194-9"><a href="#cb194-9" aria-hidden="true" tabindex="-1"></a><span class="st">================================================================</span></span>
<span id="cb194-10"><a href="#cb194-10" aria-hidden="true" tabindex="-1"></a><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
5. OUTPUTS GENERATED
   - Probability surfaces for each mint region
   - Dominant mint map
   - Compositional entropy map
   - Catchment area visualization
   - Residual analysis identifying anomalous hoards

================================================================</code></pre>
</div>
</div>
<hr>
</section>
</section>
<section id="export" class="level1" data-number="10">
<h1 data-number="10"><span class="header-section-number">10</span> Export</h1>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb196"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb196-1"><a href="#cb196-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Export probability surface</span></span>
<span id="cb196-2"><a href="#cb196-2" aria-hidden="true" tabindex="-1"></a>prob_export <span class="ot">&lt;-</span> pred_normalized <span class="sc">%&gt;%</span></span>
<span id="cb196-3"><a href="#cb196-3" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(hex_id, mint_region, expected_prop, dist_km, weighted_prob)</span>
<span id="cb196-4"><a href="#cb196-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb196-5"><a href="#cb196-5" aria-hidden="true" tabindex="-1"></a><span class="fu">write_csv</span>(prob_export, <span class="st">"probability_surface.csv"</span>)</span>
<span id="cb196-6"><a href="#cb196-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb196-7"><a href="#cb196-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Export hex grid with predictions</span></span>
<span id="cb196-8"><a href="#cb196-8" aria-hidden="true" tabindex="-1"></a>hex_export <span class="ot">&lt;-</span> hex_probs <span class="sc">%&gt;%</span></span>
<span id="cb196-9"><a href="#cb196-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span></span>
<span id="cb196-10"><a href="#cb196-10" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(hex_id, cent_lon, cent_lat, dominant_mint, entropy, <span class="at">rome_prop =</span> expected_prop_ROME)</span>
<span id="cb196-11"><a href="#cb196-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb196-12"><a href="#cb196-12" aria-hidden="true" tabindex="-1"></a><span class="fu">write_csv</span>(hex_export, <span class="st">"hex_predictions.csv"</span>)</span>
<span id="cb196-13"><a href="#cb196-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb196-14"><a href="#cb196-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Export model coefficients</span></span>
<span id="cb196-15"><a href="#cb196-15" aria-hidden="true" tabindex="-1"></a><span class="fu">write_csv</span>(hier_coefs, <span class="st">"mint_diffusion_coefficients.csv"</span>)</span>
<span id="cb196-16"><a href="#cb196-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb196-17"><a href="#cb196-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Export as GeoPackage</span></span>
<span id="cb196-18"><a href="#cb196-18" aria-hidden="true" tabindex="-1"></a><span class="fu">st_write</span>(hex_probs, <span class="st">"circulation_probability_surface.gpkg"</span>, </span>
<span id="cb196-19"><a href="#cb196-19" aria-hidden="true" tabindex="-1"></a>         <span class="at">layer =</span> <span class="st">"hex_predictions"</span>, <span class="at">delete_layer =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Deleting layer `hex_predictions' using driver `GPKG'
Writing layer `hex_predictions' to data source 
  `circulation_probability_surface.gpkg' using driver `GPKG'
Writing 1461 features with 17 fields and geometry type Polygon.</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb198"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb198-1"><a href="#cb198-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"✓ Exported:</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>✓ Exported:</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb200"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb200-1"><a href="#cb200-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"  - probability_surface.csv</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>  - probability_surface.csv</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb202"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb202-1"><a href="#cb202-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"  - hex_predictions.csv</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>  - hex_predictions.csv</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb204"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb204-1"><a href="#cb204-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"  - mint_diffusion_coefficients.csv</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>  - mint_diffusion_coefficients.csv</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb206"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb206-1"><a href="#cb206-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"  - circulation_probability_surface.gpkg</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>  - circulation_probability_surface.gpkg</code></pre>
</div>
</div>
<hr>
</section>
<section id="session-info" class="level1" data-number="11">
<h1 data-number="11"><span class="header-section-number">11</span> Session Info</h1>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb208"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb208-1"><a href="#cb208-1" aria-hidden="true" tabindex="-1"></a><span class="fu">sessionInfo</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>R version 4.5.1 (2025-06-13)
Platform: aarch64-apple-darwin20
Running under: macOS Sequoia 15.7.1

Matrix products: default
BLAS:   /Library/Frameworks/R.framework/Versions/4.5-arm64/Resources/lib/libRblas.0.dylib 
LAPACK: /Library/Frameworks/R.framework/Versions/4.5-arm64/Resources/lib/libRlapack.dylib;  LAPACK version 3.12.1

locale:
[1] en_US.UTF-8/en_US.UTF-8/en_US.UTF-8/C/en_US.UTF-8/en_US.UTF-8

time zone: America/Chicago
tzcode source: internal

attached base packages:
[1] stats     graphics  grDevices utils     datasets  methods   base     

other attached packages:
 [1] rnaturalearthdata_1.0.0 rnaturalearth_1.1.0     brms_2.23.0            
 [4] Rcpp_1.1.0              lme4_1.1-38             Matrix_1.7-4           
 [7] broom_1.0.11            patchwork_1.3.2         knitr_1.50             
[10] jsonlite_2.0.0          httr_1.4.7              sf_1.0-23              
[13] lubridate_1.9.4         forcats_1.0.1           stringr_1.6.0          
[16] dplyr_1.1.4             purrr_1.2.0             readr_2.1.6            
[19] tidyr_1.3.1             tibble_3.3.0            ggplot2_4.0.1          
[22] tidyverse_2.0.0        

loaded via a namespace (and not attached):
 [1] tidyselect_1.2.1      viridisLite_0.4.2     farver_2.1.2         
 [4] loo_2.8.0             S7_0.2.1              fastmap_1.2.0        
 [7] TH.data_1.1-5         tensorA_0.36.2.1      digest_0.6.39        
[10] timechange_0.3.0      estimability_1.5.1    lifecycle_1.0.4      
[13] survival_3.8-3        magrittr_2.0.4        posterior_1.6.1      
[16] compiler_4.5.1        rlang_1.1.6           tools_4.5.1          
[19] utf8_1.2.6            yaml_2.3.12           labeling_0.4.3       
[22] bridgesampling_1.2-1  htmlwidgets_1.6.4     bit_4.6.0            
[25] classInt_0.4-11       RColorBrewer_1.1-3    multcomp_1.4-29      
[28] abind_1.4-8           KernSmooth_2.23-26    withr_3.0.2          
[31] grid_4.5.1            xtable_1.8-4          e1071_1.7-16         
[34] emmeans_2.0.1         scales_1.4.0          MASS_7.3-65          
[37] cli_3.6.5             mvtnorm_1.3-3         crayon_1.5.3         
[40] rmarkdown_2.30        reformulas_0.4.2      generics_0.1.4       
[43] RcppParallel_5.1.11-1 rstudioapi_0.17.1     tzdb_0.5.0           
[46] minqa_1.2.8           DBI_1.2.3             proxy_0.4-28         
[49] splines_4.5.1         bayesplot_1.15.0      parallel_4.5.1       
[52] s2_1.1.9              matrixStats_1.5.0     vctrs_0.6.5          
[55] sandwich_3.1-1        boot_1.3-32           hms_1.1.4            
[58] bit64_4.6.0-1         units_1.0-0           glue_1.8.0           
[61] nloptr_2.2.1          codetools_0.2-20      distributional_0.5.0 
[64] stringi_1.8.7         gtable_0.3.6          pillar_1.11.1        
[67] htmltools_0.5.9       Brobdingnag_1.2-9     R6_2.6.1             
[70] wk_0.9.4              Rdpack_2.6.4          vroom_1.6.7          
[73] evaluate_1.0.5        lattice_0.22-7        rbibutils_2.4        
[76] backports_1.5.0       rstantools_2.5.0      class_7.3-23         
[79] coda_0.19-4.1         nlme_3.1-168          checkmate_2.3.3      
[82] mgcv_1.9-4            xfun_0.55             zoo_1.8-15           
[85] pkgconfig_2.0.3      </code></pre>
</div>
</div>
<hr>
</section>
<section id="appendix-model-extensions" class="level1" data-number="12">
<h1 data-number="12"><span class="header-section-number">12</span> Appendix: Model Extensions</h1>
<section id="a.1-adding-circulation-decay" class="level2" data-number="12.1">
<h2 data-number="12.1" class="anchored" data-anchor-id="a.1-adding-circulation-decay"><span class="header-section-number">12.1</span> A.1 Adding Circulation Decay</h2>
<p>To model withdrawal from circulation, add a decay term:</p>
<p><span class="math display">\[w(t - \tau) = e^{-\lambda(t - \tau)}\]</span></p>
<p>Where <span class="math inline">\(\lambda\)</span> is the withdrawal rate. This can be estimated by adding an age term to the model:</p>
<div class="sourceCode" id="cb210"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb210-1"><a href="#cb210-1" aria-hidden="true" tabindex="-1"></a><span class="co"># With decay</span></span>
<span id="cb210-2"><a href="#cb210-2" aria-hidden="true" tabindex="-1"></a>decay_model <span class="ot">&lt;-</span> <span class="fu">lmer</span>(</span>
<span id="cb210-3"><a href="#cb210-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">qlogis</span>(prop_mint) <span class="sc">~</span> </span>
<span id="cb210-4"><a href="#cb210-4" aria-hidden="true" tabindex="-1"></a>    dist_scaled <span class="sc">+</span> cos_bearing <span class="sc">+</span> sin_bearing <span class="sc">+</span> </span>
<span id="cb210-5"><a href="#cb210-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">I</span>(<span class="sc">-</span>log_circ_age <span class="sc">*</span> lambda) <span class="sc">+</span>  <span class="co"># Decay term</span></span>
<span id="cb210-6"><a href="#cb210-6" aria-hidden="true" tabindex="-1"></a>    (<span class="dv">1</span> <span class="sc">+</span> dist_scaled <span class="sc">|</span> mint_region),</span>
<span id="cb210-7"><a href="#cb210-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> model_data</span>
<span id="cb210-8"><a href="#cb210-8" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="a.2-time-varying-probability-surfaces" class="level2" data-number="12.2">
<h2 data-number="12.2" class="anchored" data-anchor-id="a.2-time-varying-probability-surfaces"><span class="header-section-number">12.2</span> A.2 Time-Varying Probability Surfaces</h2>
<p>To generate surfaces for specific time periods, filter the production data:</p>
<div class="sourceCode" id="cb211"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb211-1"><a href="#cb211-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Surface for hoards deposited 50-25 BCE</span></span>
<span id="cb211-2"><a href="#cb211-2" aria-hidden="true" tabindex="-1"></a>surface_P08 <span class="ot">&lt;-</span> <span class="fu">generate_surface</span>(</span>
<span id="cb211-3"><a href="#cb211-3" aria-hidden="true" tabindex="-1"></a>  production_data <span class="sc">%&gt;%</span> <span class="fu">filter</span>(prod_period <span class="sc">&lt;=</span> <span class="st">"P08"</span>),</span>
<span id="cb211-4"><a href="#cb211-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">deposition_time =</span> <span class="sc">-</span><span class="dv">37</span>  <span class="co"># Midpoint of period</span></span>
<span id="cb211-5"><a href="#cb211-5" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="a.3-bayesian-implementation-with-brms" class="level2" data-number="12.3">
<h2 data-number="12.3" class="anchored" data-anchor-id="a.3-bayesian-implementation-with-brms"><span class="header-section-number">12.3</span> A.3 Bayesian Implementation with brms</h2>
<p>For full uncertainty quantification:</p>
<div class="sourceCode" id="cb212"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb212-1"><a href="#cb212-1" aria-hidden="true" tabindex="-1"></a><span class="fu">brm</span>(</span>
<span id="cb212-2"><a href="#cb212-2" aria-hidden="true" tabindex="-1"></a>  n_mint <span class="sc">|</span> <span class="fu">trials</span>(n_total) <span class="sc">~</span> </span>
<span id="cb212-3"><a href="#cb212-3" aria-hidden="true" tabindex="-1"></a>    dist_scaled <span class="sc">+</span> cos_bearing <span class="sc">+</span> sin_bearing <span class="sc">+</span></span>
<span id="cb212-4"><a href="#cb212-4" aria-hidden="true" tabindex="-1"></a>    (<span class="dv">1</span> <span class="sc">+</span> dist_scaled <span class="sc">|</span> mint_region),</span>
<span id="cb212-5"><a href="#cb212-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">family =</span> <span class="fu">binomial</span>(),</span>
<span id="cb212-6"><a href="#cb212-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> model_data,</span>
<span id="cb212-7"><a href="#cb212-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">prior =</span> <span class="fu">c</span>(</span>
<span id="cb212-8"><a href="#cb212-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">prior</span>(<span class="fu">normal</span>(<span class="dv">0</span>, <span class="dv">2</span>), <span class="at">class =</span> <span class="st">"b"</span>),</span>
<span id="cb212-9"><a href="#cb212-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">prior</span>(<span class="fu">exponential</span>(<span class="dv">1</span>), <span class="at">class =</span> <span class="st">"sd"</span>)</span>
<span id="cb212-10"><a href="#cb212-10" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb212-11"><a href="#cb212-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">chains =</span> <span class="dv">4</span>, <span class="at">cores =</span> <span class="dv">4</span>, <span class="at">iter =</span> <span class="dv">2000</span></span>
<span id="cb212-12"><a href="#cb212-12" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>This would provide posterior predictive intervals on all probability surfaces.</p>



</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>